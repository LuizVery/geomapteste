(this.webpackJsonpgeowebmap=this.webpackJsonpgeowebmap||[]).push([[41],{1170:function(e,t,r){"use strict";r.d(t,"a",(function(){return f}));var n=r(12),i=r(3),a=r(4),s=r(992),o=r(24),c=r(2),u="__esri_stream_id__",h="__esri_timestamp__",f=function(){function e(t,r,n,a){var s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:128;Object(i.a)(this,e),this._trackIdToObservations=new Map,this._idCounter=0,this._lastPurge=performance.now(),this._addOrUpdated=new Map,this._removed=[],this._maxAge=0,this._timeInfo=n,this._purgeOptions=a,this.store=t,this.objectIdField=r,this.purgeInterval=s,this._useGeneratedIds=this.objectIdField===u}return Object(a.a)(e,[{key:"add",value:function(e){if(this._useGeneratedIds){var t=this._nextId();e.attributes[this.objectIdField]=t,e.objectId=t}else e.objectId=e.attributes[this.objectIdField];if(this._addOrUpdated.set(e.objectId,e),this._maxAge=Math.max(this._maxAge,e.attributes[this._timeInfo.startTimeField]),!this._timeInfo.trackIdField)return Object(c.j)(this._trackIdLessObservations)&&(this._trackIdLessObservations=new s.a(1e5)),void this._trackIdLessObservations.enqueue(e.objectId);var r=e.attributes[this._timeInfo.trackIdField];if(!this._trackIdToObservations.has(r)){var n=Object(c.k)(this._purgeOptions)&&null!=this._purgeOptions.maxObservations?this._purgeOptions.maxObservations:1e3,i=Object(o.f)(n,0,1e3);this._trackIdToObservations.set(r,new s.a(i))}var a=this._trackIdToObservations.get(r).enqueue(e.objectId);Object(c.k)(a)&&(this._addOrUpdated.has(a)?this._addOrUpdated.delete(a):this._removed.push(a))}},{key:"checkForUpdates",value:function(){var e=this._getToAdd(),t=this._getToRemove(),r=performance.now();r-this._lastPurge>=this.purgeInterval&&(this._purge(r),this._lastPurge=r);var i=[];if(Object(c.k)(t)){var a,s=Object(n.a)(t);try{for(s.s();!(a=s.n()).done;){var o=a.value,u=this.store.removeById(o);Object(c.k)(u)&&i.push(u)}}catch(v){s.e(v)}finally{s.f()}}if(Object(c.k)(e)){var f,d=Object(n.a)(e);try{for(d.s();!(f=d.n()).done;){var l=f.value;l.attributes[h]=r,this.store.add(l)}}catch(v){d.e(v)}finally{d.f()}}(e||i)&&this.store.update(e,i)}},{key:"_getToAdd",value:function(){if(!this._addOrUpdated.size)return null;var e=new Array(this._addOrUpdated.size),t=0;return this._addOrUpdated.forEach((function(r){return e[t++]=r})),this._addOrUpdated.clear(),e}},{key:"_getToRemove",value:function(){var e=this._removed;return this._removed.length?(this._removed=[],e):null}},{key:"_nextId",value:function(){var e=this._idCounter;return this._idCounter=(this._idCounter+1)%4294967294+1,e}},{key:"_purge",value:function(e){var t=this._purgeOptions;Object(c.k)(t)&&(this._purgeSomeByDisplayCount(t),this._purgeByAge(t),this._purgeByAgeReceived(e,t),this._purgeTracks())}},{key:"_purgeSomeByDisplayCount",value:function(e){if(e.displayCount){var t=this.store.size;if(t>e.displayCount){if(this._timeInfo.trackIdField){var r,i=Object(n.a)(this._trackIdToObservations.values());try{for(i.s();!(r=i.n()).done;){var a=r.value;if(t>e.displayCount&&a.size){var s=Object(c.t)(a.dequeue());this._removed.push(s),t--}}}catch(h){i.e(h)}finally{i.f()}}if(Object(c.k)(this._trackIdLessObservations))for(var o=t-e.displayCount;o-- >0;){var u=this._trackIdLessObservations.dequeue();Object(c.k)(u)&&this._removed.push(u)}}}}},{key:"_purgeByAge",value:function(e){var t,r=this;if(e.age&&null!=(t=this._timeInfo)&&t.startTimeField){var n=60*e.age*1e3,i=this._maxAge-n;this.store.forEach((function(e){e.attributes[r._timeInfo.startTimeField]<i&&r._removed.push(e.objectId)}))}}},{key:"_purgeByAgeReceived",value:function(e,t){var r=this;if(t.ageReceived){var n=e-60*t.ageReceived*1e3;this.store.forEach((function(e){e.attributes[h]<n&&r._removed.push(e.objectId)}))}}},{key:"_purgeTracks",value:function(){var e=this;this._trackIdToObservations.forEach((function(t,r){0===t.size&&e._trackIdToObservations.delete(r)}))}}]),e}()},1210:function(e,t,r){"use strict";r.d(t,"a",(function(){return U}));var n,i,a=r(12),s=r(8),o=r.n(s),c=r(15),u=r(14),h=r(3),f=r(4),d=r(6),l=r(7),v=r(0),b=(r(112),r(69)),p=r(20),_=r(16),y=r(2),k=r(23),O=r(1),g=(r(17),r(18),r(9)),m=r(80),j=r(185),w=function(e){Object(d.a)(r,e);var t=Object(l.a)(r);function r(){return Object(h.a)(this,r),t.apply(this,arguments)}return Object(f.a)(r,[{key:"onFeature",value:function(e){this.emit("feature",e)}}]),r}(m.a.EventedMixin(j.a)),x=w=Object(v.a)([Object(g.a)("esri.layers.graphics.sources.connections.StreamConnection")],w),S=r(453),F=_.a.getLogger("esri.layers.graphics.sources.connections.WebSocketConnection");(i=n||(n={}))[i.CONNECTING=0]="CONNECTING",i[i.OPEN=1]="OPEN",i[i.CLOSING=2]="CLOSING",i[i.CLOSED=3]="CLOSED";var I=function(e){Object(d.a)(r,e);var t=Object(l.a)(r);function r(e){var n;Object(h.a)(this,r),(n=t.call(this)).errorString=null;var i=e.geometryType,a=e.spatialReference,s=e.sourceSpatialReference;return n._config=e,n._featureZScaler=Object(S.a)(i,s,a),n._open(),n}return Object(f.a)(r,[{key:"_open",value:function(){var e=Object(c.a)(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._tryCreateWebSocket();case 2:if(e.t0=this.destroyed,e.t0){e.next=6;break}return e.next=6,this._handshake();case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"destroy",value:function(){Object(y.k)(this._websocket)&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null}},{key:"connectionStatus",get:function(){if(Object(y.j)(this._websocket))return"disconnected";switch(this._websocket.readyState){case n.CONNECTING:case n.OPEN:return"connected";case n.CLOSING:case n.CLOSED:return"disconnected"}}},{key:"_tryCreateWebSocket",value:function(){var e=Object(c.a)(o.a.mark((function e(){var t,r,n,i,a=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=a.length>0&&void 0!==a[0]?a[0]:this._config.source.path,r=a.length>1&&void 0!==a[1]?a[1]:1e3,n=a.length>2&&void 0!==a[2]?a[2]:0,e.prev=3,!this.destroyed){e.next=6;break}return e.abrupt("return");case 6:return e.next=8,this._createWebSocket(t);case 8:this._websocket=e.sent,this.notifyChange("connectionStatus"),e.next=24;break;case 12:if(e.prev=12,e.t0=e.catch(3),i=r/1e3,!(this._config.maxReconnectionAttempts&&n>=this._config.maxReconnectionAttempts)){e.next=19;break}e.t1=(F.error(new p.a("websocket-connection","Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),void this.destroy()),e.next=23;break;case 19:return F.error(new p.a("websocket-connection","Failed to connect. Attempting to reconnect in ".concat(i,"s"),e.t0)),e.next=22,Object(k.a)(r);case 22:e.t1=this._tryCreateWebSocket(t,Math.min(1.5*r,1e3*this._config.maxReconnectionInterval),n+1);case 23:return e.abrupt("return",e.t1);case 24:case"end":return e.stop()}}),e,this,[[3,12]])})));return function(){return e.apply(this,arguments)}}()},{key:"_createWebSocket",value:function(e){var t=this,r=new WebSocket(e),n=new Promise((function(e,t){r.onopen=function(){return e(r)},r.onclose=function(e){return t(e)}}));return n.then((function(){if(t.destroyed)return r.onclose=function(){},void r.close();r.onclose=function(e){return t._onClose(e)},r.onerror=function(e){return t._onError(e)},r.onmessage=function(e){return t._onMessage(e)}})),n}},{key:"_handshake",value:function(){var e=Object(c.a)(o.a.mark((function e(){var t,r,n,i,a,s,c,u,h=this,f=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=f.length>0&&void 0!==f[0]?f[0]:1e4,r=this._websocket,!Object(y.j)(r)){e.next=4;break}return e.abrupt("return");case 4:return n=Object(k.h)(),i=r.onmessage,a=this._config,s=a.filter,c=a.outFields,u=a.spatialReference,e.abrupt("return",(n.timeout(t),r.onmessage=function(e){var t,a=null;try{a=JSON.parse(e.data)}catch(o){}a&&"object"==typeof a||(F.error(new p.a("websocket-connection","Protocol violation. Handshake failed - malformed message",e.data)),n.reject(),h.destroy()),(null==(t=a.spatialReference)?void 0:t.wkid)!==(null==u?void 0:u.wkid)&&(F.error(new p.a("websocket-connection","Protocol violation. Handshake failed - expected wkid of ".concat(u.wkid),e.data)),n.reject(),h.destroy()),"json"!==a.format&&(F.error(new p.a("websocket-connection","Protocol violation. Handshake failed - format is not set",e.data)),n.reject(),h.destroy()),s&&a.filter!==s&&F.error(new p.a("websocket-connection","Tried to set filter, but server doesn't support it")),c&&a.outFields!==c&&F.error(new p.a("websocket-connection","Tried to set outFields, but server doesn't support it")),r.onmessage=i,n.resolve()},r.send(JSON.stringify({filter:s,outFields:c,format:"json",spatialReference:{wkid:u.wkid}})),n.promise));case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_onMessage",value:function(e){try{var t=JSON.parse(e.data);if("featureResult"!==t.type)throw new p.a("websocket-connection","Protocol violation - Expected to find message of type 'featureResult'",t);var r,n=Object(a.a)(t.features);try{for(n.s();!(r=n.n()).done;){var i=r.value;this._featureZScaler&&this._featureZScaler(i.geometry),this.onFeature(i)}}catch(s){n.e(s)}finally{n.f()}}catch(o){return F.error(new p.a("websocket-connection","Failed to parse message",o)),void this.destroy()}}},{key:"_onError",value:function(e){var t="Encountered an error over WebSocket connection";this._set("errorString",t),F.error("websocket-connection",t)}},{key:"_onClose",value:function(e){this._websocket=null,this.notifyChange("connectionStatus"),1e3!==e.code&&F.error("websocket-connection","WebSocket closed unexpectedly with error code ".concat(e.code)),this.destroyed||this._open()}}]),r}(x);Object(v.a)([Object(O.b)()],I.prototype,"connectionStatus",null),Object(v.a)([Object(O.b)()],I.prototype,"errorString",void 0),I=Object(v.a)([Object(g.a)("esri.layers.graphics.sources.connections.WebSocketConnection")],I);var C=r(329),R=r(163),T=r(77),E=r(52),q=_.a.getLogger("esri.layers.graphics.sources.connections.GeoEventConnection"),N={maxQueryDepth:5,maxRecordCountFactor:3},A=function(e){Object(d.a)(n,e);var t=Object(l.a)(n);function n(e){return Object(h.a)(this,n),t.call(this,Object(u.a)(Object(u.a)({},N),e))}return Object(f.a)(n,[{key:"_open",value:function(){var e=Object(c.a)(o.a.mark((function e(){var t,r,n,i,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._fetchServiceDefinition(this._config.source);case 2:return(t=e.sent).timeInfo.trackIdField||q.warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect."),e.next=6,this._fetchWebSocketUrl(t.streamUrls,this._config.spatialReference);case 6:return r=e.sent,this._buddyServicesQuery||(this._buddyServicesQuery=this._queryBuddyServices()),e.next=10,this._buddyServicesQuery;case 10:return e.next=12,this._tryCreateWebSocket(r);case 12:n=this._config,i=n.filter,a=n.outFields,this.destroyed||this._setFilter(i,a);case 14:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"_onMessage",value:function(e){var t;try{t=this._enrich(JSON.parse(e.data)),this._featureZScaler&&this._featureZScaler(t.geometry)}catch(r){return void q.error(new p.a("geoevent-connection","Failed to parse message",r))}this.onFeature(t)}},{key:"_fetchServiceDefinition",value:function(){var e=Object(c.a)(o.a.mark((function e(t){var r,n,i;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r={f:"json"},n=Object(b.default)(t.path,{query:r,responseType:"json"}),e.next=4,n;case 4:return i=e.sent.data,e.abrupt("return",(this._serviceDefinition=i,i));case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_fetchWebSocketUrl",value:function(){var e=Object(c.a)(o.a.mark((function e(t,r){var n,i,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t[0],i=n.urls,a=n.token,e.abrupt("return","".concat(this._inferWebSocketBaseUrl(i),"/subscribe?outSR=").concat(r.wkid).concat(a?"&token="+a:""));case 2:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_inferWebSocketBaseUrl",value:function(e){if(1===e.length)return e[0];var t,r=Object(a.a)(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;if(-1!==n.indexOf("wss"))return n}}catch(i){r.e(i)}finally{r.f()}return q.error(new p.a("geoevent-connection","Unable to infer WebSocket url",e)),null}},{key:"_setFilter",value:function(){var e=Object(c.a)(o.a.mark((function e(t,r){var n,i,a,s,c,u,h=this;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this._websocket,!(Object(y.j)(n)||Object(y.j)(t)&&Object(y.j)(r))){e.next=3;break}return e.abrupt("return");case 3:return i=JSON.stringify({filter:this._serializeFilter(t,r)}),a=!1,s=Object(k.h)(),c=function(){a||(h.destroyed||h._websocket!==n||q.error(new p.a("geoevent-connection","Server timed out when setting filter")),s.reject())},u=function(e){var t=JSON.parse(e.data);t.filter&&(t.error&&(q.error(new p.a("geoevent-connection","Failed to set service filter",t.error)),h._set("errorString","Could not set service filter - ".concat(t.error)),s.reject(t.error)),n.onmessage=h._onMessage.bind(h),a=!0,s.resolve())},e.abrupt("return",(n.onmessage=u,n.send(i),setTimeout(c,1e4),s.promise));case 7:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_serializeFilter",value:function(e,t){var r={};if(Object(y.j)(e)&&Object(y.j)(t))return r;if(Object(y.k)(e)&&e.geometry)try{var n=Object(T.a)(e.geometry);if("extent"!==n.type)throw new p.a("Expected extent but found type ".concat(n.type));r.geometry=JSON.stringify(n.shiftCentralMeridian())}catch(i){q.error(new p.a("geoevent-connection","Encountered an error when setting connection geometryDefinition",i))}return Object(y.k)(e)&&e.where&&"1 = 1"!==e.where&&(r.where=e.where),Object(y.k)(t)&&(r.outFields=t.join(",")),r}},{key:"_enrich",value:function(e){if(!this._relatedFeatures)return e;var t=this._serviceDefinition.relatedFeatures.joinField,r=e.attributes[t];if(!this._relatedFeatures.has(r))return q.warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",e),e;var n=this._relatedFeatures.get(r),i=n.attributes,a=n.geometry;for(var s in i)e.attributes[s]=i[s];return a&&(e.geometry=a),e.geometry||e.centroid||q.error(new p.a("geoevent-connection","Found malformed feature - no geometry found",e)),e}},{key:"_queryBuddyServices",value:function(){var e=Object(c.a)(o.a.mark((function e(){var t,r,n,i,s,c,u,h,f;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=this._serviceDefinition,r=t.relatedFeatures,n=t.keepLatestArchive,i=this._queryRelatedFeatures(r),s=this._queryArchive(n),e.next=4,i;case 4:return e.next=6,s;case 6:if(c=e.sent){e.next=9;break}return e.abrupt("return");case 9:u=Object(a.a)(c.features);try{for(u.s();!(h=u.n()).done;)f=h.value,this.onFeature(this._enrich(f))}catch(o){u.e(o)}finally{u.f()}e.next=16;break;case 13:e.prev=13,e.t0=e.catch(0),q.error(new p.a("geoevent-connection","Encountered an error when querying buddy services",{error:e.t0}));case 16:case"end":return e.stop()}}),e,this,[[0,13]])})));return function(){return e.apply(this,arguments)}}()},{key:"_queryRelatedFeatures",value:function(){var e=Object(c.a)(o.a.mark((function e(t){var r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this._queryBuddy(t.featuresUrl);case 4:r=e.sent,this._addRelatedFeatures(r);case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_queryArchive",value:function(){var e=Object(c.a)(o.a.mark((function e(t){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=2;break}return e.abrupt("return",this._queryBuddy(t.featuresUrl));case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_queryBuddy",value:function(){var e=Object(c.a)(o.a.mark((function e(t){var n,i,a,s,c,u,h,f,d,l,v;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.resolve().then(r.bind(null,360));case 2:return e.t0=e.sent.default,e.t1={url:t},n=new e.t0(e.t1),e.next=7,n.load();case 7:if(i=e.sent,a=i.capabilities,s=a.query.supportsMaxRecordCountFactor,c=a.query.supportsPagination,u=a.query.supportsCentroid,h=this._config.maxRecordCountFactor,f=n.capabilities.query.maxRecordCount,d=s?f*h:f,(l=new R.a).outFields=Object(y.u)(this._config.outFields,["*"]),l.where=Object(y.u)(Object(y.i)(this._config.filter,"where"),"1=1"),l.returnGeometry=!0,l.returnExceededLimitFeatures=!0,l.outSpatialReference=E.a.fromJSON(this._config.spatialReference),u&&(l.returnCentroid=!0),s&&(l.maxRecordCountFactor=h),!c){e.next=18;break}return e.abrupt("return",(l.num=d,n.destroy(),this._queryPages(t,l)));case 18:return e.next=20,Object(C.executeQuery)(t,l,this._config.sourceSpatialReference);case 20:return v=e.sent,e.abrupt("return",(n.destroy(),v.data));case 22:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_queryPages",value:function(){var e=Object(c.a)(o.a.mark((function e(t,r){var n,i,a,s,c=arguments;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=c.length>2&&void 0!==c[2]?c[2]:[],i=c.length>3&&void 0!==c[3]?c[3]:0,r.start=Object(y.k)(r.num)?i*r.num:null,e.next=5,Object(C.executeQuery)(t,r,this._config.sourceSpatialReference);case 5:return a=e.sent,s=a.data,e.abrupt("return",s.exceededTransferLimit&&i<this._config.maxQueryDepth?(s.features.forEach((function(e){return n.push(e)})),this._queryPages(t,r,n,i+1)):(n.forEach((function(e){return s.features.push(e)})),s));case 8:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"_addRelatedFeatures",value:function(e){var t,r=new Map,n=e.features,i=this._serviceDefinition.relatedFeatures.joinField,s=Object(a.a)(n);try{for(s.s();!(t=s.n()).done;){var o=t.value,c=o.attributes[i];r.set(c,o)}}catch(u){s.e(u)}finally{s.f()}this._relatedFeatures=r}}]),n}(I),z=A=Object(v.a)([Object(g.a)("esri.layers.graphics.sources.connections.GeoEventConnection")],A);function U(e,t,r,n,i,a,s){var o=0===e.path.indexOf("wss://")||0===e.path.indexOf("ws://"),c={source:e,sourceSpatialReference:t,spatialReference:r,geometryType:n,filter:i,maxReconnectionAttempts:a,maxReconnectionInterval:s};return o?new I(c):new z(c)}},992:function(e,t,r){"use strict";r.d(t,"a",(function(){return o}));var n=r(12),i=r(3),a=r(4),s=r(2),o=function(){function e(t){Object(i.a)(this,e),this.size=0,this._start=0,this.maxSize=t,this._buffer=new Array(t)}return Object(a.a)(e,[{key:"entries",get:function(){return this._buffer}},{key:"enqueue",value:function(e){if(this.size===this.maxSize){var t=this._buffer[this._start];return this._buffer[this._start]=e,this._start=(this._start+1)%this.maxSize,t}return this._buffer[(this._start+this.size++)%this.maxSize]=e,null}},{key:"dequeue",value:function(){if(0===this.size)return null;var e=this._buffer[this._start];return this._buffer[this._start]=null,this.size--,this._start=(this._start+1)%this.maxSize,e}},{key:"peek",value:function(){return 0===this.size?null:this._buffer[this._start]}},{key:"find",value:function(e){if(0===this.size)return null;var t,r=Object(n.a)(this._buffer);try{for(r.s();!(t=r.n()).done;){var i=t.value;if(Object(s.k)(i)&&e(i))return i}}catch(a){r.e(a)}finally{r.f()}return null}},{key:"clear",value:function(e){for(var t=this.dequeue();Object(s.k)(t);)e&&e(t),t=this.dequeue()}}]),e}()}}]);
//# sourceMappingURL=41.fd92c046.chunk.js.map