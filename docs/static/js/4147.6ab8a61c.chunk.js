"use strict";(globalThis.webpackChunkgeowebmap=globalThis.webpackChunkgeowebmap||[]).push([[4147],{71039:(e,t,r)=>{r.d(t,{z:()=>w});var n=r(27366),i=(r(59486),r(85015)),s=r(63780),o=r(32718),a=r(16889),l=r(92026),u=r(68860),c=r(8537),d=r(49861),p=(r(93169),r(25243),r(69912)),h=r(11186),f=r(48562),y=r(79803),g=r(41414),E=r(65156),b=r(22186),x=r(81753),m=r(18661),S=r(44011),_=r(78952);const C=o.Z.getLogger("esri.views.3d.layers.i3s.I3SMeshViewFilter");let I,w=class extends i.Z{constructor(e){super(e),this._projectionEngineLoaded=!1}initialize(){(0,c.N1)(this,"filter.geometry").then((()=>this.loadAsyncModule(async function(){return!!I||(I=await Promise.all([r.e(9058),r.e(2170)]).then(r.bind(r,2170))),I}().then((e=>{this.destroyed||(this._geometryEngine=e,this.applyFilters())})))))}get sortedObjectIds(){if((0,l.Wi)(this.filter.objectIds))return null;const e=new Float64Array(this.filter.objectIds);return e.sort(),e}get parsedWhereClause(){const e=(0,l.pC)(this.filter)?this.filter.where:null;if((0,l.Wi)(e)||!e)return null;try{return f.WhereClause.create(e,this.layerFieldsIndex)}catch(t){C.error(`Failed to parse filter where clause: ${t}`)}return null}addFilters(e,t,r,n){const i=this.sortedObjectIds;(0,l.pC)(i)&&e.push((e=>(0,S.Yb)(i,!0,e))),this.addSqlFilter(e,this.parsedWhereClause);const s=this.parsedGeometry;if((0,l.pC)(s)){const i=this.spatialRelationship;e.push(((e,o)=>function(e,t,r,n,i,s,o){const a=s[0].spatialReference||n.spatialReference;if(!(0,y.st)(t.node.mbs,i,D,a))return void C.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter");const l=j(D,a),u=function(e,t,r,n,i){const s=t.renderSpatialReference,o=new Map,a={rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],hasZ:!1,hasM:!1,type:"polygon",spatialReference:r};a.rings[0][3]=a.rings[0][0];const l={indices:null,data:null,stride:0,startIndex:0,endIndex:0};let u,c;switch(e){case"intersects":u=(e,t)=>I.intersects(e,t)?R.KEEP:R.TEST,c=T;break;case"contains":u=(e,t)=>I.contains(e,t)?R.TEST:R.DISCARD,c=T;break;default:u=(e,t)=>I.disjoint(e,t)?R.TEST:R.DISCARD,c=N}return{collection:n,object:i,type:e,maskSR:r,renderSR:s,aabbCache:o,triangle:a,positions:l,triangleTest:u,geometryTest:c}}(o,n,a,r,t.objectHandle);for(const c of s){if(0===e.length)return;switch(Q(c,l,o)){case R.DISCARD:return void(e.length=0);case R.KEEP:continue}(0,S.hv)(e,t.featureIds,(e=>Z(c,e,u)))}}(e,o,n,t,r,s,i)))}}isMBSGeoemtryVisible(e,t,r){const n=this.parsedGeometry;if((0,l.pC)(n)){const i=this.spatialRelationship,s=n[0].spatialReference||t;return(0,y.st)(e,r,D,s)?function(e,t,r,n){const i=j(e,r);return t.every((e=>Q(e,i,n)!==R.DISCARD))}(D,n,s,i):(C.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0)}return!0}get parsedGeometry(){if((0,l.Wi)(this.filter))return null;if(!this._geometryEngine)return null;const{geometry:e}=this.filter;if((0,l.Wi)(e))return null;const{distance:t,units:r}=this.filter,n=this.spatialRelationship,i="mesh"===e.type?e.extent:e;if((0,l.Wi)(t)||0===t)return v(i,n);const s=r||(0,u.qE)(i.spatialReference);if(i.spatialReference.isWGS84)return v(this._geometryEngine.geodesicBuffer(i,t,s),n);const o=(0,x.iV)(i,_.Z.WGS84);if((0,l.pC)(o))return v((0,x.iV)(this._geometryEngine.geodesicBuffer(o,t,s),i.spatialReference),n);if(!this._projectionEngineLoaded&&(this.loadAsyncModule((0,y.zD)().then((()=>this._projectionEngineLoaded=!0))),!this._projectionEngineLoaded))return null;let a=null;try{a=(0,y.iV)(i,_.Z.WGS84)}catch(c){}if(a)try{a=(0,y.iV)(this._geometryEngine.geodesicBuffer(a,t,s),i.spatialReference)}catch(c){a=null}return a||C.error(`Filter by geodesic buffer (distance) unsupported, failed to project input geometry (${i.spatialReference.wkid}) to WGS84.`),v(a,n)}get spatialRelationship(){return(0,l.pC)(this.filter)?this.filter.spatialRelationship:"intersects"}static checkSupport(e){return e.timeExtent?(C.warn("Filters with a timeExtent are not supported for mesh scene layers"),!1):!!function(e){return null!=e&&O.indexOf(e)>=0}(e.spatialRelationship)||(C.warn(`Filters with spatialRelationship other than ${O.join(", ")} are not supported for mesh scene layers`),!1)}};(0,n._)([(0,d.Cb)({type:m.Z})],w.prototype,"filter",void 0),(0,n._)([(0,d.Cb)()],w.prototype,"layerFieldsIndex",void 0),(0,n._)([(0,d.Cb)()],w.prototype,"loadAsyncModule",void 0),(0,n._)([(0,d.Cb)()],w.prototype,"applyFilters",void 0),(0,n._)([(0,d.Cb)()],w.prototype,"addSqlFilter",void 0),(0,n._)([(0,d.Cb)({readOnly:!0})],w.prototype,"sortedObjectIds",null),(0,n._)([(0,d.Cb)({readOnly:!0})],w.prototype,"parsedWhereClause",null),(0,n._)([(0,d.Cb)({readOnly:!0})],w.prototype,"parsedGeometry",null),(0,n._)([(0,d.Cb)({readOnly:!0})],w.prototype,"spatialRelationship",null),(0,n._)([(0,d.Cb)()],w.prototype,"_projectionEngineLoaded",void 0),(0,n._)([(0,d.Cb)()],w.prototype,"_geometryEngine",void 0),w=(0,n._)([(0,p.j)("esri.views.3d.layers.i3s.I3SMeshViewFilter")],w);const O=["contains","intersects","disjoint"];var R,F;function v(e,t){if((0,l.Wi)(e))return null;if("disjoint"===t&&"polygon"===e.type){const t=new Array(e.rings.length);for(let i=0;i<e.rings.length;++i){const r=(0,E.al)(1/0,1/0,-1/0,-1/0);(0,E.Wi)(r,e.rings[i]),t[i]={type:"polygon",rings:[e.rings[i]],spatialReference:e.spatialReference,aabr:r}}t.sort(((e,t)=>e.aabr[0]-t.aabr[0]));const r=new Set,n=new s.SO;for(let e=0;e<t.length;++e){const i=t[e];for(let n=e+1;n<t.length;++n){const e=t[n];if(e.aabr[0]>=i.aabr[2])break;r.add(e)}r.forEach((e=>{if(i!==e)if(e.aabr[2]<=i.aabr[0])r.delete(e);else if(I.intersects(i,e)){i.rings=i.rings.concat(e.rings),(0,E.jn)(i.aabr,e.aabr,i.aabr),delete i._geVersion,r.delete(e);const o=(0,s.cq)(t,e,t.length,n);t.splice(o,1)}})),r.add(i)}for(const e of t)delete e.aabr;return t}return[e]}(F=R||(R={}))[F.KEEP=0]="KEEP",F[F.DISCARD=1]="DISCARD",F[F.TEST=2]="TEST";const D=[0,0,0,0];function j(e,t){const r={x:e[0],y:e[1],hasZ:!1,hasM:!1,type:"point",spatialReference:t},n=!t.isWGS84&&!t.isWebMercator,i=Number.isNaN(e[3])?0:(0,a.uZ)(e[3],0,2*b.sv.radius),s=n?I.buffer(r,i,1):I.geodesicBuffer(r,i,1);return s.type="polygon",s}function Q(e,t,r){switch(r){case"intersects":case"contains":return T(e,t);case"disjoint":return N(e,t)}}function T(e,t){return I.intersects(e,t)?I.contains(e,t)?R.KEEP:R.TEST:R.DISCARD}function N(e,t){return I.intersects(e,t)?I.contains(e,t)?R.DISCARD:R.TEST:R.KEEP}function Z(e,t,r){const{collection:n,object:i,renderSR:s,maskSR:o,geometryTest:a,aabbCache:l}=r;let u=l.get(t);if(!u){const e=n.getObjectTransform(i);n.getComponentAabb(i,t,A);const r=[[A[0],A[1],0],[A[0],A[4],0],[A[3],A[4],0],[A[3],A[1],0]];for(let t=0;t<4;++t)(0,h.t)(r[t],r[t],e.rotationScale),(0,h.b)(r[t],r[t],e.position),(0,y.SH)(r[t],s,r[t],o);u={rings:[r],hasZ:!1,hasM:!1,type:"polygon",spatialReference:o},u.rings[0][4]=u.rings[0][0],l.set(t,u)}switch(a(e,u)){case R.DISCARD:return!1;case R.KEEP:return!0}const{triangle:c,triangleTest:d,positions:p}=r,f=c.rings[0][0],g=c.rings[0][1],E=c.rings[0][2],b=n.getObjectTransform(i);n.getComponentPositions(i,t,p);const{indices:x,data:m,stride:S,startIndex:_,endIndex:C}=p;for(let I=_;I<C;I+=3){const t=S*x[I+0],r=S*x[I+1],n=S*x[I+2];(0,h.s)(f,m[t+0],m[t+1],m[t+2]),(0,h.s)(g,m[r+0],m[r+1],m[r+2]),(0,h.s)(E,m[n+0],m[n+1],m[n+2]),(0,h.t)(f,f,b.rotationScale),(0,h.t)(g,g,b.rotationScale),(0,h.t)(E,E,b.rotationScale),(0,h.b)(f,f,b.position),(0,h.b)(g,g,b.position),(0,h.b)(E,E,b.position),(0,y.SH)(f,s,f,o),(0,y.SH)(g,s,g,o),(0,y.SH)(E,s,E,o);const i=g[0]-f[0],a=g[1]-f[1],l=E[0]-f[0],u=E[1]-f[1];if(!(Math.abs(i*u-a*l)<2.3283064365386963e-10))switch(delete c._geVersion,d(e,c)){case R.DISCARD:return!1;case R.KEEP:return!0}}return"intersects"!==r.type}const A=(0,g.Ue)()},43812:(e,t,r)=>{r.d(t,{Z:()=>g});var n=r(27366),i=r(85015),s=r(10064),o=r(100),a=r(92026),l=r(49861),u=(r(63780),r(93169),r(25243),r(69912)),c=r(53866),d=r(83706),p=r(49818),h=r(21149);const f=d.Z;let y=class extends i.Z{constructor(e){super(e),this._dataQueryEngineInstance=null,this._handles=new o.Z}get defaultQueryJSON(){return new h.Z({outSpatialReference:this.spatialReference}).toJSON()}get dataQueryEngine(){return this._ensureDataQueryEngine()}initialize(){this._handles.add(this.layerView.on("visible-geometry-changed",(()=>this.spatialIndex.events.emit("changed"))))}destroy(){this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null),this._handles&&(this._handles.destroy(),this._handles=null),this._set("layerView",null)}async executeQueryForCount(e,t){return this.dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),t)}async executeQueryForExtent(e,t){const{count:r,extent:n}=await this.dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),t);return{count:r,extent:c.Z.fromJSON(n)}}async executeQueryForIds(e,t){return this.dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),t)}async executeQuery(e,t){const r=this._ensureQueryJSON(e);if(r.returnGeometry)throw new s.Z("feature-store:unsupported-query","returnGeometry is not yet supported for mesh scene layer queries");if(r.returnCentroid)throw new s.Z("feature-store:unsupported-query","returnCentroid is not yet supported for mesh scene layer queries");const n=await this.dataQueryEngine.executeQuery(r,t),i=p.default.fromJSON(n);return i.features.forEach((e=>{e.geometry=null})),i}_ensureQueryJSON(e){if((0,a.Wi)(e))return this.defaultQueryJSON;const t=e.toJSON();return t.outSpatialReference||(e.outSpatialReference=this.spatialReference),t}_ensureDataQueryEngine(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const e=this.layer.objectIdField||"OBJECTID",t=this.layer.fields.map((e=>e.toJSON())),r=this.layerView.view.resourceController.scheduler,n=this.spatialReference.toJSON(),i=this.priority,s=this.spatialIndex;return this._dataQueryEngineInstance=new f({hasZ:!0,hasM:!1,geometryType:"esriGeometryPolygon",fields:t,timeInfo:null,spatialReference:n,objectIdField:e,featureStore:s,scheduler:r,priority:i}),this._dataQueryEngineInstance}};(0,n._)([(0,l.Cb)({constructOnly:!0})],y.prototype,"layerView",void 0),(0,n._)([(0,l.Cb)({constructOnly:!0})],y.prototype,"priority",void 0),(0,n._)([(0,l.Cb)({constructOnly:!0})],y.prototype,"spatialIndex",void 0),(0,n._)([(0,l.Cb)({readOnly:!0,aliasOf:"layerView.view.spatialReference"})],y.prototype,"spatialReference",void 0),(0,n._)([(0,l.Cb)({readOnly:!0,aliasOf:"layerView.i3slayer"})],y.prototype,"layer",void 0),(0,n._)([(0,l.Cb)({readOnly:!0})],y.prototype,"defaultQueryJSON",null),y=(0,n._)([(0,u.j)("esri.views.3d.layers.i3s.I3SQueryEngine")],y);const g=y},51246:(e,t,r)=>{r.d(t,{u:()=>l});var n=r(92026),i=r(41414),s=r(85403),o=r(80457),a=r(44011);class l{constructor(e){this.objectIdField=e.objectIdField,this.getFeatureExtent=e.getFeatureExtent}getObjectId(e){return e.id}getAttributes(e){const{meta:t,index:r}=e,i={};this.objectIdField&&(i[this.objectIdField]=e.id);const s=(0,n.pC)(t.attributeInfo)&&t.attributeInfo.attributeData;if((0,n.pC)(s))for(const n of Object.keys(s))i[n]=(0,a.Jx)(s[n],r);return i}getAttribute(e,t){if(t===this.objectIdField)return e.id;const{meta:r,index:i}=e,s=(0,n.pC)(r.attributeInfo)&&r.attributeInfo.attributeData;return(0,n.pC)(s)?(0,a.Jx)(s[t],i):null}getGeometry(e){if(e.geometry)return e.geometry;const[t,r,n,i,s]=this.getFeatureExtent(e,u);return new o.Z([5],[t,r,n,i,r,n,i,s,n,t,s,n,t,r,n])}getCentroid(e,t){if(e.geometry)return(0,s.Y)(new o.Z,e.geometry,t.hasZ,t.hasM);const[r,n,i,a,l,c]=this.getFeatureExtent(e,u);return new o.Z([0],[(r+a)/2,(n+l)/2,(i+c)/2])}cloneWithGeometry(e,t){const{id:r,index:n,meta:i}=e;return{id:r,index:n,meta:i,geometry:t}}}const u=(0,i.Ue)()},73552:(e,t,r)=>{r.d(t,{Z:()=>E});var n=r(27366),i=r(85015),s=r(91505),o=r(49861),a=(r(63780),r(93169),r(25243),r(69912)),l=r(67077),u=r(79803),c=r(41414),d=r(65156),p=r(42757);let h=class extends i.Z{constructor(e){super(e),this.events=new s.Z}forEach(e){this.forAllFeatures((t=>(e(t),p.K.CONTINUE)))}forEachBounds(e,t,r){const n=this.getFeatureExtent;for(const i of e)t(n(i,r))}forEachInBounds(e,t){this.forAllFeatures((r=>{const n=this.getFeatureExtent(r,y);return(0,d.kK)(e,(0,c.y8)(n,g))&&t(r),p.K.CONTINUE}),(t=>{if((0,u.st)(t.node.mbs,this.sourceSpatialReference,f,this.viewSpatialReference),f[0]>=e[0]&&f[2]<=e[2]&&f[1]>=e[1]&&f[3]<=e[3])return p.K.CONTINUE;const r=Math.max(e[0],Math.min(f[0],e[2])),n=Math.max(e[1],Math.min(f[1],e[3])),i=f[0]-r,s=f[1]-n;return i*i+s*s<=f[3]*f[3]?p.K.CONTINUE:p.K.SKIP}))}};(0,n._)([(0,o.Cb)({constructOnly:!0})],h.prototype,"featureAdapter",void 0),(0,n._)([(0,o.Cb)({constructOnly:!0})],h.prototype,"forAllFeatures",void 0),(0,n._)([(0,o.Cb)({constructOnly:!0})],h.prototype,"getFeatureExtent",void 0),(0,n._)([(0,o.Cb)({constructOnly:!0})],h.prototype,"sourceSpatialReference",void 0),(0,n._)([(0,o.Cb)({constructOnly:!0})],h.prototype,"viewSpatialReference",void 0),h=(0,n._)([(0,a.j)("esri.views.3d.layers.i3s.I3SQueryFeatureStore")],h);const f=(0,l.c)(),y=(0,c.Ue)(),g=(0,d.Ue)(),E=h},1247:(e,t,r)=>{r.d(t,{l:()=>c});var n=r(27366),i=r(32718),s=r(49861),o=(r(63780),r(93169),r(25243),r(69912)),a=r(48562),l=r(44011);const u=i.Z.getLogger("esri.views.3d.layers.support.DefinitionExpressionSceneLayerView"),c=e=>{let t=class extends e{constructor(){super(...arguments),this._definitionExpressionErrors=0,this._maxDefinitionExpressionErrors=20,this.logError=e=>{this._definitionExpressionErrors<this._maxDefinitionExpressionErrors&&u.error("Error while evaluating definitionExpression: "+e),this._definitionExpressionErrors++,this._definitionExpressionErrors===this._maxDefinitionExpressionErrors&&u.error("Further errors are ignored")}}get parsedDefinitionExpression(){if(!this.i3slayer||!this.i3slayer.definitionExpression)return null;try{const e=a.WhereClause.create(this.i3slayer.definitionExpression,this.i3slayer.fieldsIndex);if(!e.isStandardized)return u.error("definitionExpression is using non standard function"),null;const t=[],r=e.fieldNames;return(0,l.e8)(r,this.i3slayer.fields,{missingFields:t}),t.length>0?(u.error(`definitionExpression references unknown fields: ${t.join(", ")}`),null):(this._definitionExpressionErrors=0,e)}catch(e){return u.error("Failed to parse definitionExpression: "+e),null}}get definitionExpressionFields(){return this.parsedDefinitionExpression?this.parsedDefinitionExpression.fieldNames:null}_evaluateClause(e,t){try{return e.testFeature(t)}catch(r){return this.logError(r),!1}}_addDefinitionExpressionToQuery(e){if(!this.parsedDefinitionExpression)return e;const t=this.i3slayer.definitionExpression,r=e.clone();return r.where?r.where=`(${t}) AND (${r.where})`:r.where=t,r}};return(0,n._)([(0,s.Cb)()],t.prototype,"i3slayer",void 0),(0,n._)([(0,s.Cb)({readOnly:!0})],t.prototype,"parsedDefinitionExpression",null),(0,n._)([(0,s.Cb)({readOnly:!0})],t.prototype,"definitionExpressionFields",null),t=(0,n._)([(0,o.j)("esri.views.3d.layers.support.DefinitionExpressionSceneLayerView")],t),t}},24405:(e,t,r)=>{r.d(t,{V:()=>o,e:()=>s});var n=r(92026),i=r(80031);async function s(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.popupTemplate;if(!(0,n.pC)(t))return[];const r=await t.getRequiredFields(e.fieldsIndex),{lastEditInfoEnabled:s}=t,{objectIdField:o,typeIdField:a,globalIdField:l,relationships:u}=e;if(r.includes("*"))return["*"];const c=s?await(0,i.CH)(e):[],d=(0,i.Q0)(e.fieldsIndex,[...r,...c]);return a&&d.push(a),d&&o&&e.fieldsIndex.has(o)&&-1===d.indexOf(o)&&d.push(o),d&&l&&e.fieldsIndex.has(l)&&-1===d.indexOf(l)&&d.push(l),u&&u.forEach((t=>{const{keyField:r}=t;d&&r&&e.fieldsIndex.has(r)&&-1===d.indexOf(r)&&d.push(r)})),d}function o(e,t){return e.popupTemplate?e.popupTemplate:(0,n.pC)(t)&&t.defaultPopupTemplateEnabled&&(0,n.pC)(e.defaultPopupTemplate)?e.defaultPopupTemplate:null}}}]);
//# sourceMappingURL=4147.6ab8a61c.chunk.js.map