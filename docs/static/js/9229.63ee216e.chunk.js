"use strict";(globalThis.webpackChunkgeowebmap=globalThis.webpackChunkgeowebmap||[]).push([[9229],{32500:(e,t,i)=>{i.d(t,{I:()=>g,b:()=>p});var a=i(71011),r=i(33280),s=i(94951),n=i(21002),o=i(15226),l=i(10763),h=i(116),d=i(98634),c=i(64201),u=i(4760);function p(e){const t=new c.kG;return t.include(s.w,{linearDepth:!1}),t.vertex.uniforms.add("proj","mat4").add("view","mat4"),t.attributes.add(u.T.POSITION,"vec3"),t.attributes.add(u.T.UV0,"vec2"),t.varyings.add("vpos","vec3"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),t.vertex.uniforms.add("textureCoordinateScaleFactor","vec2"),t.vertex.code.add(d.H`
    void main(void) {
      vpos = position;
      ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
      vTexCoord = uv0 * textureCoordinateScaleFactor;
      gl_Position = transformPosition(proj, view, vpos);
    }
  `),t.include(r.p2,e),e.multipassTerrainEnabled&&(t.fragment.include(n.S),t.include(o.l,e)),t.fragment.uniforms.add("tex","sampler2D"),t.fragment.uniforms.add("opacity","float"),t.varyings.add("vTexCoord","vec2"),e.output===a.H.Alpha?t.fragment.code.add(d.H`
    void main() {
      discardBySlice(vpos);
      ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}

      float alpha = texture2D(tex, vTexCoord).a * opacity;
      if (alpha  < ${d.H.float(l.F)}) {
        discard;
      }

      gl_FragColor = vec4(alpha);
    }
    `):(t.fragment.include(h.Y),t.fragment.code.add(d.H`
    void main() {
      discardBySlice(vpos);
      ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
      gl_FragColor = texture2D(tex, vTexCoord) * opacity;

      if (gl_FragColor.a < ${d.H.float(l.F)}) {
        discard;
      }

      gl_FragColor = highlightSlice(gl_FragColor, vpos);
      ${e.oitEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
    }
    `)),t}const g=Object.freeze({__proto__:null,build:p})},69229:(e,t,i)=>{i.d(t,{Z:()=>M});var a=i(27366),r=i(14921),s=i(32718),n=i(92026),o=i(66978),l=i(8537),h=i(49861),d=(i(63780),i(93169),i(25243),i(69912)),c=i(53866),u=i(65156),p=i(26279),g=i(42069),m=i(81782),f=i(70619),y=i(4760);function _(e){return f.Z.createSquareGeometry([[e[0],e[1],-1],[e[2],e[1],-1],[e[2],e[3],-1],[e[0],e[3],-1]])}const v=[0,0,1];var b=i(61712),x=i(94463),w=i(54134),E=i(68401),C=i(78289),T=i(69831),A=i(1487),P=i(66156),S=i(67581),R=i(13107),O=i(69787),I=i(8548);const D=s.Z.getLogger("esri.views.3d.layers.DynamicLayerView3D");let H=class extends((0,R.y)((0,g.A)(S.Z))){constructor(){super(...arguments),this.drapeSourceType=p.Lw.RasterImage,this.updatePolicy=E.jq.SYNC,this.fullExtentInLocalViewSpatialReference=null,this.maximumDataResolution=null,this._images=new Array,this._extents=new Array,this._overlays=new Array,this.updateWhenStationary=!0,this.refreshDebounced=(0,o.Ds)((async e=>{this.destroyed||await this._doRefresh(e).catch((e=>{(0,o.D_)(e)||s.Z.getLogger(this.declaredClass).error(e)}))}),2e3)}initialize(){this.addResolvingPromise((0,b.E)(this).then((e=>this._set("fullExtentInLocalViewSpatialReference",e)))),this.updatingHandles.add((()=>this.suspended),(()=>this._suspendedChangeHandler())),this.handles.add(this.view.resourceController.scheduler.registerIdleStateCallbacks((()=>{this._isScaleRangeActive()&&this.notifyChange("suspended")}),(()=>{}))),this._isScaleRangeLayer()&&this.updatingHandles.add((()=>this.layer.effectiveScaleRange),(()=>this.notifyChange("suspended")))}destroy(){this.clear()}setDrapingExtent(e,t){this._spatialReference=t,e.forEach((e=>{this._overlays[e.index]=e,this._updateImageExtent(e)}))}_updateImageExtent(e){const t=this._clippedExtent(e.extent,G);if((0,n.Wi)(t))return;const i=function(e,t,i){const a=(0,u.bf)(e)/(0,u.Cb)(e),r={width:i,height:i};return a>1.0001?r.height=i/a:a<.9999&&(r.width=i*a),r.width=Math.round(r.width/((0,u.bf)(e)/(0,u.bf)(t))),r.height=Math.round(r.height/((0,u.Cb)(e)/(0,u.Cb)(t))),r}(e.extent,t,e.resolution);let a=e.pixelRatio*this.view.pixelRatio;if("imageMaxWidth"in this.layer||"imageMaxHeight"in this.layer){const e=this.layer.imageMaxWidth,t=this.layer.imageMaxHeight;if(i.width>e){const t=e/i.width;i.height=Math.floor(i.height*t),i.width=e,a*=t}if(i.height>t){const e=t/i.height;i.width=Math.floor(i.width*e),i.height=t,a*=e}}const r=this._extents[e.index];r&&(0,u.fS)(r.extent,t)&&this._imageSizeEquals(t,r.imageSize,i)||(this._extents[e.index]={extent:(0,u.Ue)(t),imageSize:i,pixelRatio:a},this.suspended||this._fetch(e.index).catch((e=>{(0,o.D_)(e)||D.error(e)})))}clear(){for(let e=0;e<this._images.length;e++)this._clearImage(e)}async doRefresh(){return this._doRefresh()}async _doRefresh(e){if(this.suspended)return;const t=[];for(let i=0;i<this._extents.length;i++)this._extents[i]&&t.push(this._fetch(i,e));await(0,o.as)(t)}canResume(){if(!super.canResume())return!1;const e=this.layer;if(this._isScaleRangeActive()){const{minScale:t,maxScale:i}=e.effectiveScaleRange,a=this.view.scale;if(a<i||t>0&&a>t)return!1}return!0}isUpdating(){return this._images.some((e=>!!e.loadingPromise))}async processResult(e,t,i){(t instanceof HTMLImageElement||t instanceof HTMLCanvasElement)&&(e.image=t)}findExtentInfoAt(e){for(const t of this._extents){const i=t.extent;if(new c.Z(i[0],i[1],i[2],i[3],this._spatialReference).contains(e))return t}return null}getFetchOptions(){}async redraw(e,t){await(0,r.Ed)(this._images,(async(i,a)=>{i&&(await e(i,t),await this._createStageObjects(a,i.image,t))}))}_imageSizeEquals(e,t,i){if(!this.maximumDataResolution)return!1;const a=(0,u.bf)(e)/this.maximumDataResolution.x,r=(0,u.Cb)(e)/this.maximumDataResolution.y,s=a/t.width,n=r/t.height,o=a/i.width,l=r/i.height,h=Math.abs(s-o),d=Math.abs(n-l),c=x.Z.TESTS_DISABLE_OPTIMIZATIONS?0:1.5;return h<=c&&d<=c}async _fetch(e,t){if(this.suspended)return;const i=this._extents[e],a=i.extent;this._images[e]||(this._images[e]={texture:null,material:null,renderGeometry:null,loadingPromise:null,loadingAbortController:null,image:null,pixelData:null,renderExtent:(0,u.Ue)(a)});const r=this._images[e];r.loadingAbortController&&(r.loadingAbortController.abort(),r.loadingAbortController=null);const s=new c.Z(a[0],a[1],a[2],a[3],this._spatialReference);if(0===s.width||0===s.height)return void this._clearImage(e);const n=new AbortController;r.loadingAbortController=n,(0,o.fu)(t,(()=>n.abort()));const l=n.signal,h=this._waitFetchReady(l).then((()=>{const t={requestAsImageElement:!0,pixelRatio:this._overlays[e].pixelRatio,...this.getFetchOptions(),signal:l},{height:a,width:r}=i.imageSize;return this.layer.fetchImage(s,r,a,t)})).then((e=>{if((0,o.Hc)(l))throw D.warnOnce("A call to fetchImage resolved even though the request was aborted. fetchImage should not resolve if options.signal.aborted is true."),(0,o.zE)();return this.processResult(r,e)})).then((()=>(0,u.JG)(r.renderExtent,a)));r.loadingPromise=h,(0,o.Bx)(h,(()=>{h===r.loadingPromise&&(r.loadingPromise=null,r.loadingAbortController=null)})),this.notifyChange("updating"),await h.then((async()=>{if(l.aborted)throw(0,o.zE)();await this._createStageObjects(e,r.image,l),this.notifyChange("updating")})).catch((e=>{throw e&&!(0,o.D_)(e)&&D.error(e),this.notifyChange("updating"),e}))}_clearImage(e){const t=this._images[e];if(t){(0,n.pC)(t.renderGeometry)&&(this.view.basemapTerrain.overlayManager.renderer.removeGeometries([t.renderGeometry],this,C.$.Geometry.UPDATE),t.renderGeometry=null);const e=this.view._stage;e.remove(t.texture),t.texture=null,e.remove(t.material),t.material=null,t.loadingAbortController&&(t.loadingAbortController.abort(),t.loadingAbortController=null),t.loadingPromise=null,t.image=null,t.pixelData=null}}async _createStageObjects(e,t,i){const a=this.view._stage,s=this._images[e],l=this.view.basemapTerrain.overlayManager.renderer,h=()=>{a.remove(s.texture),s.texture=null,(0,n.pC)(s.renderGeometry)&&(l.removeGeometries([s.renderGeometry],this,C.$.Geometry.UPDATE),s.renderGeometry=null)};if(t){const d=new A.x(t,{width:t.width,height:t.height,preMultiplyAlpha:!0,wrap:{s:I.e8.CLAMP_TO_EDGE,t:I.e8.CLAMP_TO_EDGE}});let c;if(await(0,r.q6)(this._images[e===w.fu.INNER?w.fu.OUTER:w.fu.INNER].loadingPromise),(0,o.k_)(i),e===w.fu.INNER)c=_(s.renderExtent);else{const e=this._images[0].renderExtent;if(!e)return void h();c=function(e,t){if(!(0,u.kK)(e,t))return _(t);const i=[e[1]-t[1],Math.min(e[3],t[3])-Math.max(e[1],t[1]),t[3]-e[3],123456],a=[e[0]-t[0],Math.min(e[2],t[2])-Math.max(e[0],t[0]),t[2]-e[2],123456],r=t[2]-t[0],s=t[3]-t[1],n=a[0]>0&&a[2]>0?3:2,o=i[0]>0&&i[2]>0?3:2,l=(o+1)*(n+1),h=new Float64Array(3*l),d=new Float32Array(2*l),c=new Uint32Array(6*(o*n-1));let p=0,g=0,f=0,b=0,x=0;for(let u=0;u<4;u++){const e=i[u];if(e<=0)continue;let o=0;for(let i=0;i<4;i++){const e=a[i];e<=0||(h[g++]=t[0]+o,h[g++]=t[1]+p,h[g++]=-1,d[f++]=o/r,d[f++]=p/s,i<3&&u<3&&(1!==i||1!==u)&&(c[x++]=b,c[x++]=b+1,c[x++]=b+n+1,c[x++]=b+1,c[x++]=b+n+2,c[x++]=b+n+1),b++,o+=e)}p+=e}const w=new Uint32Array(c.length);return new m.Z([[y.T.POSITION,{size:3,data:h,exclusive:!0}],[y.T.NORMAL,{size:3,data:v,exclusive:!0}],[y.T.UV0,{size:2,data:d,exclusive:!0}]],[[y.T.POSITION,c],[y.T.NORMAL,w],[y.T.UV0,c]])}(e,s.renderExtent)}h(),a.add(d),await a.loadImmediate(d),s.texture=d,(0,n.Wi)(s.material)?(s.material=new P.j({transparent:!0,textureId:d.id}),a.add(s.material)):s.material.setParameters({textureId:d.id}),s.renderGeometry=new T.z(c,s.material),s.renderGeometry.origin=this._overlays[e].renderLocalOrigin,l.addGeometries([s.renderGeometry],this,C.$.Geometry.UPDATE)}else h(),a.remove(s.material),s.material=null}_isScaleRangeLayer(){return"effectiveScaleRange"in this.layer}_isScaleRangeActive(){const e=this.layer;if(!this._isScaleRangeLayer())return!1;const{minScale:t,maxScale:i}=e.effectiveScaleRange;return(0,O.Av)(t,i)}_clippedExtent(e,t){if("local"!==this.view.viewingMode)return(0,u.JG)(t,e);const i=this.view.basemapTerrain;return i.ready?(0,u.jV)(e,i.extent,t):(0,u.JG)(t,e)}_suspendedChangeHandler(){this.suspended?this.clear():this.refreshDebounced()}async _waitFetchReady(e){await(0,l.N1)(this.view,"stationary",e),(0,o.k_)(e)}};(0,a._)([(0,h.Cb)()],H.prototype,"layer",void 0),(0,a._)([(0,h.Cb)()],H.prototype,"suspended",void 0),(0,a._)([(0,h.Cb)({readOnly:!0})],H.prototype,"fullExtentInLocalViewSpatialReference",void 0),(0,a._)([(0,h.Cb)()],H.prototype,"updating",void 0),H=(0,a._)([(0,d.j)("esri.views.3d.layers.DynamicLayerView3D")],H);const M=H,G=(0,u.Ue)()},61712:(e,t,i)=>{i.d(t,{E:()=>n});var a=i(92026),r=i(81753),s=i(67387);function n(e){const t=e.view.spatialReference,i=e.layer.fullExtent,n=(0,a.pC)(i)&&i.spatialReference;if((0,a.Wi)(i)||!n)return Promise.resolve(null);if(n.equals(t))return Promise.resolve(i.clone());const o=(0,r.iV)(i,t);return(0,a.pC)(o)?Promise.resolve(o):e.view.state.isLocal?(0,s.projectGeometry)(i,t,e.layer.portalItem).then((t=>!e.destroyed&&t?t:void 0)).catch((()=>null)):Promise.resolve(null)}},66156:(e,t,i)=>{i.d(t,{j:()=>S});var a=i(71011),r=i(68401),s=i(94425),n=i(40485),o=i(56529),l=i(78041),h=i(93822),d=i(64226),c=i(22909),u=i(27366),p=i(33280),g=i(15226),m=i(41012),f=i(82144),y=i(31132),_=i(33559),v=i(7566),b=i(27627),x=i(50411),w=i(32500),E=i(8548),C=i(36207);class T extends y.A{initializeProgram(e){const t=T.shader.get(),i=this.configuration,a=t.build({output:i.output,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,oitEnabled:i.transparencyPassType===r.Am.Color,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new b.$(e.rctx,a,v.i)}bindPass(e,t){(0,m.II)(this.program,t.camera.projectionMatrix),this.program.setUniform1f("opacity",e.opacity),t.multipassTerrainEnabled&&(this.program.setUniform2fv("nearFar",t.camera.nearFar),this.program.setUniform2fv("inverseViewport",t.inverseViewport),(0,g.p)(this.program,t))}bindDraw(e){(0,m.id)(this.program,e),(0,p.DA)(this.program,this.configuration,e),this.program.rebindTextures()}_setPipelineState(e,t){const i=this.configuration,s=e===r.Am.NONE,n=e===r.Am.FrontFace;return(0,C.sm)({blending:i.output!==a.H.Color&&i.output!==a.H.Alpha||!i.transparent?null:s?A:(0,l.j7)(e),culling:(0,C.zp)(i.cullFace),depthTest:{func:(0,l.Bh)(e)},depthWrite:s?i.writeDepth&&C.LZ:(0,l.K5)(e),colorWrite:C.BK,stencilWrite:i.sceneHasOcludees?x.s3:null,stencilTest:i.sceneHasOcludees?t?x.eD:x.RY:null,polygonOffset:s||n?null:(0,l.je)(i.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._setPipelineState(this.configuration.transparencyPassType,!0),this._setPipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(e,t){return t?this._occludeePipelineState:super.getPipelineState(e,t)}}T.shader=new f.J(w.I,(()=>i.e(8957).then(i.bind(i,18957))));const A=(0,C.if)(E.zi.ONE,E.zi.ONE_MINUS_SRC_ALPHA);class P extends _.m{constructor(){super(...arguments),this.output=a.H.Color,this.cullFace=r.Vr.None,this.slicePlaneEnabled=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!0,this.sceneHasOcludees=!1,this.transparencyPassType=r.Am.NONE,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}(0,u._)([(0,_.o)({count:a.H.COUNT})],P.prototype,"output",void 0),(0,u._)([(0,_.o)({count:r.Vr.COUNT})],P.prototype,"cullFace",void 0),(0,u._)([(0,_.o)()],P.prototype,"slicePlaneEnabled",void 0),(0,u._)([(0,_.o)()],P.prototype,"transparent",void 0),(0,u._)([(0,_.o)()],P.prototype,"enableOffset",void 0),(0,u._)([(0,_.o)()],P.prototype,"writeDepth",void 0),(0,u._)([(0,_.o)()],P.prototype,"sceneHasOcludees",void 0),(0,u._)([(0,_.o)({count:r.Am.COUNT})],P.prototype,"transparencyPassType",void 0),(0,u._)([(0,_.o)()],P.prototype,"multipassTerrainEnabled",void 0),(0,u._)([(0,_.o)()],P.prototype,"cullAboveGround",void 0);class S extends o.F5{constructor(e){super(e,O),this.supportsEdges=!0,this.techniqueConfig=new P}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.cullFace=this.parameters.cullFace,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,this.techniqueConfig.transparencyPassType=t.transparencyPassType,this.techniqueConfig.enableOffset=t.camera.relativeElevation<l.ve,this.techniqueConfig.multipassTerrainEnabled=t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=t.cullAboveGround,this.techniqueConfig}intersect(e,t,i,a,r,s,n){(0,c.Bw)(e,t,a,r,s,void 0,n)}requiresSlot(e,t){return e===h.r.DRAPED_MATERIAL||((0,s.S)(t)===a.H.Highlight?e===h.r.OPAQUE_MATERIAL:e===(this.parameters.transparent?this.parameters.writeDepth?h.r.TRANSPARENT_MATERIAL:h.r.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:h.r.OPAQUE_MATERIAL))}createGLMaterial(e){return e.output===a.H.Color||e.output===a.H.Alpha||e.output===a.H.Highlight?new R(e):void 0}createBufferWriter(){return new d.G_(d.W1)}}class R extends n.Z{constructor(e){super({...e,...e.material.parameters})}updateParameters(e){const t=this._material.parameters;return this.updateTexture(t.textureId),this.ensureTechnique(T,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.sceneHasOcludees&&(this._material.setParameters({sceneHasOcludees:e.hasOccludees}),this.updateParameters(e))}beginSlot(e){return this._output!==a.H.Color&&this._output!==a.H.Alpha||this._updateOccludeeState(e),this.updateParameters(e)}bind(e,t){this.bindTextures(t.program),this.bindTextureScale(t.program),t.bindPass(this._material.parameters,e)}}const O={transparent:!1,writeDepth:!0,slicePlaneEnabled:!1,cullFace:r.Vr.None,sceneHasOcludees:!1,opacity:1,textureId:null,initTextureTransparent:!0,...o.mo}},13107:(e,t,i)=>{i.d(t,{y:()=>h});var a=i(27366),r=i(32718),s=i(66978),n=i(94172),o=i(49861),l=(i(63780),i(93169),i(25243),i(69912));const h=e=>{let t=class extends e{initialize(){this.handles.add((0,n.on)((()=>this.layer),"refresh",(e=>{this.doRefresh(e.dataChanged).catch((e=>{(0,s.D_)(e)||r.Z.getLogger(this.declaredClass).error(e)}))})),"RefreshableLayerView")}};return(0,a._)([(0,o.Cb)()],t.prototype,"layer",void 0),t=(0,a._)([(0,l.j)("esri.layers.mixins.RefreshableLayerView")],t),t}}}]);
//# sourceMappingURL=9229.63ee216e.chunk.js.map