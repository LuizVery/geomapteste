"use strict";(globalThis.webpackChunkgeowebmap=globalThis.webpackChunkgeowebmap||[]).push([[7452],{15801:(e,r,t)=>{t.d(r,{Z:()=>b});var i,s=t(27366),l=t(40110),n=t(93002),a=t(51370),o=t(49861),u=(t(63780),t(93169),t(25243),t(69912)),d=t(59147),p=t(58550);const y={type:l.Z,readOnly:!0,json:{origins:{service:{read:{source:"sublayers",reader:h}}},read:!1}};function h(e,r,t){if(e&&Array.isArray(e))return new l.Z(e.map((e=>{const r=function(e){return"group"===e.layerType?c:d.Z}(e);if(r){const i=new r;return i.read(e,t),i}t&&t.messages&&e&&t.messages.push(new a.Z("building-scene-layer:unsupported-sublayer-type","Building scene sublayer of type '"+(e.type||"unknown")+"' are not supported",{definition:e,context:t}))})))}let c=i=class extends p.Z{constructor(e){super(e),this.type="building-group",this.listMode="show",this.sublayers=null}loadAll(){return(0,n.w)(this,(e=>i.forEachSublayer(this.sublayers,(r=>{"building-group"!==r.type&&e(r)}))))}};var g;(0,s._)([(0,o.Cb)({type:["hide","show","hide-children"],json:{write:!0}})],c.prototype,"listMode",void 0),(0,s._)([(0,o.Cb)(y)],c.prototype,"sublayers",void 0),c=i=(0,s._)([(0,u.j)("esri.layers.buildingSublayers.BuildingGroupSublayer")],c),(g=c||(c={})).sublayersProperty=y,g.readSublayers=h,g.forEachSublayer=function e(r,t){r.forEach((r=>{t(r),"building-group"===r.type&&e(r.sublayers,t)}))};const b=c},7452:(e,r,t)=>{t.r(r),t.d(r,{default:()=>re});var i=t(27366),s=t(52639),l=t(85015),n=t(40110),a=t(42537),o=t(32718),u=t(92026),d=t(66978),p=t(8537),y=t(49861),h=(t(63780),t(93169),t(25243),t(69912)),c=(t(15801),t(10064)),g=t(94172),b=t(48562),f=(t(59147),t(18661)),w=t(80031),v=t(21149),_=t(91505),F=t(41691),m=t(79056),C=t(67426);const E=(e,r)=>{let t=class extends((0,C.v)((0,F.p)((0,m.I)(_.Z.EventedMixin(e))))){constructor(e){super(e),this.sublayer=null,this.parent=null,this.view=null}initialize(){}get suspended(){return!this.canResume()}get updating(){return!this.suspended&&this.isUpdating()}get visible(){return!0===this.get("sublayer.visible")}set visible(e){void 0!==e?this._override("visible",e):this._clearOverride("visible")}get fullOpacity(){const e=e=>null!=e?e:1;return e(this.get("sublayer.opacity"))*e(this.get("parent.fullOpacity"))}canResume(){return!this.get("parent.suspended")&&this.get("view.ready")&&this.visible||!1}isUpdating(){return!1}};return(0,i._)([(0,y.Cb)()],t.prototype,"sublayer",void 0),(0,i._)([(0,y.Cb)()],t.prototype,"parent",void 0),(0,i._)([(0,y.Cb)({readOnly:!0})],t.prototype,"suspended",null),(0,i._)([(0,y.Cb)({type:Boolean,readOnly:!0})],t.prototype,"updating",null),(0,i._)([(0,y.Cb)()],t.prototype,"view",void 0),(0,i._)([(0,y.Cb)()],t.prototype,"visible",null),(0,i._)([(0,y.Cb)()],t.prototype,"fullOpacity",null),t=(0,i._)([(0,h.j)("esri.views.3d.layers.BuildingSublayerView3D")],t),t};var x,S,V=t(2244),M=t(42757),I=t(67077),L=t(97689),O=t(49420);(S=x||(x={}))[S.Solid=0]="Solid",S[S.WireFrame=1]="WireFrame",S[S.XRay=2]="XRay";function R(e){switch(e.filterMode.type){case"solid":return{mode:x.Solid};case"wire-frame":return{mode:x.WireFrame,edgeMaterial:(0,L.C8)(e.filterMode.edges,{})};case"x-ray":return{mode:x.XRay}}}function Q(e,r){if((0,u.Wi)(r))return e.color[3]=0,e.edgeMaterial=null,void(e.pickable=!1);switch(r.mode){case x.Solid:return;case x.WireFrame:return e.color[3]=0,e.edgeMaterial=r.edgeMaterial,void(e.pickable=!1);case x.XRay:return e.color[0]=1,e.color[1]=1,e.color[2]=1,e.color[3]*=.15,e.colorMixMode=O.a9.Replace,e.castShadows=!1,e.pickable=!1,void(e.edgeMaterial=function(e){return(0,u.Wi)(e)?null:(q.lastMaterial!==e&&(q.cachedMaterial=function(e){const r=(0,I.b)(e.color);return r[3]*=.075,{...e,color:r}}(e),q.lastMaterial=e),q.cachedMaterial)}(e.edgeMaterial))}}const q={cachedMaterial:null,lastMaterial:null};var Z=t(31730),P=t(71039),A=t(43812),G=t(51246),N=t(73552),j=t(44011),k=t(1247);t(75505),t(39052),t(47492),t(13922);class B extends l.Z{constructor(){super(...arguments),this.sublayer=null}get updating(){return!1}get suspended(){return!1}get availableFields(){return[]}get filter(){return null}set filter(e){throw new Error("Not implemented")}queryFeatures(e,r){throw new Error("Not implemented")}queryObjectIds(e,r){throw new Error("Not implemented")}queryFeatureCount(e,r){throw new Error("Not implemented")}createQuery(){throw new Error("Not implemented")}queryExtent(e,r){throw new Error("Not implemented")}highlight(e){throw new Error("Not implemented")}}(0,i._)([(0,y.Cb)()],B.prototype,"sublayer",void 0),(0,i._)([(0,y.Cb)()],B.prototype,"availableFields",null),(0,i._)([(0,y.Cb)()],B.prototype,"filter",null);var W=t(24405),U=t(6403);const z=o.Z.getLogger("esri.views.3d.layers.BuildingComponentSublayerView3D");let D=class extends((0,k.l)((0,V.N)(E(B)))){constructor(){super(...arguments),this.type="building-component-sublayer-3d",this.layerView=null,this._elevationContext="scene",this._isIntegratedMesh=!1,this._supportsLabeling=!1,this.lodFactor=1,this.progressiveLoadFactor=1,this._queryEngine=null}get layerUid(){return this.sublayer.layer.uid}get sublayerUid(){return this.sublayer.uid}initialize(){this.updatingHandles.add((()=>[this.sublayer.renderer,this.definitionExpressionFields,this.filterExpressionFields]),(()=>this._updateRequiredFields())),this.updatingHandles.add((()=>this.sublayer.renderer),(e=>this._rendererChange(e)),g.nn),this.updatingHandles.add((()=>[this.parsedDefinitionExpression,this.filter,(0,u.yw)(this.viewFilter,(e=>{let{parsedWhereClause:r,parsedGeometry:t,sortedObjectIds:i}=e;return[r,t,i]}))]),(()=>this._filterChange())),this.updatingHandles.add((()=>this.parsedFilterExpressions),(()=>this._updateSymbologyOverride()),g.nn),this.addResolvingPromise(this._updateRequiredFields())}get parsedFilterExpressions(){return"Overview"===this.sublayer.modelName?[]:this.layerView.filterExpressions.map((e=>{let r,[t,i]=e;try{r=b.WhereClause.create(t,this.sublayer.fieldsIndex)}catch(E){return z.error("Failed to parse filterExpression: "+E),null}if(!r.isStandardized)return z.error("filterExpression is using non standard function"),null;const s=[],l=r.fieldNames;return(0,j.e8)(l,this.sublayer.fields,{missingFields:s}),s.length>0?(z.error(`filterExpression references unknown fields: ${s.join(", ")}`),null):[r,i]})).filter((e=>null!=e))}get filter(){return(0,u.pC)(this.viewFilter)?this.viewFilter.filter:null}set filter(e){!(0,u.Wi)(e)&&P.z.checkSupport(e)?(0,u.pC)(this.viewFilter)?this.viewFilter.filter=e:this.viewFilter=new P.z({filter:e,layerFieldsIndex:this.sublayer.fieldsIndex,loadAsyncModule:e=>this._loadAsyncModule(e),applyFilters:()=>this._applyFilters(!0),addSqlFilter:(e,r)=>this.addSqlFilter(e,r,this.logError)}):this.viewFilter=null}_updateSymbologyOverride(){const e=this.parsedFilterExpressions;e.length>0?this._setSymbologyOverride(((r,t)=>{for(const[s,l]of e)try{if(s.testFeature(r))return Q(t,l)}catch(i){this.logError(i)}return Q(t,null)}),this.filterExpressionFields):this._setSymbologyOverride(null,null)}get filterExpressionFields(){return(0,w.Q0)(this.sublayer.fieldsIndex,this.parsedFilterExpressions.reduce(((e,r)=>{let[t]=r;return e.concat(t.fieldNames)}),[]))}get availableFields(){const e=this.sublayer,r=e.fieldsIndex;let t=this.requiredFields;if(e.outFields||e.layer.outFields){const i=[...e.outFields||[],...e.layer.outFields||[]];t=[...(0,w.Lk)(r,i),...t]}return(0,w.Q0)(r,t)}_createLayerGraphic(e){const r=new s.Z(null,null,e);return r.layer=this.sublayer.layer,r.sourceLayer=this.sublayer,r}canResume(){return super.canResume()&&(!this._controller||this._controller.rootNodeVisible)}async fetchPopupFeatures(e,r){const t=this._validateFetchPopupFeatures(r);if(t)return Promise.reject(t);if(!(0,u.pC)(r)||!r.clientGraphics||0===r.clientGraphics.length)return[];const i=[],s=[],l=(0,u.pC)(this.sublayer.associatedLayer)?await this.sublayer.associatedLayer.load():this.sublayer,n=(0,w.Lk)(this.sublayer.fieldsIndex,await(0,W.e)(l,(0,W.V)(this.sublayer,r))),a=new Set;for(const o of r.clientGraphics)(0,w.Gm)(n,o,a)?s.push(o):i.push(o);return 0===s.length?Promise.resolve(i):((0,u.pC)(this.sublayer.associatedLayer)&&await this.sublayer.associatedLayer.load().catch((()=>z.warn("Failed to load associated feature layer. Displaying popup attributes from cached attributes."))),this.whenGraphicAttributes(s,Array.from(a)).catch((()=>s)).then((e=>i.concat(e))))}async _updateRequiredFields(){const e=(0,w.Q0)(this.sublayer.fieldsIndex,[...this.sublayer.renderer?await this.sublayer.renderer.getRequiredFields(this.sublayer.fieldsIndex):[],...this.definitionExpressionFields||[],...this.filterExpressionFields||[]]);this._set("requiredFields",e)}_validateFetchPopupFeatures(e){const{sublayer:r}=this,{popupEnabled:t}=r;return t?(0,W.V)(r,e)?void 0:new c.Z("buildingscenelayerview3d:fetchPopupFeatures","Layer does not define a popup template",{sublayer:r}):new c.Z("buildingscenelayerview3d:fetchPopupFeatures","Popups are disabled",{sublayer:r})}getFilters(){const e=super.getFilters();return this.addSqlFilter(e,this.parsedDefinitionExpression,this.logError),(0,u.pC)(this.viewFilter)&&this.viewFilter.addFilters(e,this.view,this._controller.crsIndex,this._collection),e}createQuery(){const e={outFields:["*"],returnGeometry:!1,outSpatialReference:this.view.spatialReference};return(0,u.pC)(this.filter)?this.filter.createQuery(e):new v.Z(e)}queryExtent(e,r){return this._ensureQueryEngine().executeQueryForExtent(this._ensureQuery(e),null==r?void 0:r.signal)}queryFeatureCount(e,r){return this._ensureQueryEngine().executeQueryForCount(this._ensureQuery(e),null==r?void 0:r.signal)}queryFeatures(e,r){return this._ensureQueryEngine().executeQuery(this._ensureQuery(e),null==r?void 0:r.signal).then((e=>{if(null==e||!e.features)return e;const r=this.sublayer,t=r.layer;for(const i of e.features)i.layer=t,i.sourceLayer=r;return e}))}queryObjectIds(e,r){return this._ensureQueryEngine().executeQueryForIds(this._ensureQuery(e),null==r?void 0:r.signal)}_ensureQueryEngine(){return(0,u.Wi)(this._queryEngine)&&(this._queryEngine=this._createQueryEngine()),this._queryEngine}_createQueryEngine(){const e=(0,Z.gz)(this.view.spatialReference,this.view.renderSpatialReference,this._collection);return new A.Z({layerView:this,priority:U.T8.FEATURE_QUERY_ENGINE,spatialIndex:new N.Z({featureAdapter:new G.u({objectIdField:this.sublayer.objectIdField,attributeStorageInfo:this.sublayer.attributeStorageInfo,getFeatureExtent:e}),forAllFeatures:(e,r)=>this._forAllFeatures(((r,t,i)=>e({id:r,index:t,meta:i})),r,M.u.ALL_IN_CLIPPING_AREA),getFeatureExtent:e,sourceSpatialReference:(0,j.tp)(this.sublayer),viewSpatialReference:this.view.spatialReference})})}_ensureQuery(e){return this._addDefinitionExpressionToQuery((0,u.Wi)(e)?this.createQuery():v.Z.from(e))}};(0,i._)([(0,y.Cb)({aliasOf:"sublayer"})],D.prototype,"i3slayer",void 0),(0,i._)([(0,y.Cb)()],D.prototype,"layerView",void 0),(0,i._)([(0,y.Cb)()],D.prototype,"suspended",void 0),(0,i._)([(0,y.Cb)({readOnly:!0,aliasOf:"view.qualitySettings.sceneService.3dObject.lodFactor"})],D.prototype,"lodFactor",void 0),(0,i._)([(0,y.Cb)({readOnly:!0})],D.prototype,"parsedFilterExpressions",null),(0,i._)([(0,y.Cb)({type:f.Z})],D.prototype,"filter",null),(0,i._)([(0,y.Cb)()],D.prototype,"viewFilter",void 0),(0,i._)([(0,y.Cb)({type:[String],readOnly:!0})],D.prototype,"filterExpressionFields",null),(0,i._)([(0,y.Cb)({type:[String],readOnly:!0})],D.prototype,"requiredFields",void 0),(0,i._)([(0,y.Cb)({type:[String],readOnly:!0})],D.prototype,"availableFields",null),D=(0,i._)([(0,h.j)("esri.views.3d.layers.BuildingComponentSublayerView3D")],D);const T=D;var H=t(42069),X=t(58890),$=t(67581);class J extends $.Z{constructor(){super(...arguments),this.layer=null,this.sublayerViews=null}highlight(e){throw new Error("Not implemented")}}(0,i._)([(0,y.Cb)()],J.prototype,"layer",void 0),(0,i._)([(0,y.Cb)()],J.prototype,"sublayerViews",void 0);const Y=o.Z.getLogger("esri.views.3d.layers.BuildingSceneLayerView3D"),K=E(l.Z);let ee=class extends((0,H.A)(J)){constructor(){super(...arguments),this.type="building-scene-3d",this.sublayerViews=new n.Z,this._abortController=new AbortController,this._loadingComponents=0}get filterExpression(){const e=this.layer.activeFilterId,r=null!=e?this.layer.filters.find((r=>r.id===e)):null,t=null!=r?r.filterBlocks.find((e=>"solid"===e.filterMode.type)):null;return t?t.filterExpression:null}get filterExpressions(){const e=this.layer.activeFilterId,r=null!=e?this.layer.filters.find((r=>r.id===e)):null;return r&&r.filterBlocks?r.filterBlocks.toArray().map((e=>[e.filterExpression,R(e)])):[]}get updatingProgressValue(){const e=this.sublayerViews,r=this._loadingComponents+(e?e.length:0);return e.reduce(((e,r)=>e+r.updatingProgress),0)/r}isUpdating(){return this._loadingComponents>0||this.sublayerViews&&this.sublayerViews.some((e=>e.updating))}initialize(){(0,j.Jf)(this.layer.spatialReference,this.view.spatialReference,this.view.viewingMode),this._initializeSubLayerViews(this.layer.sublayers,this)}destroy(){this.sublayerViews&&(this.sublayerViews.forEach((e=>e.destroy())),this.sublayerViews=null),this._abortController.abort(),this._abortController=null}_initializeSubLayerViews(e,r){const t=this,i=this.view;e.forEach((e=>{if(!e.isEmpty)if("building-group"===e.type){const t=new K({sublayer:e,view:i,parent:r});this._initializeSubLayerViews(e.sublayers,t)}else"mesh"===e.geometryType&&(this._loadingComponents++,e.load({signal:this._abortController.signal}).then((()=>{const s=new T({sublayer:e,layerView:t,view:i,parent:r});this.sublayerViews.push(s),this.handles.add([(0,p.S1)(s,"updating",(()=>this.notifyChange("updating")),!0),(0,p.S1)(s,"updatingProgress",(()=>this.notifyChange("updatingProgressValue")),!0)])})).catch((r=>{(0,d.D_)(r)||Y.error(`Error while creating view for sublayer ${e.id}\nLayer: ${this.layer.url}\n`,r)})).then((()=>{this._loadingComponents--,this.notifyChange("updating"),this.notifyChange("updatingProgressValue")})))}))}getGraphicFromIntersectorTarget(e){for(const r of this.sublayerViews.items)if(r.sublayer.uid===e.sublayerUid)return r.getGraphicFromIntersectorTarget(e);return null}async fetchPopupFeatures(e,r){if(!(0,u.pC)(r)||!r.clientGraphics||0===r.clientGraphics.length)return;const t=this._findComponent(r.clientGraphics[0].sourceLayer);return(0,u.Wi)(t)?void 0:t.fetchPopupFeatures(e,r)}whenGraphicBounds(e){const r=this._findComponent(e.sourceLayer);return(0,u.Wi)(r)?Promise.reject():r.whenGraphicBounds(e)}_findComponent(e){return this.sublayerViews.find((r=>e===r.sublayer))}highlight(e){e instanceof s.Z?e=[e]:e instanceof n.Z&&(e=e.toArray());const r=[];if(Array.isArray(e)&&e.length>0&&e[0]instanceof s.Z){const t=e,i=new Map;for(const e of t){let r=i.get(e.sourceLayer);null==r&&(r=[],i.set(e.sourceLayer,r)),r.push(e)}this.sublayerViews.forEach((e=>{const t=i.get(e.sublayer);t&&r.push(e.highlight(t))}))}return(0,a.AL)(r)}getUsedMemory(){return this.sublayerViews.reduce(((e,r)=>e+r.getUsedMemory()),0)}getUnloadedMemory(){return this.sublayerViews.reduce(((e,r)=>e+r.getUnloadedMemory()),0)}ignoresMemoryFactor(){return!1}};(0,i._)([(0,y.Cb)()],ee.prototype,"sublayerViews",void 0),(0,i._)([(0,y.Cb)({readOnly:!0})],ee.prototype,"filterExpression",null),(0,i._)([(0,y.Cb)({readOnly:!0})],ee.prototype,"filterExpressions",null),(0,i._)([(0,y.Cb)(X.q)],ee.prototype,"updatingProgress",void 0),(0,i._)([(0,y.Cb)({readOnly:!0,dependsOn:[]})],ee.prototype,"updatingProgressValue",null),ee=(0,i._)([(0,h.j)("esri.views.3d.layers.BuildingSceneLayerView3D")],ee);const re=ee}}]);
//# sourceMappingURL=7452.557f3c0f.chunk.js.map