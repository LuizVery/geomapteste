(function(){var e={"esri/core/CircularArray":1486,"esri/views/3d/support/EventedSet":1680,"esri/layers/graphics/data/StreamFeatureManager":1703,"esri/layers/graphics/sources/connections/GeoEventConnection":1704,"esri/layers/graphics/sources/connections/StreamConnection":1705,"esri/layers/graphics/controllers/StreamController":2180},t=this||window,r=t.webpackJsonp=t.webpackJsonp||[];r.registerAbsMids?r.registerAbsMids(e):(r.absMidsWaiting=r.absMidsWaiting||[]).push(e)})(),(window.webpackJsonp=window.webpackJsonp||[]).push([[72],{1486:function(e,t,r){var i,n;i=[r.dj.c(e.i),t],void 0===(n=function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e){void 0===e&&(e=Number.POSITIVE_INFINITY),this.size=0,this._start=0,this.maxSize=e,this._buffer=isFinite(e)?new Array(e):[]}return Object.defineProperty(e.prototype,"entries",{get:function(){return this._buffer},enumerable:!0,configurable:!0}),e.prototype.enqueue=function(e){if(this.size===this.maxSize){var t=this._buffer[this._start];return this._buffer[this._start]=e,this._start=(this._start+1)%this.maxSize,t}return isFinite(this.maxSize)?this._buffer[(this._start+this.size++)%this.maxSize]=e:this._buffer[this._start+this.size++]=e,null},e.prototype.dequeue=function(){if(0===this.size)return null;var e=this._buffer[this._start];return this._buffer[this._start]=null,this.size--,this._start=(this._start+1)%this.maxSize,e},e}();t.default=r}.apply(null,i))||(e.exports=n)},1680:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(0),r(38),r(92)],void 0===(n=function(e,t,r,i,n){Object.defineProperty(t,"__esModule",{value:!0});var o=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._set=new Set,t}return r.__extends(t,e),t.prototype.clear=function(){if(this._set.size>0){var e=this.toArray();this._set.clear(),this.emit("after-changes",{type:2}),this.emit("change",{added:[],removed:e})}},Object.defineProperty(t.prototype,"length",{get:function(){return this._set.size},enumerable:!0,configurable:!0}),t.prototype.addMany=function(e){if(0!==e.length){for(var t=0,r=e;t<r.length;t++){var i=r[t];this._set.add(i)}this.emit("after-changes",{type:1}),this.emit("change",{added:e,removed:[]})}},t.prototype.remove=function(e){this._set.delete(e)&&(this.emit("after-changes",{type:2}),this.emit("change",{added:[],removed:[e]}))},t.prototype.removeMany=function(e){for(var t=[],r=0,i=e;r<i.length;r++){var n=i[r];this._set.delete(n)&&t.push(n)}t.length>0&&(this.emit("after-changes",{type:2}),this.emit("change",{added:[],removed:t}))},t.prototype.toArray=function(){return n.valuesOfSet(this._set)},t.prototype.find=function(e){var t;return n.someSet(this._set,(function(r){return!!e(r)&&(t=r,!0)})),t},t.prototype.forEach=function(e){this._set.forEach((function(t){return e(t)}))},t}(i);t.EventedSet=o}.apply(null,i))||(e.exports=n)},1703:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(1486),r(12),r(2)],void 0===(n=function(e,t,r,i,n){Object.defineProperty(t,"__esModule",{value:!0}),t.DEFAULT_STREAM_ID_FIELD="__esri_stream_id__";var o=function(){function e(e,r,i,n,o){void 0===o&&(o=128),this._trackIdToObservations=new Map,this._idCounter=0,this._lastPurge=Date.now(),this._addOrUpdated=new Map,this._removed=[],this._maxAge=0,this._timeInfo=i,this._purgeOptions=n,this.store=e,this.objectIdField=r,this.purgeInterval=o,this._useGeneratedIds=this.objectIdField===t.DEFAULT_STREAM_ID_FIELD}return e.prototype.add=function(e){if(this._useGeneratedIds&&(e.attributes[this.objectIdField]=this._nextId()),e.objectId=e.attributes[this.objectIdField],this.store.add(e),this._addOrUpdated.set(e.objectId,e),this._maxAge=Math.max(this._maxAge,e.attributes[this._timeInfo.startTimeField]),this._timeInfo.trackIdField){var t=e.attributes[this._timeInfo.trackIdField];if(!this._trackIdToObservations.has(t)){var o=n.isSome(this._purgeOptions)&&null!=this._purgeOptions.maxObservations?this._purgeOptions.maxObservations:1e3,s=i.clamp(o,0,1e3);this._trackIdToObservations.set(t,new r.default(s))}var a=this._trackIdToObservations.get(t),u=e.attributes[this.objectIdField],c=a.enqueue(u);if(n.isSome(c)){var d=this.store.removeById(c);n.isSome(d)&&(this._addOrUpdated.has(c)?this._addOrUpdated.delete(c):this._removed.push(d))}}},e.prototype.checkForUpdates=function(){var e=this._getToAdd(),t=this._getToRemove(),r=Date.now();r-this._lastPurge>=this.purgeInterval&&(this._purge(),this._lastPurge=r),(e||t)&&this.store.update(e,t)},e.prototype._getToAdd=function(){if(!this._addOrUpdated.size)return null;var e=new Array(this._addOrUpdated.size),t=0;return this._addOrUpdated.forEach((function(r){return e[t++]=r})),this._addOrUpdated.clear(),e},e.prototype._getToRemove=function(){var e=this._removed;return this._removed.length?(this._removed=[],e):null},e.prototype._nextId=function(){var e=this._idCounter;return this._idCounter=(this._idCounter+1)%4294967294+1,e},e.prototype._purge=function(){var e=this._purgeOptions;n.isSome(e)&&(this._purgeSomeByDisplayCount(e),this._purgeByAge(e),this._purgeTracks())},e.prototype._purgeSomeByDisplayCount=function(e){var t=this;if(e.displayCount){var r=this.store.size;r>e.displayCount&&this._trackIdToObservations.forEach((function(i){if(r>e.displayCount&&i.size){var o=t.store.removeById(n.unwrap(i.dequeue()));n.isSome(o)&&t._removed.push(o),r--}}))}},e.prototype._purgeByAge=function(e){var t=this;if(e.age){var r=60*e.age*1e3,i=this._maxAge-r,n=this._timeInfo.startTimeField;this.store.forEach((function(e){e.attributes[n]<i&&(t.store.removeById(e.objectId),t._removed.push(e))}))}},e.prototype._purgeTracks=function(){var e=this;this._trackIdToObservations.forEach((function(t,r){0===t.size&&e._trackIdToObservations.delete(r)}))},e}();t.default=o}.apply(null,i))||(e.exports=n)},1704:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(0),r(28),r(33),r(11),r(5),r(2),r(4),r(1),r(1321),r(1705),r(432),r(423),r(304)],void 0===(n=function(e,t,r,i,n,o,s,a,u,c,d,h,p,l,_){Object.defineProperty(t,"__esModule",{value:!0});var f,y=s.getLogger("esri.layers.graphics.sources.connections.GeoEventConnection");!function(e){e[e.CONNECTING=0]="CONNECTING",e[e.OPEN=1]="OPEN",e[e.CLOSING=2]="CLOSING",e[e.CLOSED=3]="CLOSED"}(f=t.ReadyState||(t.ReadyState={}));var v=function(e){function t(t,r,i,n,o,s,a,u){void 0===s&&(s=5),void 0===a&&(a=3);var c=e.call(this)||this;return c._destroyed=!1,c.errorString=null,c._source=t,c._sourceSpatialReference=r,c._spatialReference=i,c._filter=o,c._outFields=u,c._maxQueryDepth=s,c._maxRecordCountFactor=a,c._featureZScaler=l.getGeometryZScaler(n,r,i),c._open(),c}return r.__extends(t,e),t.prototype._open=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t,i,n;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this._fetchServiceDefinition(this._source)];case 1:return(e=r.sent()).timeInfo.trackIdField||y.warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect."),[4,this._fetchWebSocketUrl(e.streamUrls,this._spatialReference)];case 2:return t=r.sent(),this._buddyServicesQuery||(this._buddyServicesQuery=this._queryBuddyServices()),[4,this._buddyServicesQuery];case 3:return r.sent(),[4,this._tryCreateWebSocket(t)];case 4:return r.sent(),i=this._filter,n=this._outFields,this._destroyed||this._setFilter(i,n),[2]}}))}))},t.prototype.destroy=function(){this._destroyed=!0,a.isSome(this._websocket)&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null},Object.defineProperty(t.prototype,"connectionStatus",{get:function(){if(a.isNone(this._websocket))return"disconnected";switch(this._websocket.readyState){case f.CONNECTING:case f.OPEN:return"connected";case f.CLOSING:case f.CLOSED:return"disconnected"}},enumerable:!0,configurable:!0}),t.prototype._tryCreateWebSocket=function(e,t){return void 0===t&&(t=1e3),r.__awaiter(this,void 0,void 0,(function(){var i,n,s;return r.__generator(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,4]),this._destroyed?[2]:(i=this,[4,this._createWebSocket(e)]);case 1:return i._websocket=r.sent(),this.notifyChange("connectionStatus"),[3,4];case 2:return n=r.sent(),s=t/1e3,y.error(new o("geoevent-connection","Failed to connect. Attempting to reconnect in "+s+"s",n)),[4,u.after(t)];case 3:return r.sent(),[2,this._tryCreateWebSocket(e,1.5*t)];case 4:return[2]}}))}))},t.prototype._createWebSocket=function(e){var t=this,r=new WebSocket(e),i=u.create((function(e,t){r.onopen=function(){return e(r)},r.onclose=function(e){return t(e)}}));return i.then((function(){if(t._destroyed)return r.onclose=function(){},void r.close();r.onclose=function(e){return t._onClose(e)},r.onerror=function(e){return t._onError(e)},r.onmessage=function(e){return t._onMessage(e)}})),i},t.prototype._onMessage=function(e){var t;try{t=this._enrich(JSON.parse(e.data)),this._featureZScaler&&this._featureZScaler(t.geometry)}catch(e){return void y.error(new o("geoevent-connection","Failed to parse message",e))}this.onFeature(t)},t.prototype._onError=function(e){var t="Encountered an error over WebSocket connection";this._set("errorString",t),y.error("geoevent-connection",t)},t.prototype._onClose=function(e){this._websocket=null,this.notifyChange("connectionStatus"),1e3!==e.code&&y.error("geoevent-connection","WebSocket closed unexpectedly with error code "+e.code),this._destroyed||this._open()},t.prototype._fetchServiceDefinition=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,i;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,n(e,{query:{f:"json"},responseType:"json"})];case 1:return t=r.sent(),i=t.data,this._serviceDefinition=i,[2,i]}}))}))},t.prototype._fetchWebSocketUrl=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i,n,o;return r.__generator(this,(function(r){return i=e[0],n=i.urls,o=i.token,[2,this._inferWebSocketBaseUrl(n)+"/subscribe?outSR="+t.wkid+(o?"&token="+o:"")]}))}))},t.prototype._inferWebSocketBaseUrl=function(e){if(1===e.length)return e[0];for(var t=0,r=e;t<r.length;t++){var i=r[t];if(-1!==i.indexOf("wss"))return i}return y.error(new o("geoevent-connection","Unable to infer WebSocket url",e)),null},t.prototype._setFilter=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i,n,s,c,d,h,p=this;return r.__generator(this,(function(r){return i=this._websocket,this._filter=e,this._outFields=t,a.isNone(i)||a.isNone(e)&&a.isNone(t)?[2]:(n=JSON.stringify({filter:this._serializeFilter(e,t)}),s=!1,c=u.createResolver(),d=function(){s||(p._destroyed||p._websocket!==i||y.error(new o("geoevent-connection","Server timed out when setting filter")),c.reject())},h=function(e){var t=JSON.parse(e.data);t.filter&&(t.error&&(y.error(new o("geoevent-connection","Failed to set service filter",t.error)),p._set("errorString","Could not set service filter - "+t.error),c.reject(t.error)),i.onmessage=p._onMessage.bind(p),s=!0,c.resolve())},i.onmessage=h,i.send(n),setTimeout(d,1e4),[2,c.promise])}))}))},t.prototype._serializeFilter=function(e,t){var r={};if(a.isNone(e)&&a.isNone(t))return r;if(a.isSome(e)&&e.geometry)try{var n=i.fromJSON(e.geometry);if("extent"!==n.type)throw new o("Expected extent but found type "+n.type);r.geometry=JSON.stringify(n.shiftCentralMeridian())}catch(e){y.error(new o("geoevent-connection","Encountered an error when setting connection geometryDefinition",e))}return a.isSome(e)&&e.where&&"1 = 1"!==e.where&&(r.where=e.where),a.isSome(t)&&(r.outFields=t.join(",")),r},t.prototype._enrich=function(e){if(!this._relatedFeatures)return e;var t=this._serviceDefinition.relatedFeatures.joinField,r=e.attributes[t];if(!this._relatedFeatures.has(r))return y.warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",e),e;var i=this._relatedFeatures.get(r),n=i.attributes,s=i.geometry;for(var a in n)e.attributes[a]=n[a];return s&&(e.geometry=s),e.geometry||e.centroid||y.error(new o("geoevent-connection","Found malformed feature - no geometry found",e)),e},t.prototype._queryBuddyServices=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t,i,n,s,a,u,c,d,h;return r.__generator(this,(function(r){switch(r.label){case 0:return r.trys.push([0,3,,4]),e=this._serviceDefinition,t=e.relatedFeatures,i=e.keepLatestArchive,n=this._queryRelatedFeatures(t),s=this._queryArchive(i),[4,n];case 1:return r.sent(),[4,s];case 2:if(!(a=r.sent()))return[2];for(u=0,c=a.features;u<c.length;u++)d=c[u],this.onFeature(this._enrich(d));return[3,4];case 3:return h=r.sent(),y.error(new o("geoevent-connection","Encountered an error when querying buddy services",{error:h})),[3,4];case 4:return[2]}}))}))},t.prototype._queryRelatedFeatures=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t;return r.__generator(this,(function(r){switch(r.label){case 0:return e?[4,this._queryBuddy(e.featuresUrl)]:[2];case 1:return t=r.sent(),this._addRelatedFeatures(t),[2]}}))}))},t.prototype._queryArchive=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){return e?[2,this._queryBuddy(e.featuresUrl)]:[2,void 0]}))}))},t.prototype._queryBuddy=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,i,n,o,s,u,c,h,l,f;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,(t=new d({url:e})).load()];case 1:return i=r.sent().capabilities,n=i.query.supportsMaxRecordCountFactor,o=i.query.supportsPagination,s=i.query.supportsCentroid,u=this._maxRecordCountFactor,c=t.capabilities.query.maxRecordCount,h=n?c*u:c,(l=new _).outFields=a.unwrapOr(this._outFields,["*"]),l.where=a.unwrapOr(a.get(this._filter,"where"),"1=1"),l.returnGeometry=!0,l.returnExceededLimitFeatures=!0,l.outSpatialReference=this._spatialReference,s&&(l.returnCentroid=!0),n&&(l.maxRecordCountFactor=u),o?(l.num=h,t.destroy(),[2,this._queryPages(e,l)]):[4,p.executeQuery(e,l,this._sourceSpatialReference)];case 2:return f=r.sent(),t.destroy(),[2,f.data]}}))}))},t.prototype._queryPages=function(e,t,i,n){return void 0===i&&(i=[]),void 0===n&&(n=0),r.__awaiter(this,void 0,void 0,(function(){var o;return r.__generator(this,(function(r){switch(r.label){case 0:return t.start=n*t.num,[4,p.executeQuery(e,t,this._sourceSpatialReference)];case 1:return(o=r.sent().data).exceededTransferLimit&&n<this._maxQueryDepth?(o.features.forEach((function(e){return i.push(e)})),[2,this._queryPages(e,t,i,n+1)]):(i.forEach((function(e){return o.features.push(e)})),[2,o])}}))}))},t.prototype._addRelatedFeatures=function(e){for(var t=new Map,r=e.features,i=this._serviceDefinition.relatedFeatures.joinField,n=0,o=r;n<o.length;n++){var s=o[n],a=s.attributes[i];t.set(a,s)}this._relatedFeatures=t},r.__decorate([c.property()],t.prototype,"connectionStatus",null),r.__decorate([c.property()],t.prototype,"errorString",void 0),r.__decorate([c.subclass("esri.layers.graphics.sources.connections.GeoEventConnection")],t)}(h.default);t.default=v}.apply(null,i))||(e.exports=n)},1705:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(0),r(38),r(145),r(1)],void 0===(n=function(e,t,r,i,n,o){Object.defineProperty(t,"__esModule",{value:!0});var s=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r.__extends(t,e),t.prototype.onFeature=function(e){this.emit("feature",e)},r.__decorate([o.subclass("esri.layers.graphics.sources.connections.StreamConnection")],t)}(i.EventedMixin(n.HandleOwner));t.default=s}.apply(null,i))||(e.exports=n)},2180:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(0),r(28),r(91),r(38),r(145),r(127),r(1),r(1703),r(1704),r(1680)],void 0===(n=function(e,t,r,i,n,o,s,a,u,c,d,h){Object.defineProperty(t,"__esModule",{value:!0});var p=function(){function e(e,t){this.layer=e,this.collection=t,this._idToGraphic=new Map,this._idToFeature=new Map}return e.prototype.destroy=function(){this._idToGraphic.clear(),this._idToFeature.clear()},e.prototype.add=function(e){var t=n.fromJSON(e);t.sourceLayer=t.layer=this.layer,this._idToFeature.set(e.objectId,e),this._idToGraphic.set(e.objectId,t),this.collection.addMany([t])},e.prototype.forEach=function(e){this._idToFeature.forEach(e)},e.prototype.removeById=function(e){var t=this._idToFeature.get(e),r=this._idToGraphic.get(e);return t&&r?(r.sourceLayer=r.layer=null,this.collection.remove(r),this._idToFeature.delete(e),this._idToGraphic.delete(e),t):null},e.prototype.update=function(e,t){},Object.defineProperty(e.prototype,"size",{get:function(){return this.collection.length},enumerable:!0,configurable:!0}),e}(),l=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.graphics=new h.EventedSet,t}return r.__extends(t,e),t.prototype.initialize=function(){var e=this;this.addResolvingPromise(this.layer.when((function(){return e._startup()})))},t.prototype.destroy=function(){this.clear()},t.prototype.clear=function(){this._updateIntervalId&&(clearInterval(this._updateIntervalId),this._updateIntervalId=0),this.connection&&(this.connection.destroy(),this.connection=null),this.store&&(this.store.destroy(),this.store=null),this.graphics.clear(),this.handles.removeAll()},Object.defineProperty(t.prototype,"updating",{get:function(){return!this.connection||"connected"===this.connection.connectionStatus},enumerable:!0,configurable:!0}),t.prototype._startup=function(){var e=this,t=this.layer,r=t.parsedUrl,n=t.spatialReference,o=t.definitionExpression,s=t.geometryDefinition,a=t.objectIdField,u=t.timeInfo,h=t.purgeOptions,l=i.featureGeometryTypeKebabDictionary.toJSON(this.layer.geometryType);this.clear(),this._set("connection",new d.default(r.path,n,this.layerView.view.spatialReference,l,{geometry:s,where:o})),this.store=new p(this.layer,this.graphics),this.featuresManager=new c.default(this.store,a,u.toJSON(),h),this.handles.add([this.connection.on("feature",(function(t){return e._onFeature(t)})),this.layer.watch("definitionExpression",(function(){return e._startup()})),this.layer.watch("geometryDefinition",(function(){return e._startup()})),this.layer.watch("purgeOptions",(function(){return e._startup()}))]),this._updateIntervalId=setInterval((function(){return e.featuresManager.checkForUpdates()}),64)},t.prototype._onFeature=function(e){this.emit("data-received",{attributes:e.attributes,centroid:e.centroid,geometry:e.geometry});try{this.featuresManager.add(e)}catch(e){}},r.__decorate([u.property()],t.prototype,"connection",void 0),r.__decorate([u.property()],t.prototype,"layer",void 0),r.__decorate([u.property()],t.prototype,"layerView",void 0),r.__decorate([u.property({readOnly:!0,dependsOn:["connection.connectionStatus"]})],t.prototype,"updating",null),r.__decorate([u.subclass("esri.layers.graphics.controllers.StreamController")],t)}(s.HandleOwnerMixin(a.EsriPromiseMixin(o.EventedAccessor)));t.default=l}.apply(null,i))||(e.exports=n)}}]);