"use strict";(globalThis.webpackChunkgeowebmap=globalThis.webpackChunkgeowebmap||[]).push([[9589],{69589:(e,t,i)=>{i.r(t),i.d(t,{default:()=>q});var s=i(27366),r=i(10064),l=i(92026),a=i(66978),n=i(8537),o=i(49861),h=(i(63780),i(93169),i(25243),i(69912));class c{constructor(e,t){this.lockedSchemaPixelSize=e,this.isGCS=t}getLevelRowColumn(e){return this.isGCS?[e[0],e[1]>>1,e[2]>>1]:256===this.lockedSchemaPixelSize&&e[0]>0?[e[0]-1,e[1]>>1,e[2]>>1]:e}adjustLevel(e){return this.isGCS?e:256===this.lockedSchemaPixelSize?e>0?e-1:0:e}getShift(e,t){let i=0,s=0;return(256===this.lockedSchemaPixelSize||this.isGCS)&&(e[2]%2&&(i=t),e[1]%2&&(s=t)),[i,s]}getScale(e){if(this.isGCS){if(512===this.lockedSchemaPixelSize)return 4}else if(256===this.lockedSchemaPixelSize&&0===e)return 1;return 2}}var d=i(18759),u=i(23588),g=i(65156),y=i(72291),p=i(98067),_=i(38684),m=i(42121),C=i(12463),f=i(36210),b=i(50127),w=i(21391);var v=i(73828);class S extends p.m{constructor(e,t,i,s,r){super(e,t,i),this._memCache=s,this._loader=r,this._ongoingTileRequests=new Map,this._ongoingRequestToController=new Map}destroy(){this._ongoingRequestToController.forEach((e=>e.abort())),this._ongoingRequestToController.clear(),this._ongoingTileRequests.clear()}async getVectorTile(e,t,i,s){const r=new v.Z(e,t,i,0);let n=this._memCache.get(r.id);if((0,l.pC)(n))return n.retain(),n;const o=await this._getVectorTileData(r);if((0,a.k_)(s),!this._layer)return null;if(n=this._memCache.get(r.id),(0,l.pC)(n))return n.retain(),n;const h=this._layer.tileInfo.getTileBounds((0,g.Ue)(),r);return n=new y.i(r,h[0],h[3],512,512,this._styleRepository,this._memCache),(0,l.pC)(o)?(n.setData(o),n.retain(),this._memCache.put(r.id,n,n.memoryUsage*n.referenced,d.an)):n.setData(null),n.neededForCoverage=!0,n.transforms.tileUnitsToPixels=(0,u.f)(1/8,0,0,0,1/8,0,0,0,1),function(e,t){const i=[],s=new f.L(4096,i,(()=>{const e=new _.J;return e.show=!1,e.parts.push({startTime:0,startOpacity:0,targetOpacity:0,show:!1}),e.parts.push({startTime:0,startOpacity:0,targetOpacity:0,show:!1}),e})),r=new C.g(i,s,((t,i,s)=>new m.f(t,i,s,e.styleRepository,e.key.level,0)),((e,t)=>{(0,b.C$)(e,t,!1)}),(()=>0),(e=>{const i=t.getStyleLayerByUID(e).getLayoutProperty("visibility");return!i||i.getValue()!==w.EE.NONE}));i.push(e),s.add(e),r.setScreenSize(512,512),r.continue(1/0)}(n,this._styleRepository),n}_getVectorTileData(e){const t=e.id;if(this._ongoingTileRequests.has(t))return this._ongoingTileRequests.get(t);const i=new AbortController,s={signal:i.signal},r=this._getParsedVectorTileData(e,s).then((e=>(this._ongoingTileRequests.delete(t),this._ongoingRequestToController.delete(t),e))).catch((()=>(this._ongoingTileRequests.delete(t),this._ongoingRequestToController.delete(t),null)));return this._ongoingTileRequests.set(t,r),this._ongoingRequestToController.set(t,i),r}_getParsedVectorTileData(e,t){return this.fetchTileData(e,t).then((i=>this.parseTileData({key:e,data:i},t)))}request(e,t){return this._loader.request(e,"binary",t)}}var R=i(75010),T=i(56130),L=i(8548);const P=1e-6;class E{constructor(e,t){this.spriteMosaic=e,this.glyphMosaic=t,this._brushCache=new Map,this._vtlMaterialManager=new T.Z}dispose(){this._brushCache&&(this._brushCache.forEach((e=>e.dispose())),this._brushCache=null),this._vtlMaterialManager=(0,l.O3)(this._vtlMaterialManager),this.spriteMosaic.dispose(),this.glyphMosaic.dispose()}get vectorTilesMaterialManager(){return this._vtlMaterialManager}drawTile(e,t,i){const{context:s}=e,r=i.layers;i.backgroundBucketIds.length>0&&(e.renderPass="background",i.backgroundBucketIds.forEach((s=>this._renderStyleLayer(i.getLayerById(s),e,t,!0)))),s.setBlendingEnabled(!1),s.setDepthTestEnabled(!0),s.setDepthWriteEnabled(!0),s.setDepthFunction(L.wb.LEQUAL),e.renderPass="opaque";for(let l=r.length-1;l>=0;l--)this._renderStyleLayer(r[l],e,t,!1);s.setDepthWriteEnabled(!1),s.setBlendingEnabled(!0),s.setBlendFunctionSeparate(L.zi.ONE,L.zi.ONE_MINUS_SRC_ALPHA,L.zi.ONE,L.zi.ONE_MINUS_SRC_ALPHA),e.renderPass="translucent";for(let l=0;l<r.length;l++)this._renderStyleLayer(r[l],e,t,!1);s.setDepthTestEnabled(!1),e.renderPass="symbol";for(let l=0;l<r.length;l++)this._renderStyleLayer(r[l],e,t,!1);s.bindVAO()}_renderStyleLayer(e,t,i){if(!(arguments.length>3&&void 0!==arguments[3]&&arguments[3]||e&&i.layerData.has(e.uid)))return;const s=e.getLayoutProperty("visibility");if(s&&s.getValue()===w.EE.NONE)return;const{renderPass:r}=t;let l;switch(e.type){case w.fR.BACKGROUND:if("background"!==r)return;l="vtlBackground";break;case w.fR.FILL:if("opaque"!==r&&"translucent"!==t.renderPass)return;l="vtlFill";break;case w.fR.LINE:if("translucent"!==r)return;l="vtlLine";break;case w.fR.CIRCLE:if("symbol"!==r)return;l="vtlCircle";break;case w.fR.SYMBOL:if("symbol"!==r)return;l="vtlSymbol"}const a=t.displayLevel;void 0!==e.minzoom&&e.minzoom>a+P||void 0!==e.maxzoom&&e.maxzoom<=a-P||(t.styleLayerUID=e.uid,t.styleLayer=e,this._drawWithBrush(t,i,l))}_drawWithBrush(e,t,i){if(!this._brushCache.has(i)){const e=R.J[i];this._brushCache.set(i,new e)}this._brushCache.get(i).drawMany(e,[t])}}var H=i(30969),I=i(42069),M=i(77385),k=i(53379),x=i(67581);let O=class extends((0,M.r)((0,I.A)(x.Z))){constructor(){super(...arguments),this.type="vector-tile-3d"}initialize(){if((0,l.Wi)(this.layer.fullExtent))return void this.addResolvingPromise(Promise.reject(new r.Z("vectortilelayerview:full-extent-undefined","This layer view's layer does not define a fullExtent.")));const{basemapTerrain:e,spatialReference:t,pixelRatio:i,viewingMode:s}=this.view,o="local"===s&&!(0,k.jO)(t)||k.Bu.force512VTL,h=this.layer.tileInfo.spatialReference.isGeographic,d=o?this.layer.tileInfo:this.layer.tileInfo.getOrCreateCompatible(256,h?1:2),u=this._getTileInfoSupportError(d,this.layer.fullExtent);if((0,l.pC)(u))return this.addResolvingPromise(Promise.reject(u));const g=(0,n.LR)(this.view,"basemapTerrain.tilingSchemeLocked").then((()=>{const t=e.tilingScheme,i=t.pixelSize;let s;if(this.schemaHelper=new c(i,e.spatialReference.isGeographic),256===i){const e=this.layer.tileInfo.spatialReference.isGeographic;s=this.layer.tileInfo.getOrCreateCompatible(256,e?1:2)}else s=this.view.spatialReference.isGeographic?this.layer.tileInfo.getOrCreateCompatible(512,.5):this.layer.tileInfo;const r=this._getTileInfoCompatibilityError(s,t);if(r)throw r;this.tileInfo=s}));this._tileHandlerController=new AbortController;const y=this.view.resourceController;this._memCache=y.memoryController.newCache(this.layer.uid,(e=>{e.release()}));const{style:p}=this.layer.currentStyleInfo,_=new H.Z(p),m=e.mapTileRequester;this._tileHandler=new S(this.layer,_,i,this._memCache,m);const C=this._tileHandlerController.signal,f=e=>y.schedule(e),b=this._tileHandler.start({signal:C,schedule:f}),w=this._tileHandler.spriteMosaic;w.then((e=>{!(0,a.Hc)(C)&&this._tileHandler&&(this.painter=new E(e,this._tileHandler.glyphMosaic))})),b.then((()=>this._tileHandlerController=null));this.updatingHandles.add((()=>[this.layer.currentStyleInfo,this.view.pixelRatio]),(()=>{this._tileHandlerController&&this._tileHandlerController.abort(),this._tileHandlerController=new AbortController,this._memCache.clear();const{style:e}=this.layer.currentStyleInfo,t=new H.Z(e),s=new S(this.layer,t,i,this._memCache,m),r=s.start({signal:this._tileHandlerController.signal,schedule:f}),l=s.spriteMosaic;r.then((()=>this._tileHandlerController=null)),this.updatingHandles.addPromise(Promise.all([r,l]).then((e=>{let[,t]=e;const i=this._tileHandler,r=this.painter;this.painter=new E(t,s.glyphMosaic),this._tileHandler=s,this.emit("data-changed"),i.destroy(),r&&r.dispose()})))}));const v=Promise.all([g,b,w]);this.addResolvingPromise(v)}destroy(){this.painter=(0,l.O3)(this.painter),this._tileHandlerController&&(this._tileHandlerController.abort(),this._tileHandlerController=null),(0,l.SC)(this._tileHandler),this._memCache=(0,l.SC)(this._memCache),this._tileHandler=null}get dataLevelRange(){const e=this.tileInfo.lods,t=e[0].scale,i=e[e.length-1].scale,s=this.levelRangeFromScaleRange(t,i);return 1===s.minLevel&&256===this.tileInfo.size[0]&&(s.minLevel=0),s}async fetchTile(e,t,i,s){return this._tileHandler.getVectorTile(e,t,i,s)}};(0,s._)([(0,o.Cb)()],O.prototype,"layer",void 0),(0,s._)([(0,o.Cb)()],O.prototype,"dataLevelRange",null),(0,s._)([(0,o.Cb)()],O.prototype,"updatingProgressValue",void 0),O=(0,s._)([(0,h.j)("esri.views.3d.layers.VectorTileLayerView3D")],O);const q=O}}]);
//# sourceMappingURL=9589.64d93ff5.chunk.js.map