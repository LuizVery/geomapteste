(this.webpackJsonpgeowebmap=this.webpackJsonpgeowebmap||[]).push([[65],{1024:function(e,t,i){"use strict";i.d(t,"a",(function(){return d}));var r=i(35),n=i(12),a=i(3),s=i(4),o=i(6),u=i(7),c=i(80),l=i(123),d=function(e){Object(o.a)(i,e);var t=Object(u.a)(i);function i(){var e;return Object(a.a)(this,i),(e=t.apply(this,arguments))._map=new Map,e}return Object(s.a)(i,[{key:"clear",value:function(){if(this._map.size>0){var e=this.toArray();this._map.clear(),this.emit("change",{added:[],removed:e})}}},{key:"length",get:function(){return this._map.size}},{key:"get",value:function(e){return this._map.get(e)}},{key:"addMany",value:function(e){if(0!==e.length){for(var t=new Set,i=0;i<e.length;i++){var r=e[i],n=r.objectId,a=this._map.get(n);a?(t.add(n),r!==a&&(e[i]=a),++a.refCount):(r.refCount=1,this._map.set(n,r))}var s=t.size>0?e.filter((function(e){return!t.has(e.objectId)})):e;s.length>0&&this.emit("change",{added:s,removed:[]})}}},{key:"removeMany",value:function(e){var t,i=[],r=Object(n.a)(e);try{for(r.s();!(t=r.n()).done;){var a=t.value,s=a.objectId,o=this._map.get(s);null!=o&&--o.refCount<=0&&(this._map.delete(s),i.push(a))}}catch(u){r.e(u)}finally{r.f()}i.length>0&&this.emit("change",{added:[],removed:i})}},{key:"removeManyByObjectId",value:function(e){var t,i=[],r=Object(n.a)(e);try{for(r.s();!(t=r.n()).done;){var a=t.value,s=this._map.get(a);null!=s&&--s.refCount<=0&&(this._map.delete(a),i.push(s))}}catch(o){r.e(o)}finally{r.f()}i.length>0&&this.emit("change",{added:[],removed:i})}},{key:"toArray",value:function(){return Object(r.a)(this._map.values())}},{key:"find",value:function(e){var t;return Object(l.c)(this._map,(function(i){return!!e(i)&&(t=i,!0)})),t}},{key:"forEach",value:function(e){this._map.forEach((function(t){return e(t)}))}}]),i}(c.a)},1025:function(e,t,i){"use strict";i.d(t,"a",(function(){return Re}));var r=i(35),n=i(31),a=i(3),s=i(4),o=i(6),u=i(7),c=i(0),l=i(32),d=i(55),h=i(17),f=i(16),b=i(2),p=i(75),v=i(202),y=i(23),g=i(27),m=i(1),O=(i(18),i(9)),_=i(53),j=i(38),x=i(45),k=i(208),w=i(715),C=i(12),I=i(102),S=i(104),E=function(){function e(t){Object(a.a)(this,e),this.referenceCount=0,this.callbacks=[],this.runIndex=0,this.handle=t.registerTask(S.b.I3S_CONTROLLER,this)}return Object(s.a)(e,[{key:"destroy",value:function(){this.handle&&(this.handle.remove(),this.handle=null)}},{key:"running",get:function(){var e,t=Object(C.a)(this.callbacks);try{for(t.s();!(e=t.n()).done;){if(e.value.needsUpdate())return!0}}catch(i){t.e(i)}finally{t.f()}return!1}},{key:"runTask",value:function(e){this.sort();for(var t=this.callbacks,i={numIndexLoading:0,numNodesLoading:0},r=0;r<t.length&&!e.done;++r)t[r].priority=t[r].update(e,i),this.runIndex=r}},{key:"sort",value:function(){for(var e=this.callbacks,t=e.length,i=this.runIndex;i>0;i--){for(var r=e[i-1],n=i;n<e.length&&r.priority<=e[n].priority&&(n!==t||r.priority<e[n].priority);)e[n-1]=e[n],n++;e[n-1]=r,t=n-1}this.runIndex=0}},{key:"add",value:function(e){this.sort(),e.priority=1/0,this.callbacks.unshift(e)}},{key:"remove",value:function(e){Object(I.m)(this.callbacks,e),this.runIndex=this.callbacks.length,this.sort()}}]),e}(),N=new Map;function D(e,t){var i=N.get(e);return null==i&&(i=new E(e),N.set(e,i)),i.add(t),{remove:function(){null!=i&&(i.remove(t),i.callbacks.length>0||(N.delete(e),i.destroy()),i=null)}}}var F=i(5),V=i(50),P=function e(t,i){Object(a.a)(this,e),this.id=t,this.mbs=i,this.renderMbs=Object(V.d)([0,0,0,-1]),this.imModificationImpact=4},A=function(e){Object(o.a)(i,e);var t=Object(u.a)(i);function i(e,r,n,s,o,u,c,l,d,h){var f;return Object(a.a)(this,i),(f=t.call(this,e,n)).index=r,f.childCount=s,f.level=o,f.resources=u,f.version=c,f.lodMetric=l,f.maxError=d,f.numFeatures=h,f.failed=!1,f.hasModifications=!1,f.cacheState=0,f.vertexCount=0,f.memory=0,f}return i}(P),L=function e(t,i,r,n){Object(a.a)(this,e),this.nodeHasLOD=t,this.isChosen=i,this.lodLevel=r,this.version=n},M=i(910),R=i(445),T=function e(t,i,r,n,s){Object(a.a)(this,e),this.childOffset=t,this.childCount=i,this.visibilityCache=r,this.ref=n,this.node=s,this.useAsHole=0,this.filterImpact=2},G=function(){function e(t,i,r,n,s,o,u,c,l,d,h,f,b,v){Object(a.a)(this,e),this.streamDataController=r,this.viewportQueries=n,this.logger=s,this.holeFilling=o,this._isLoaded=u,this._isReloading=c,this._isSelected=l,this._enable=d,this._needsUpdate=h,this._canRequest=f,this._computeVisibilityObb=b,this._computeNodeFiltering=v,this._dirty=!0,this._nodePages=[],this.nodeCount=0,this.nodesPerPage=0,this.rootIndex=0,this.lodMetric=0,this.lodConversion=function(e){return e},this.urlPrefix="",this._loading=new Set,this._failedNodes=new Set,this._failedPages=new Set,this._indexMissing=1,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._nodeTraversalState=new Map,this._version=H(0),this._visibilityCacheVersion=H(0),this._maxLevel=1,this._featureEstimate={estimate:0,leavesReached:!1},this._unloadedMemoryEstimate=0,this._missing=new p.a({deallocator:null}),this._prefetch=new p.a({deallocator:null}),this._updates=new q,this._imModificationUncategorized=new p.a({deallocator:null}),this.ignoreServiceObb=!1,this.progressiveLoadPenalty=0,this.layerHasModifications=!1,this._layerHasFilter=!1,this.logLayer=t,t.serviceUpdateTimeStamp&&t.serviceUpdateTimeStamp.lastUpdate&&(this.lastUpdate="".concat(t.serviceUpdateTimeStamp.lastUpdate)),this._maxLodLevel=this.viewportQueries?this.viewportQueries.maxLodLevel:1,this.init(i)}return Object(s.a)(e,[{key:"init",value:function(e){if("page"===e.type){switch(this.urlPrefix=e.urlPrefix,this.nodesPerPage=e.pageSize,this.rootIndex=e.rootIndex,e.lodMetric){case"maxScreenThreshold":this.lodMetric=1;break;case"maxScreenThresholdSQ":this.lodMetric=1,this.lodConversion=$}this.addPage(W(this.rootIndex,this.nodesPerPage),e.rootPage)}else if("node"===e.type){this.urlPrefix=e.urlPrefix,this._nodePages.push({nodes:[],children:[],parents:[]}),this.makeRefNode(new P(e.rootNode.id,null),-1);var t=this._validateNode(e.rootNode.id,e.rootNode);t&&this.addNode(t,0)}}},{key:"loadPage",value:function(e){var t=this;this._loading.add(e);var i=this.urlPrefix+e;this.streamDataController.request(i,"json").then((function(i){t._loading.delete(e),t.addPage(e,i)})).catch((function(i){t._loading.delete(e),Object(y.n)(i)||(t._failedPages.add(e),t.logger.error("#loadPage()",t.logLayer,"Error when loading page ".concat(e),i))}))}},{key:"addPage",value:function(e,t){for(var i=this,r=this._nodePages.length;r<e;r++)this._nodePages[r]=null;var n=[],a=[],s=t.nodes.map((function(t,r){var s=n.length,o=t.children?t.children.length:0;a.push(-1);for(var u=0;u<o;u++)n.push(t.children[u]);var c="".concat(t.index),l=Object(R.b)(t.obb),d=Object(V.d)([l.center[0],l.center[1],l.center[2],Object(F.r)(l.halfSize)]),h=t.mesh&&t.mesh.attribute,f=t.mesh&&t.mesh.geometry,b=t.mesh&&t.mesh.material,p={hasSharedResource:!1,hasFeatureData:!!f,attributes:h&&null!=h.resource?"".concat(h.resource):null,geometry:f&&null!=f.resource?"".concat(f.resource):null,texture:b&&null!=b.resource?"".concat(b.resource):null,geometryDefinition:f?f.definition:-1,materialDefinition:b?b.definition:-1},v=new A(c,e*i.nodesPerPage+r,d,o,0,p,i.lastUpdate,i.lodMetric,i.lodConversion(t.lodThreshold),f?f.featureCount:null);return v.serviceObb=l,v.visibilityObb=i._computeVisibilityObb(v),v.vertexCount=f?f.vertexCount:0,new T(s,o,B(i._visibilityCacheVersion),null,v)}));this._nodePages[e]={nodes:s,children:n,parents:a},this.nodeCount+=s.length,this.updateParentsAndLevel()}},{key:"updateParentsAndLevel",value:function(){var e=this,t=new Array,i=function(i,r,n){var a=e.getPage(i);if(Object(b.k)(a)){var s=Y(i,e.nodesPerPage);a.parents[s]=r;var o=a.nodes[s].node;Object(b.k)(o)&&(o.level=n,t.push(i))}};for(i(this.rootIndex,-1,0);t.length;){var r=t.pop(),n=this.getNode(r);if(Object(b.k)(n))for(var a=0;a<n.childCount;a++)i(this.getChildIndex(n,a),r,n.level+1),this._maxLevel=Math.max(this._maxLevel,n.level+1)}}},{key:"getPage",value:function(e){return this._nodePages[W(e,this.nodesPerPage)]}},{key:"getNodeInternal",value:function(e){var t=this.getPage(e);return Object(b.j)(t)?null:t.nodes[Y(e,this.nodesPerPage)]}},{key:"addNode",value:function(e,t){null!=e.children&&this.populateChildren(t,e.children);var i=this.getParent(t),r=Object(b.k)(i)?i.level+1:0;this._maxLevel=Math.max(this._maxLevel,e.children?r+1:r);var n=function(e){if(e)for(var t=0;t<e.length;t++){var i,r=Object(C.a)(Z);try{for(r.s();!(i=r.n()).done;){var n=i.value;if(n[0]===e[t].metricType)return{lodMetric:n[1],maxError:e[t].maxError}}}catch(a){r.e(a)}finally{r.f()}}return{lodMetric:0,maxError:0}}(e.lodSelection),a=n.lodMetric,s=n.maxError,o=Object(b.t)(this.getNodeInternal(t));return o.node=new A(e.id,t,Object(V.d)(e.mbs),o.childCount,r,e.resources,e.version,a,s,e.numFeatures),e.obb&&(o.node.serviceObb=Object(R.b)(e.obb)),o.node.visibilityObb=this._computeVisibilityObb(o.node),Object(b.k)(o.ref)&&(null==o.ref.mbs&&(o.ref.mbs=e.mbs),o.node.renderMbs=o.ref.renderMbs,o.node.serviceObbInRenderSR=o.ref.serviceObbInRenderSR,o.ref.visibilityObb=o.node.visibilityObb),o.node}},{key:"makeRefNode",value:function(e,t){var i=this._nodePages[0],r=i.nodes.length;return i.nodes.push(new T(0,0,B(this._visibilityCacheVersion),e,null)),this.nodeCount++,i.parents.push(t),e.renderMbs[3]=-1,Object(b.k)(e.serviceObbInRenderSR)&&(e.serviceObbInRenderSR.halfSize[0]=-1),r}},{key:"populateChildren",value:function(e,t){var i=Object(b.t)(this.getNodeInternal(e)),r=Object(b.t)(this.getPage(e));i.childOffset=r.children.length,i.childCount=t.length;for(var n=0;n<t.length;n++){var a=this.makeRefNode(t[n],e);r.children.push(a)}}},{key:"getNode",value:function(e){var t=this.getNodeInternal(e);return Object(b.k)(t)?t.node:null}},{key:"getIndexById",value:function(e){var t;return this.forAllNodes((function(i,r){(Object(b.k)(i.node)&&i.node.id===e||Object(b.k)(i.ref)&&i.ref.id===e)&&(t=r)})),t}},{key:"getNodeById",value:function(e){var t=this.getIndexById(e);return t>=0?this.getNode(t):null}},{key:"getChildIndex",value:function(e,t){var i=this.getPage(e.index);if(Object(b.j)(i))return-1;var r=i.nodes[Y(e.index,this.nodesPerPage)];return i.children[r.childOffset+t]}},{key:"getParentIndex",value:function(e){var t=this.getPage(e);return Object(b.k)(t)?t.parents[Y(e,this.nodesPerPage)]:-1}},{key:"getParent",value:function(e){return(e=this.getParentIndex(e))>=0?this.getNode(e):null}},{key:"isLeaf",value:function(e){var t=this.getNodeInternal(e);return Object(b.k)(t)&&0===t.childCount}},{key:"rootNode",get:function(){return this.getNode(this.rootIndex)}},{key:"size",get:function(){return this.nodeCount}},{key:"invalidateVisibilityCache",value:function(){this._visibilityCacheVersion=H(this._visibilityCacheVersion)}},{key:"invalidateNodeVisibilityCache",value:function(e){var t=this.getNodeInternal(e);Object(b.k)(t)&&this.invalidateNodeVisibilityCacheInternal(t)}},{key:"invalidateNodeVisibilityCacheInternal",value:function(e){e.visibilityCache=B(this._visibilityCacheVersion)}},{key:"invalidateBoundingVolumeCache",value:function(e){var t=this.getNodeInternal(e);Object(b.k)(t)&&(Q(t),this.invalidateNodeVisibilityCacheInternal(t))}},{key:"invalidateGeometryVisibility",value:function(e){var t=this.getNodeInternal(e);Object(b.k)(t)&&Object(b.k)(t.node)&&(t.node.geometryObb=null,t.node.renderMbs[3]=-1,Object(b.k)(t.node.serviceObbInRenderSR)&&(t.node.serviceObbInRenderSR.halfSize[0]=-1))}},{key:"invalidateVisibilityObbs",value:function(){var e=this;Object(b.j)(this.rootNode)||this.traverse(this.rootNode,(function(t){return t.visibilityObb=e._computeVisibilityObb(t),t.geometryObb=null,!0}))}},{key:"isNodeVisible",value:function(e){var t=this.getNodeInternal(e);if(Object(b.j)(t)||Object(b.k)(t.ref)&&!t.ref.mbs)return!0;if(!J(t.visibilityCache,this._visibilityCacheVersion)){var i=t.node,r=Object(b.k)(i)&&(Object(b.j)(t.ref)||Object(b.k)(i.visibilityObb))?i:Object(b.k)(t.ref)?t.ref:null;if(this._layerHasFilter&&this._computeNodeFiltering&&(Object(b.k)(i)||Object(b.k)(t.ref))&&2===t.filterImpact){var n=Object(b.k)(i)?i.mbs:Object(b.k)(t.ref)?t.ref.mbs:null;t.filterImpact=null!=n?this._computeNodeFiltering(n):0}var a=Object(b.k)(i)&&1===t.filterImpact,s=!(Object(b.k)(i)&&2===i.imModificationImpact)&&(!r||this.viewportQueries.isNodeVisible(r))&&!a;return t.visibilityCache=z(s,this._visibilityCacheVersion),s}return K(t.visibilityCache)}},{key:"isGeometryVisible",value:function(e){if(!this.isNodeVisible(e))return!1;var t=this.getNodeInternal(e);return!(Object(b.k)(t)&&Object(b.k)(t.node)&&Object(b.k)(t.node.geometryObb)&&(!this.layerHasModifications||4!==t.node.imModificationImpact))||this.viewportQueries.isGeometryVisible(t.node)}},{key:"_traverseCoverage",value:function(e,t,i,r,n){var a=this.getPage(e);if(!Object(b.j)(a)&&0!==t.childCount){for(var s=t.childOffset+t.childCount,o=new Array,u=t.childOffset;u<s;++u){var c=a.children[u],l=this.getNodeInternal(c);Object(b.k)(l)&&Object(b.k)(l.node)&&this.isGeometryVisible(c)&&o.push(l)}r/=o.length;for(var d=0,h=o;d<h.length;d++){var f=h[d],p=Object(b.t)(f.node).index;this._isLoaded(p)||this._isReloading(p)?(n.delta=Math.max(n.delta,i),n.coverage+=r):this._traverseCoverage(p,f,i+1,r,n)}}}},{key:"useNodeAsHole",value:function(e){if("off"===this.holeFilling)return!1;var t=this.getNodeInternal(e);if(Object(b.j)(t))return!1;if("always"===this.holeFilling)return!0;if(J(t.useAsHole,this._version))return K(t.useAsHole);var i={delta:0,coverage:0};this._traverseCoverage(e,t,0,1,i);var r=i.delta*i.coverage<=.5;return t.useAsHole=z(r,this._version),r}},{key:"maxLevel",get:function(){return this._maxLevel}},{key:"dirty",get:function(){return this._dirty}},{key:"destroy",value:function(){this._updates.add.prune(),this._updates.update.prune()}},{key:"requestUpdate",value:function(){this._dirty=!0,this._indexMissing=1,this._version=H(this._version)}},{key:"imModificationsChanged",value:function(e){var t=this;this.layerHasModifications=e,this.forAllNodes((function(e){var i=e.node;Object(b.k)(i)&&(i.imModificationImpact=4,i.visibilityObb=t._computeVisibilityObb(i),i.hasModifications&&t.invalidateGeometryVisibility(i.index))})),this.invalidateVisibilityCache()}},{key:"layerFilterChanged",value:function(e){var t=this;this._layerHasFilter=e,this.forAllNodes((function(e){if(Object(b.k)(e)){e.filterImpact=2;var i=e.node;Object(b.k)(i)&&t.invalidateNodeVisibilityCache(i.index)}})),this.invalidateVisibilityCache()}},{key:"update",value:function(e,t,i){var r=this;if(this._dirty){this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missing.clear(),this._prefetch.clear(),this._updates.reset(e,this._missing),U.clear();var n=!0,a=new X,s=new X,o=this._imModificationUncategorized;o.clear();var u=new Set;this.traverseVisible((function(c,l,d){if(Object(b.j)(l)){var h=r.entryPriority(c);h===1/0&&(h=r.entryPriority(d));var f=W(c,r.nodesPerPage);return U.set(f,Math.max(h,U.get(f)||0)),r._loading.has(f)||r._failedPages.has(f)||r._missing.push(f),void(r._maxProcessingPrio=Math.max(r._maxProcessingPrio,h))}var p=l.node;if(r._updateNodeFeatureEstimate(p,s),Object(b.j)(p)){var v=r.entryPriority(c);return r._loading.has(c)||r._failedNodes.has(c)||(r._missing.push(c),U.set(c,v)),void(r._maxProcessingPrio=Math.max(r._maxProcessingPrio,v))}var y=Object(b.t)(r.getPage(c));if(0===r._missing.length&&0===r.nodesPerPage)for(var g=0;g<l.childCount;g++){var m=y.children[l.childOffset+g],O=r.getNodeInternal(m);!Object(b.k)(O)||O.node||r._loading.has(m)||r._failedNodes.has(m)||(U.set(m,r.entryPriority(m)),r._prefetch.push(m))}if(!p.failed&&p.resources.hasFeatureData)if(u.add(p.id),r._isLoaded(c)){if(a.known+=p.memory,++a.knownNodes,r._isSelected(p)?l.childCount>0&&(n=!1):(a.unremoved+=p.memory,n=!1),r._needsUpdate(p)){var _=r.entryPriority(c);U.set(c,_),r._maxProcessingPrio=Math.max(r._maxProcessingPrio,_),r._updates.update.push(c)}}else if(p.memory&&(a.known+=p.memory,++a.knownNodes),r._isSelected(p)){if(l.childCount>0&&(n=!1),p.memory?(a.missing+=p.memory,a.known+=p.memory,++a.knownNodes):++a.missingNodes,e.indexOf(p.index)>=0)return r._maxProcessingPrio=Math.max(r._maxProcessingPrio,r.entryPriority(c)),void(r._updates.cancel=r._updates.cancel.filter((function(e){return e!==p.index})));if(t.done||!r._enable(p)){var j=r.entryPriority(c);U.set(c,j),r._maxProcessingPrio=Math.max(r._maxProcessingPrio,j),r._updates.add.push(c),r.layerHasModifications&&i&&Object(b.k)(p)&&4===p.imModificationImpact&&o.push(c)}else t.madeProgress()}else r._isReloading(c)&&r._updates.remove.push(c)}));var c=this._updates.add;c.length>0&&this.layerHasModifications&&(o.length>0&&i(o),c.filterInPlace((function(e){var t=r.getNodeInternal(e),i=Object(b.j)(t)||Object(b.j)(t.node)||2!==t.node.imModificationImpact;return i||r.invalidateNodeVisibilityCache(e),i}))),this._unloadedMemoryEstimate=a.missing-a.unremoved,a.knownNodes>3&&a.missingNodes>0&&(this._unloadedMemoryEstimate+=a.known/a.knownNodes*a.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(s),this._featureEstimate.leavesReached=n,this._missing.sort((function(e,t){return e-t})),this._missing.filterInPlace((function(e,t){return t<1||r._missing.data[t-1]!==e})),this._missing.sort((function(e,t){return U.get(e)-U.get(t)})),this._missing.length>0&&(this._maxUnloadedPrio=U.get(this._missing.back()),this._prefetch.clear()),this._updates.add.filterInPlace((function(e){return U.get(e)>=r._maxUnloadedPrio})).sort((function(e,t){return U.get(e)-U.get(t)})),this._updates.update.sort((function(e,t){return U.get(e)-U.get(t)})),this._indexMissing=this._loading.size+this._missing.length,this._dirty=this._indexMissing>0,U.clear()}}},{key:"checkFeatureTarget",value:function(e,t){for(var i=this.viewportQueries.updateScreenSpaceErrorBias(t),r=t,n=t,a=i,s=10;s--;){var o=new X;if(this._updateFeatureEstimate(r,o),this._computeFeatureEstimate(o)<=e){if(r>=t||o.missingNodes>0||0===s)break;a=r,r=.5*(r+n)}else n=r,r=.5*(r+a)}return this._version=H(this._version),this.viewportQueries.updateScreenSpaceErrorBias(i),Math.min(t,r)}},{key:"_updateFeatureEstimate",value:function(e,t){var i=this;this._version=H(this._version),this.viewportQueries.updateScreenSpaceErrorBias(e),this.traverseVisible((function(e,r){return i._updateNodeFeatureEstimate(Object(b.k)(r)&&r.node,t)}))}},{key:"_updateNodeFeatureEstimate",value:function(e,t){if(!(Object(b.j)(e)||e.failed||Object(b.j)(e.numFeatures)))return this._isLoaded(e.index)?(t.known+=e.numFeatures,++t.knownNodes,void(this._isSelected(e)||(t.unremoved+=e.numFeatures))):void(this._isSelected(e)&&(Object(b.k)(e.numFeatures)?(t.missing+=e.numFeatures,t.known+=e.numFeatures,++t.knownNodes):++t.missingNodes))}},{key:"_computeFeatureEstimate",value:function(e){var t=e.known-e.unremoved;return e.knownNodes>3&&e.missingNodes>0&&(t+=e.known/e.knownNodes*e.missingNodes),Math.max(0,t)}},{key:"load",value:function(){return this._load(this._missing)}},{key:"prefetch",value:function(){return this._prefetch.sort((function(e,t){return U.get(e)-U.get(t)})),this._load(this._prefetch)}},{key:"_load",value:function(e){if(0===e.length||!this._canRequest())return!1;for(;e.length>0&&this._canRequest();)0===this.nodesPerPage?this._loadNode(e.pop()):this.loadPage(e.pop());return!0}},{key:"isLoading",value:function(){return this._indexMissing>0}},{key:"getIndexLoading",value:function(){return this._loading.size}},{key:"getIndexMissing",value:function(){return this._indexMissing}},{key:"getUnloadedMemoryEstimate",value:function(){return this._unloadedMemoryEstimate}},{key:"updates",get:function(){return this._updates}},{key:"featureEstimate",get:function(){return this._featureEstimate}},{key:"nodeTraversalState",value:function(e){if(Object(b.j)(e))return null;var t=this._nodeTraversalState.get(e.index);if(t&&J(t.version,this._version))return t;var i=this.viewportQueries.getLodLevel(e),r=this.viewportQueries.hasLOD(e),n=!0;if(r){var a=this.getParentIndex(e.index);if(a>=0){var s=this._nodeTraversalState.get(a);n=s&&i>s.lodLevel}else n=i>0}else n=0===e.childCount;return t?(t.lodLevel=i,t.isChosen=n,t.version=z(!0,this._version),t):(t=new L(r,n,i,z(!0,this._version)),this._nodeTraversalState.set(e.index,t),t)}},{key:"_loadNode",value:function(e){var t=this;this._loading.add(e);var i=Object(b.t)(this.getNodeInternal(e)).ref;if(Object(b.j)(i))this._failedNodes.add(e);else{var r=i.id,n=this.urlPrefix+r,a=function(){t._loading.delete(e),0===t._missing.length&&0===t._loading.size&&t.requestUpdate()};this.streamDataController.request(n,"json").then((function(i){a();var n=t._validateNode(r,i);if(null!=n){n.obb&&t.invalidateNodeVisibilityCache(e);var s=t.addNode(n,e);t.nodeTraversalState(s)}}),(function(i){a(),Object(y.n)(i)||(t.logger.error("#loadNode()",t.logLayer,"Error loading node: "+n),t._failedNodes.add(e))}))}}},{key:"_validateNode",value:function(e,t){var i=this;if(null==t||"object"!=typeof t||t.id!==e)return this.logger.error("#validateNode()",this.logLayer,'Invalid node. Wrong type or wrong id "'.concat(e,'"')),null;if(!Array.isArray(t.mbs))return this.logger.error("#validateNode()",this.logLayer,"Invalid bounding volume on node ".concat(e,".")),null;t.sharedResource&&"./shared"!==t.sharedResource.href&&"./shared/"!==t.sharedResource.href&&this.logger.warn("#validateNode()",this.logLayer,'Invalid shared resource href on node "'.concat(e,'"')),null==t.geometryData||Array.isArray(t.geometryData)&&1===t.geometryData.length&&"./geometries/0"===t.geometryData[0].href||this.logger.warn("#validateNode()",this.logLayer,'Invalid geometry data on node "'.concat(e,'"')),null==t.attributeData||Array.isArray(t.attributeData)&&!t.attributeData.some((function(e,t){return e.href!=="./attributes/f_".concat(t,"/0")}))||this.logger.warn("#validateNode()",this.logLayer,'Invalid attribute data on node "'.concat(e,'"')),t.featureData&&t.featureData.length>1&&this.logger.warn("#validateNode()",this.logLayer,"Node ".concat(e," has ").concat(t.featureData.length," bundles. Only the first bundle will be loaded."));var r=t.hasOwnProperty("obb")&&!this.ignoreServiceObb?t.obb:null,n=t.featureData&&1===t.featureData.length&&t.featureData[0].featureRange?t.featureData[0].featureRange[1]-t.featureData[0].featureRange[0]+1:null,a=Array.isArray(t.children)?t.children.map((function(t){if(null==t)return null;var r=function(t){return i.logger.error("#validateNode()",i.logLayer,"Invalid node reference on node ".concat(e,": ").concat(t))};if("number"==typeof t.id)r("id ".concat(t.id," is a number instead of a string."));else if("string"!=typeof t.id||!Array.isArray(t.mbs))return r("Missing or invalid id."),null;if(!Array.isArray(t.mbs))return r("Invalid bounding volume on reference ".concat(t.id,".")),null;t.href&&t.href!=="../"+t.id&&i.logger.error("#validateNode()",i.logLayer,'Invalid node href on node "'.concat(e,'"'));var n=t.hasOwnProperty("obb")&&!i.ignoreServiceObb?t.obb:null,a=new P("".concat(t.id),t.mbs);return a.serviceObb=n,a.visibilityObb=i._computeVisibilityObb(a),a})).filter((function(e){return null!=e})):null;return{id:e,mbs:t.mbs,obb:r,children:a,resources:{hasFeatureData:t.featureData&&t.featureData.length>0,hasSharedResource:null!=t.sharedResource,attributes:t.attributeData?e:null,texture:t.textureData&&t.textureData.length>0?e:null,geometry:null!=t.geometryData?e:null},version:"string"==typeof t.version?t.version:null,lodSelection:Array.isArray(t.lodSelection)?t.lodSelection:null,numFeatures:n}}},{key:"resetFailedNodes",value:function(){this._failedNodes.clear(),this._failedPages.clear(),this.forAllNodes((function(e){Object(b.k)(e.node)&&(e.node.failed=!1)}))}},{key:"entryPriority",value:function(e){var t=this.getNodeInternal(e),i=this.getParentIndex(e);if(Object(b.j)(t)||i<0&&null==t.node)return i<0?1/0:this.entryPriority(i);var r=0;if(t.node&&i>=0){var n=this._nodeTraversalState.get(i);null!=n&&(r=n.lodLevel)}for(var a=this.progressiveLoadPenalty,s=e;s>=0;s=this.getParentIndex(s))if(this._isLoaded(s)){a=0;break}var o=Object(b.k)(t.ref)?this.viewportQueries.distToPOI(t.ref):Object(b.k)(t.node)?this.viewportQueries.distToPOI(t.node):0;return-o-r*(o+this.progressiveLoadPenalty)+a}},{key:"traverseVisible",value:function(e){var t=this.getNodeInternal(this.rootIndex);Object(b.j)(t)?e(this.rootIndex,null,null):this._traverseVisible(this.rootIndex,-1,t,e)}},{key:"_traverseVisible",value:function(e,t,i,r){if(i.node&&0===i.childCount)this.isGeometryVisible(e)&&r(e,i,t);else if(this.isNodeVisible(e)&&(r(e,i,t),null!=i.node)){var n=this.nodeTraversalState(i.node);if(!n.nodeHasLOD||n.lodLevel!==this._maxLodLevel)for(var a=Object(b.t)(this.getPage(e)),s=0;s<i.childCount;s++){var o=a.children[i.childOffset+s],u=this.getNodeInternal(o);Object(b.k)(u)?this._traverseVisible(o,e,u,r):r(o,null,e)}}}},{key:"traverse",value:function(e,t){t(e)&&this.traverseChildren(e,t)}},{key:"traverseChildren",value:function(e,t){var i=e.index,r=this.getNodeInternal(i);Object(b.k)(r)&&this._traverseChildren(i,r,t)}},{key:"_traverseChildren",value:function(e,t,i){var r=this.getPage(e);if(!Object(b.j)(r))for(var n=t.childOffset+t.childCount,a=t.childOffset;a<n;++a){var s=r.children[a],o=this.getNodeInternal(s);Object(b.k)(o)&&Object(b.k)(o.node)&&i(o.node)&&this._traverseChildren(s,o,i)}}},{key:"updateStats",value:function(e){if(this._updates.add.length>0&&(e.nodes+=" + "+this._updates.add.length),(this._indexMissing||this._prefetch.length>0)&&(e.index+=" + "+this._indexMissing||!1),e.prio=this._maxProcessingPrio,this._featureEstimate.estimate){var t=this._featureEstimate.estimate-e.features;t>0?e.features+=" + "+t:t<0&&(e.features+=" - "+-t)}}},{key:"getPriority",value:function(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)}},{key:"updateElevationInfo",value:function(e){this.forAllNodes(Q),this.viewportQueries.updateElevationInfo(e)}},{key:"forAllNodes",value:function(e){for(var t=0;t<this._nodePages.length;t++){var i=this._nodePages[t];if(i)for(var r=t*this.nodesPerPage,n=0;n<i.nodes.length;n++)e(i.nodes[n],r+n)}}},{key:"test",get:function(){var e=this;return{addNode:function(t,i){return e.addNode(t,i)}}}}]),e}(),U=new Map,q=function(){function e(){Object(a.a)(this,e),this.update=new p.a({deallocator:null}),this.add=new p.a({deallocator:null}),this.remove=new p.a({deallocator:null}),this.cancel=[]}return Object(s.a)(e,[{key:"reset",value:function(e,t){this.add.clear(),this.update.clear(),this.cancel=e,this.missing=t}}]),e}();function Q(e){Object(b.k)(e.node)&&(e.node.renderMbs[3]=-1,Object(b.k)(e.node.serviceObbInRenderSR)&&(e.node.serviceObbInRenderSR.halfSize[0]=-1)),Object(b.k)(e.ref)&&(e.ref.renderMbs[3]=-1,Object(b.k)(e.ref.serviceObbInRenderSR)&&(e.ref.serviceObbInRenderSR.halfSize[0]=-1))}function B(e){return Object(M.a)(e,-2)}function H(e){return Object(M.a)(e,2)}function z(e,t){return t+(e?1:0)}function J(e,t){return(-2&e)===t}function K(e){return 1==(1&e)}function W(e,t){return 0===t?0:e/t|0}function Y(e,t){return 0===t?e:e%t}var Z=[["maxScreenThreshold",1],["screenSpaceRelative",2],["removedFeatureDiameter",3],["distanceRangeFromDefaultCamera",4]];var X=function e(){Object(a.a)(this,e),this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0};function $(e){return Math.sqrt(e*(4/Math.PI))}var ee=function(){function e(t){Object(a.a)(this,e),this.layerView=t,this._lodGlobalDirty=!1}return Object(s.a)(e,[{key:"startNodeLoading",value:function(e,t,i,r){this._maxLodLevel=r.maxLodLevel,this._index=i,this._isNodeInScaleBounds=e,this._removeNodes=t}},{key:"shouldLoadNode",value:function(e){if(Object(b.j)(e))return!1;var t=this._index.nodeTraversalState(e);return!!this.isChosenMaxLOD(t)||!!t.isChosen&&this._childrenRequireLoading(e)}},{key:"setLodGlobalDirty",value:function(){this._lodGlobalDirty=!0}},{key:"requiresLODGlobalHandling",get:function(){return null!=this._index&&!0===this._lodGlobalDirty}},{key:"lodGlobalHandling",value:function(e){if(!this.requiresLODGlobalHandling)return!1;this._lodGlobalDirty=!1;var t=this.layerView.view.resourceController.memoryController.usedMemory,i=Math.max(0,Math.floor(10*(t-1)));te.clear(),this._lodGlobalHandling(this._index.rootNode,i,!1);var r=te.length;this._removeNodes(te,e);var n=te.length<r;return 0!==te.length&&(this._lodGlobalDirty=!0),te.clear(),n}},{key:"_lodGlobalHandling",value:function(e,t,i){if(Object(b.j)(e))return!1;var r=e.index,n=this._index,a=this.layerView,s=n.nodeTraversalState(e),o=this.isChosenMaxLOD(s),u=a.isNodeLoaded(r),c=a.nodeCrossfadingEnabled;if(c&&u&&o){var l=!i&&this.hasNoVisibleChildren(e);a.fadeNode(r,0,!l)}var d=u&&(!a.isNodeFullyFadedIn||a.isNodeFullyFadedIn(r));if(u&&(a.updateNodeState(r,o?1:0),o))return d&&this._removeChildrenRecursive(e),d;var h=e.childCount>0,f=h;if(h)for(var p=0;p<e.childCount;p++){var v=n.getChildIndex(e,p),y=n.getNode(v);Object(b.k)(y)?n.isGeometryVisible(v)&&!this._lodGlobalHandling(y,t,i||d)&&this._isNodeInScaleBounds(y)&&(f=!1):n.isNodeVisible(v)&&(f=!1)}var g=u&&!o&&(f||te.length<t);g&&te.push(r),!c||g||!u||i||f||a.fadeNode(r,0,!1);var m=!e.resources.hasFeatureData;return f||d&&!g||m}},{key:"_removeChildrenRecursive",value:function(e){var t=this;this._index.traverseChildren(e,(function(e){return(t.layerView.isNodeLoaded(e.index)||t.layerView.isNodeReloading(e.index))&&te.push(e.index),!0}))}},{key:"hasNoVisibleChildren",value:function(e){var t=this,i=!0;return this._index.traverseChildren(e,(function(e){return!(!i||!t._index.isNodeVisible(e.index))&&(!t.layerView.isNodeLoaded(e.index)||(i=!1,!1))})),i}},{key:"_childrenRequireLoading",value:function(e){var t=this,i=!1,r=!0;return this._index.traverseChildren(e,(function(e){if(!r||!t._index.isNodeVisible(e.index))return!1;var n=t._index.nodeTraversalState(e);return t.isChosenMaxLOD(n)&&t._index.isGeometryVisible(e.index)&&(i=!0),!t.layerView.isNodeLoaded(e.index)||(r=!1,!1)})),r&&i}},{key:"isChosenMaxLOD",value:function(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)}}]),e}(),te=new p.a({deallocator:null}),ie=i(8),re=i.n(ie),ne=i(15),ae=i(134),se=i(26),oe=i(34),ue=i(1019),ce=i(998),le=function(){function e(t,i,r,n,s,o){if(Object(a.a)(this,e),this.streamDataController=i,this.logger=r,this.defaultGeometrySchema=n,this.requiredAttributes=s,this.options=o,this.logLayer=t,this.layerUrl=t.parsedUrl.path,this.geometryDefinitions=t.geometryDefinitions,t.materialDefinitions){var u=t.textureSetDefinitions;this.materialAndTextures=t.materialDefinitions.map((function(e){return Object(ce.c)(u,e)}))}}return Object(s.a)(e,[{key:"load",value:function(e,t,i){return this.streamDataController.request(e,t,i)}},{key:"loadAttribute",value:function(e,t,i){var r="".concat(this.layerUrl,"/nodes/").concat(e.resources.attributes,"/attributes/").concat(t.key,"/0");return this.load(r,"binary",i).then((function(e){return Object(ue.d)(t,e)}))}},{key:"loadAttributes",value:function(e,t,i){var r=this;return Object(y.k)(t.map((function(t){return r.loadAttribute(e,t.attributeStorageInfo,i)}))).then((function(i){for(var n={},a=0;a<t.length;++a)if(i[a].value)n[t[a].name]=i[a].value;else{if(Object(y.n)(i[a].error))throw i[a].error;r.logger.error("#loadAttributes",r.logLayer,"Failed to load attributeData for '".concat(t[a].name,"' on node '").concat(e.id,"'"),i[a].error)}return n}))}},{key:"loadNodeData",value:function(){var e=Object(ne.a)(re.a.mark((function e(t,i){var r,n,a,s,o,u,c,l,d,h,f,p,v,y,g,m,O,_,j,x,k,w;return re.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=null!=this.requiredAttributes&&t.resources.attributes?Object(ae.d)(this.loadAttributes(t,this.requiredAttributes,i)):null,n=be(this.geometryDefinitions,t),a=n.bufferDefinition,s=n.bufferIndex,o=!!t.resources.geometry,u=o?Object(ae.d)(this.loadGeometry(t.resources.geometry,s,i)):null,!t.resources.hasSharedResource){e.next=12;break}return e.next=9,this.loadShared(t,i);case 9:e.t0=e.sent,e.next=13;break;case 12:e.t0=null;case 13:if(c=e.t0,l=this.materialAndTextures&&t.resources.materialDefinition>=0?this.materialAndTextures[t.resources.materialDefinition]:null!=c?Object(ce.d)(c):null,d=l&&l.material,h=l&&l.textures,f="".concat(t.id),!(p=!o&&this.options.loadFeatureData)){e.next=25;break}return e.next=22,this.loadFeatureData(f,i);case 22:e.t1=e.sent,e.next=26;break;case 25:e.t1=null;case 26:if(v=e.t1,y=p?de(v):{featureIds:[],geometries:[{type:"ArrayBufferView",params:{material:d}}],featureDataPosition:[0,0,0]},g=Object(b.j)(y)&&he(v),m=null!=h&&h.length>0?Object(ae.d)(this.loadTextures(t,h,i)):null,O=null,_=null,!u){e.next=39;break}return e.t2=ae.a,e.next=35,u;case 35:e.t3=e.sent,O=(0,e.t2)(e.t3),j=fe(this.defaultGeometrySchema,c),_=Object(ue.a)(a,j);case 39:if(!m){e.next=47;break}return e.t5=ae.a,e.next=43,m;case 43:e.t6=e.sent,e.t4=(0,e.t5)(e.t6),e.next=48;break;case 47:e.t4=null;case 48:if(x=e.t4,!r){e.next=57;break}return e.t8=ae.a,e.next=53,r;case 53:e.t9=e.sent,e.t7=(0,e.t8)(e.t9),e.next=58;break;case 57:e.t7={};case 58:return k=e.t7,w=k?{attributeData:k,loadedAttributes:this.requiredAttributes}:null,e.abrupt("return",Object(b.k)(y)?{geometryData:y,attributeDataInfo:w,geometryBuffer:O,geometryDescriptor:_,requiredTextures:h,textureData:x}:Object(b.k)(g)?{pointData:g,attributeDataInfo:w,geometryBuffer:O,geometryDescriptor:_,requiredTextures:h,textureData:x}:Promise.reject());case 61:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"loadShared",value:function(t,i){var r="".concat(this.layerUrl,"/nodes/").concat(t.resources.geometry,"/shared");return this.load(r,"json",i).then((function(t){return e.fixTextureEncodings(t),e.addAbsoluteHrefTexture(t,r),t}))}},{key:"loadTexture",value:function(e,t,i,r,n,a){var s=!1;return 4===n||1===n||2===n?this.load(e,"binary",a).then((function(e){return{id:t,usage:i,data:e,encoding:n,downsampled:s}})):this.load(e,"image",a).then((function(e){var a=e;if(r&&e.width*e.height>=4096){var o=Math.ceil(e.width/2),u=Math.ceil(e.height/2),c=document.createElement("canvas");c.width=o,c.height=u,c.getContext("2d").drawImage(e,0,0,o,u),a=c,s=!0}return{id:t,usage:i,data:a,encoding:n,downsampled:s}}))}},{key:"loadTextures",value:function(e,t,i){var r=this,n=this.options.uncompressedTextureDownsamplingEnabled,a=this.options.textureUsageMask;return Promise.all(t.map((function(t){if(0==(t.usage&a))return null;var s=Object(ce.f)(t.encodings,r.options.textureEncodings);if(null==s)return r.logger.error("#loadTextures",r.logLayer,"No known encoding for texture found on node ".concat(e.id)),Promise.reject();var o=e.resources.texture||e.id,u="".concat(r.layerUrl,"/nodes/").concat(o,"/textures/").concat(s.name);return r.loadTexture(u,t.id,t.usage,n,s.encoding,i)})))}},{key:"loadFeatureData",value:function(e,t){var i="".concat(this.layerUrl,"/nodes/").concat(e,"/features/0");return this.load(i,"json",t)}},{key:"loadGeometry",value:function(e,t,i){var r="".concat(this.layerUrl,"/nodes/").concat(e,"/geometries/").concat(t);return this.load(r,"binary",i)}}],[{key:"addAbsoluteHrefTexture",value:function(e,t){var i=e.textureDefinitions;if(null!=i)for(var r=0,n=Object.keys(i);r<n.length;r++){var a,s=n[r],o=Object(C.a)(i[s].images);try{for(o.s();!(a=o.n()).done;){var u=a.value;Array.isArray(u.href)?u.hrefConcat=u.href.map((function(e){return Object(oe.A)(e,t)})):u.hrefConcat=Object(oe.A)(u.href,t)}}catch(c){o.e(c)}finally{o.f()}}}},{key:"fixTextureEncodings",value:function(e){var t=e.textureDefinitions;if(null!=t)for(var i in t){var r=t[i];if(Array.isArray(r.encoding))for(var n=0;n<r.encoding.length;n++){var a=r.encoding[n];"data:"===a.substring(0,5)&&(r.encoding[n]=a.substring(5))}else{var s=r.encoding;"data:"===s.substring(0,5)&&(r.encoding=s.substring(5))}}}}]),e}();function de(e){var t,i=Object(C.a)(e.featureData);try{for(i.s();!(t=i.n()).done;){var r=t.value,n=r.geometries;if(null!=n){var a,s=Object(C.a)(n);try{for(s.s();!(a=s.n()).done;){var o=a.value;return{featureIds:[r.id],featureDataPosition:r.position,geometries:[o]}}}catch(u){s.e(u)}finally{s.f()}}}}catch(u){i.e(u)}finally{i.f()}return null}function he(e){var t,i=new Array,r=Object(C.a)(e.featureData);try{for(r.s();!(t=r.n()).done;){var n=t.value;null!=n.position&&i.push({featureIds:[n.id],featureDataPosition:n.position,geometries:null})}}catch(a){r.e(a)}finally{r.f()}return i}function fe(e,t){if(!e||!t||!t.materialDefinitions)return e;var i=Object.keys(t.materialDefinitions)[0];return!t.materialDefinitions[i].params.vertexRegions&&e.vertexAttributes.region&&delete(e=Object(se.a)(e)).vertexAttributes.region,e}function be(e,t){var i={bufferDefinition:null,bufferIndex:0};if(null==e||t.resources.geometryDefinition<0)return i;var r=t.resources.geometryDefinition>=0?e[t.resources.geometryDefinition].geometryBuffers:null;if(null==r)return i;for(var n=0;n<r.length;n++){var a=r[n];if(null==a.compressedAttributes)i.bufferIndex=n,i.bufferDefinition=r[n];else if("draco"===a.compressedAttributes.encoding&&!Object(h.a)("disable-feature:i3s-draco"))return i.bufferIndex=n,i.bufferDefinition=a,i}return i}var pe=function(){function e(t,i){Object(a.a)(this,e),this.requester=t,this.apiKey=i,this.activeRequests=new Set}return Object(s.a)(e,[{key:"busy",get:function(){return this.requester.busy}},{key:"request",value:function(e,t,i){var r=this,n=Object(y.e)(),a=Object(y.t)(i,(function(){return n.abort()})),s={signal:n.signal,query:{token:this.apiKey}},o=this.requester.request(e,t,s),u={response:o,abortController:n,abortHandle:a};return this.activeRequests.add(u),Object(y.c)(o,(function(){var e;u.abortController=null,null==(e=u.abortHandle)||e.remove(),u.abortHandle=null,r.activeRequests.delete(u)})),o}},{key:"cancelAll",value:function(){this.activeRequests.forEach((function(e){var t,i;null==(t=e.abortController)||t.abort(),e.abortController=null,null==(i=e.abortHandle)||i.remove()})),this.activeRequests.clear()}}]),e}(),ve=i(11),ye=i(62),ge=i(72),me=i(138),Oe=i(76),_e=i(73),je=i(174),xe=i(274),ke=1e5,we=function(){function e(t,i,r,n,s,o,u){var c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:{};Object(a.a)(this,e),this.indexSR=t,this._renderCoordsHelper=i,this.extent=s,this.elevationProvider=o,this.options=c,this._frustum=Object(me.c)(),this._useFrustumCulling=!1,this._poi=Object(ve.e)(),this.minDistance=1/0,this.maxDistance=0,this.maxLodLevel=2,this._tmp1=Object(ve.e)(),this._tmp2=Object(ve.e)(),this._tmp3=Object(ve.e)(),this._tmp0=Object(ve.e)(),this.screenspaceErrorBias=c.screenspaceErrorBias||1,this.progressiveLoadFactor=c.progressiveLoadFactor||1,this.updateCamera(r,n),this.engineSR=this._renderCoordsHelper.spatialReference,this.updateElevationInfo(u),this.tmpPoint=Object(k.j)(0,0,0,t)}return Object(s.a)(e,[{key:"updateElevationInfo",value:function(e){null!=e?(this._elevationContext=je.a.fromElevationInfo(e),this._elevationContext.updateFeatureExpressionInfoContext(Object(xe.c)(Object(xe.f)(e,!1)))):this._elevationContext=null}},{key:"updateCamera",value:function(e,t){this._useFrustumCulling=t,t&&Object(me.e)(e.viewMatrix,e.projectionMatrix,this._frustum),this._screenSizeFactor=1/(e.perScreenPixelRatio/2),this._camPos=e.eye,this.minDistance=1/0,this.maxDistance=0}},{key:"setPointOfInterest",value:function(e){this._poi=e}},{key:"updateScreenSpaceErrorBias",value:function(e){var t=this.screenspaceErrorBias;return this.screenspaceErrorBias=e,t}},{key:"updateExtent",value:function(e){this.extent=e}},{key:"getRenderMbs",value:function(e){var t=e.renderMbs;return t[3]<0&&(Object(ye.c)(t,e.mbs),this._elevationContext&&t[3]<ke&&(this.tmpPoint.x=t[0],this.tmpPoint.y=t[1],this.tmpPoint.z=t[2],t[2]=Object(_e.e)(this.tmpPoint,this.elevationProvider,this._elevationContext,this._renderCoordsHelper)),Object(_.p)(t,this.indexSR,t,this.engineSR)),t}},{key:"getVisibilityObb",value:function(e){if(Object(b.k)(e.visibilityObb))return e.visibilityObb;var t=e.serviceObb;return Object(b.j)(t)||t.halfSize[0]<0?void 0:(e.serviceObbInRenderSR=this._computeRenderObb(t,e.serviceObbInRenderSR,e.mbs[3]),e.serviceObbInRenderSR)}},{key:"_computeRenderObb",value:function(e,t,i){if(Object(b.j)(t)&&(t=Object(R.e)()),t.halfSize[0]<0){var r=0;this._elevationContext&&i<ke&&(this.tmpPoint.x=e.center[0],this.tmpPoint.y=e.center[1],this.tmpPoint.z=e.center[2],r=Object(_e.e)(this.tmpPoint,this.elevationProvider,this._elevationContext,this._renderCoordsHelper)-e.center[2]),Object(M.v)(e,this.indexSR,t,this.engineSR,r)}return t}},{key:"isNodeVisible",value:function(e){var t=this.getRenderMbs(e);if(!this.isMBSinExtent(t))return!1;if(!this._useFrustumCulling)return!0;var i=this.getVisibilityObb(e);return Object(b.k)(i)?Object(R.h)(i,this._frustum):Object(me.j)(this._frustum,Object(Oe.n)(t))}},{key:"isGeometryVisible",value:function(e){if(!this._useFrustumCulling)return!0;var t=e.geometryObb;return Object(b.k)(t)?Object(R.h)(t,this._frustum):this.isNodeVisible(e)}},{key:"isMBSinExtent",value:function(e){return!this.extent||0!==Object(M.s)(this.extent,e)}},{key:"screenSpaceDiameterMbs",value:function(e,t){var i=this.getRenderMbs(e),r=Math.sqrt(Object(F.n)(i,this._camPos)),n=r-i[3];return this._updateMinMaxDistance(r),n<0?.5*Number.MAX_VALUE:t/n*this._screenSizeFactor}},{key:"calcCameraDistance",value:function(e){return this.calcCameraDistanceToCenter(e)-this.getRenderMbs(e)[3]}},{key:"calcCameraDistanceToCenter",value:function(e){var t=this.getRenderMbs(e),i=Object(F.o)(t,this._camPos);return this._updateMinMaxDistance(i),i}},{key:"calcAngleDependentLoD",value:function(e){var t=this.getRenderMbs(e),i=t[3],r=(Math.abs(t[0]*(t[0]-this._camPos[0])+t[1]*(t[1]-this._camPos[1])+t[2]*(t[2]-this._camPos[2]))/Object(F.r)(t)+i)/Object(F.o)(t,this._camPos);return Math.min(1,r)}},{key:"hasLOD",value:function(e){return 0!==e.lodMetric}},{key:"getDistancePlanarMode",value:function(e,t){var i=e[0]-t[0],r=e[1]-t[1],n=e[2]-t[2],a=i*i+r*r,s=t[3];if(a<=s*s)return Math.abs(n);var o=Math.sqrt(a)-s;return Math.sqrt(n*n+o*o)}},{key:"getDistanceGlobeMode",value:function(e,t){var i=Object(F.r)(t),r=Object(F.r)(e)-i;Object(F.g)(this._tmp0,e,Object(F.j)(e,t)/Object(F.v)(e));var n=Object(F.n)(t,this._tmp0),a=t[3];if(n<=a*a)return Math.abs(r);var s=Object(F.g)(this._tmp0,t,1/i),o=i,u=a*a/2/o,c=Object(F.g)(this._tmp1,s,o-u),l=e,d=Object(F.l)(this._tmp2,l,c),h=Object(F.l)(this._tmp2,d,Object(F.g)(this._tmp3,s,Object(F.j)(s,d))),f=Object(F.h)(this._tmp2,c,Object(F.g)(this._tmp2,h,a/Object(F.r)(h))),b=Object(F.o)(l,f);if(r>=2e5){var p=Object(F.l)(this._tmp1,l,f),v=Object(F.j)(p,s)/Object(F.r)(p);v<.08&&(v=1e-4),b/=v}return b}},{key:"getDistance",value:function(e,t){return this.engineSR===Object(ge.g)(this.engineSR)?this.getDistanceGlobeMode(e,t):this.getDistancePlanarMode(e,t)}},{key:"_updateMinMaxDistance",value:function(e){e>0?(this.minDistance=Math.min(this.minDistance,e),this.maxDistance=Math.max(this.maxDistance,e)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-e))}},{key:"getLodLevel",value:function(e){if(0===e.lodMetric||!e.resources.hasFeatureData)return 0;if(0===e.childCount)return this.maxLodLevel;if(this._useFrustumCulling&&this.progressiveLoadFactor<1){var t=this.progressiveLoadFactor*this.screenspaceErrorBias,i=this.screenspaceErrorBias;return this.evaluateLODmetric(e,t)?this.evaluateLODmetric(e,i)?2:1:0}return this.evaluateLODmetric(e,this.screenspaceErrorBias)?this.maxLodLevel:0}},{key:"evaluateLODmetric",value:function(e,t){switch(e.lodMetric){case 2:var i=this.getRenderMbs(e),r=this.getDistance(this._camPos,i),n=2*r/this._screenSizeFactor,a=r+i[3];return this._updateMinMaxDistance(a),e.maxError*t<=n;case 1:var s=this.screenSpaceDiameterMbs(e,e.mbs[3]*t);return this.options.angleDependentLoD&&(s*=this.calcAngleDependentLoD(e)),s<e.maxError;case 3:return this.screenSpaceDiameterMbs(e,e.maxError)*t<10;case 4:return this.calcCameraDistance(e)>e.maxError*t}return!1}},{key:"distToPOI",value:function(e){var t=this.getRenderMbs(e);return Object(F.o)(t,this._poi)-t[3]}},{key:"distCameraToPOI",value:function(){return Object(F.o)(this._camPos,this._poi)}}]),e}(),Ce=i(546),Ie=i(661),Se=i(449),Ee=f.a.getLogger("esri.layers.graphics.controllers.I3SOnDemandController"),Ne=1e-4,De=function(e){Object(o.a)(i,e);var t=Object(u.a)(i);function i(e){var r;return Object(a.a)(this,i),(r=t.call(this,e)).screenSizeFactor=0,r.featureTarget=5e4,r.fixedFeatureTarget=!1,r.updating=!0,r.updatingProgress=1,r.leavesReached=!1,r.scaleVisibilityEnabled=!0,r._featureLOD=1,r._stableFeatureLOD=!1,r._isIdle=!1,r._cameraDirty=!0,r._invisibleDirty=!1,r._newLoadingNodes=new p.a({deallocator:null}),r._loadedNodeScales=new Map,r._modificationsNodeFilteringArray=new p.a,r._downloadingCount=0,r._loadingNodes=new Map,r._updatingNodes=new Map,r._progressMaxNumNodes=1,r._requiredAttributes=new Array,r._requiredAttributesDirty=!0,r._updatesDisabled=!1,r.disableIDBCache=!1,r._disableMemCache=!1,r._restartNodeLoading=!1,r._fields=null,r._attributeStorageInfo=null,r._handles=new d.a,r._idleQueue=new w.a,r._elevationUpdateNodes=new p.a({deallocator:null}),r._errorCount=0,r}return Object(s.a)(i,[{key:"isMeshPyramid",get:function(){return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store.lodType}},{key:"isGraphics3D",get:function(){return"points"===this.layer.profile}},{key:"indexStreamController",get:function(){var e=this.layerView.view.resourceController.createStreamDataRequester(2);return new pe(e,this.layer.apiKey)}},{key:"dataStreamController",get:function(){var e=this.layerView.view.resourceController.createStreamDataRequester(3);return new pe(e,this.layer.apiKey)}},{key:"crsVertex",get:function(){return Object(M.r)(this.layer)}},{key:"crsIndex",get:function(){return Object(M.p)(this.layer)}},{key:"rootNodeVisible",get:function(){if(Object(b.k)(this._index)){var e=this._index.rootNode;if(Object(b.k)(e))return this._updateViewData(),this._index.isNodeVisible(e.index)}return!0}},{key:"index",get:function(){return this._index}},{key:"initialize",value:function(){var e=this;this._disableMemCache=!this.layerView.loadCachedGPUData||!this.layerView.addCachedGPUData,this._lodHandling=new ee(this.layerView);var t=this.layerView.i3slayer;this.layer=t,this._defaultGeometrySchema=t.store.defaultGeometrySchema,this.disableIDBCache=Object(h.a)("disable-feature:idb-cache"),"fields"in t&&(this._fields=t.fields,this._attributeStorageInfo=t.attributeStorageInfo),this.addResolvingPromise(Promise.all([this.layer.indexInfo,this.layer.when(),this.layerView.when()]).then((function(i){var r,a=Object(n.a)(i,1)[0];if(!e.destroyed&&e.layerView&&!e.layerView.destroyed){var s=e.layerView.view;e._setClippingArea(s.clippingArea);var o=e.layerView.view.resourceController;e._handles.add([Object(g.a)(s,"pointsOfInterest.focus.renderLocation",(function(t){return e._pointOfInterestChanged(t)})),o.memoryController.events.on("quality-changed",(function(){return e._setCameraDirty()})),Object(g.a)(e.layerView,"suspended",(function(t){var i=t?function(){return e._updateViewData()}:function(){return e._updateIdleState(!0)},r=t?function(){}:function(){return e._updateIdleState(!1)};e._idleStateCallbacks?(t&&e.cancelNodeLoading(),e.restartNodeLoading(),e._idleStateCallbacks.idleBegin=i,e._idleStateCallbacks.idleEnd=r):e._idleStateCallbacks=o.scheduler.registerIdleStateCallbacks(i,r)})),D(e.layerView.view.resourceController.scheduler,{update:function(t,i){return e._frame(t,i)},needsUpdate:function(){return e.updating}}),e.watch("uncompressedTextureDownsamplingEnabled",(function(){return e.restartNodeLoading()})),e.watch(["featureTarget","fixedFeatureTarget"],(function(){e._setCameraDirty(),e._stableFeatureLOD=!1})),s.state.watch("contentCamera",(function(){return e._setCameraDirty()})),e.layer.watch("elevationInfo",(function(){return e._elevationInfoChanged()})),e.layer.watch(["minScale","maxScale"],(function(){return e._scaleBoundsChanged()})),e.layerView.watch("lodFactor",(function(){return e._setCameraDirty()})),e.layerView.watch("availableFields?",(function(){return e._requiredFieldsChange()})),e.layerView.watch("holeFilling",(function(t){return Object(b.k)(e._index)&&(e._index.holeFilling=t)}))]),e._updateScaleHandles(),e._viewportQueries=new we(e.crsIndex,s.renderCoordsHelper,s.state.contentCamera,!s.state.fixedContentCamera||e.isGraphics3D,e._clippingArea,s.elevationProvider,e.layer.elevationInfo,{progressiveLoadFactor:e._getProgressiveLoadFactor(),screenspaceErrorBias:e.lod,angleDependentLoD:e.lod<.5}),e._index=new G(t,a,e.indexStreamController,e._viewportQueries,Ee,e.layerView.holeFilling,(function(t){return e.layerView.isNodeLoaded(t)}),(function(t){return e.layerView.isNodeReloading(t)}),(function(t){return e._shouldLoadNode(t)}),(function(t){return e._enableFromGPUCache(t,1)}),(function(t){return e._needsUpdate(t)}),(function(){return!e.indexStreamController.busy}),(function(t){return e.layerView.computeVisibilityObb?e.layerView.computeVisibilityObb(t):null}),null!=(r=e.layerView)&&r.computeNodeFiltering?function(t){return e.layerView.computeNodeFiltering(t)}:void 0);var u=Object(b.k)(e.layer.modifications)&&e.layer.modifications&&e.layer.modifications.length>0;e._index.imModificationsChanged(u),e._startNodeLoading()}}))),this._tmpPoint=Object(k.j)(0,0,0,this.crsIndex)}},{key:"updateNodeModificationStatus",value:function(e){var t=this,i=this._index,r=this.layerView;Object(b.k)(i)&&r&&r.updateNodeModificationStatus&&(this._modificationsNodeFilteringArray.clear(),e.forAll((function(e){var r=i.getNode(e);Object(b.k)(r)&&t._modificationsNodeFilteringArray.push(r)})),r.updateNodeModificationStatus(this._modificationsNodeFilteringArray),this._invisibleDirty=!0)}},{key:"destroy",value:function(){this.cancelNodeLoading(),this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null),this._handles.destroy(),this._nodeLoader=null,Ve.prune(),Object(b.k)(Fe)&&(Fe.hide(),Fe=null)}},{key:"_getRequiredAttributes",value:function(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.availableFields)return[];var e=this._attributeStorageInfo,t=this._fields,i=this.layer.objectIdField;return this.layerView.availableFields.map((function(i){var r=Ae(e,i),n=Ae(t,i);return r>=0&&n>=0?{index:r,name:t[n].name,field:t[n],attributeStorageInfo:e[r]}:null})).filter((function(e){return null!=e&&e.name!==i}))}},{key:"_requiredFieldsChange",value:function(){var e=this._getRequiredAttributes();Pe(this._requiredAttributes,e)||(this._requiredAttributes=e,this._requiredAttributesDirty=!1,this.restartNodeLoading())}},{key:"requestUpdate",value:function(){this._requiredAttributesDirty=!0,this.restartNodeLoading()}},{key:"_setClippingArea",value:function(e){var t=Object(j.h)();Object(Ce.a)(e,t,this.layerView.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null}},{key:"_pointOfInterestChanged",value:function(e){Object(b.k)(this._viewportQueries)&&(this._viewportQueries.setPointOfInterest(e),Object(b.k)(this._index)&&(this._index.progressiveLoadPenalty=Le.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate()))}},{key:"updateClippingArea",value:function(e){this._setClippingArea(e),Object(b.k)(this._viewportQueries)&&Object(b.k)(this._index)&&(this._viewportQueries.updateExtent(this._clippingArea),this._index.invalidateVisibilityCache()),this._setCameraDirty()}},{key:"_setCameraDirty",value:function(){this._cameraDirty=!0,this.notifyChange("rootNodeVisible"),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}},{key:"updateElevationChanged",value:function(e,t){var i=this,r=this._index;if(!Object(b.j)(r)){var n=r.rootNode;if(!Object(b.j)(n)){var a=this._elevationUpdateNodes;a.clear(),Object(M.l)(e,t,n,this.crsIndex,r,(function(e){return a.push(e.index)})),a.forAll((function(e){r.invalidateBoundingVolumeCache(e),e===n.index&&i.notifyChange("rootNodeVisible")})),a.length&&this.restartNodeLoading()}}}},{key:"getParentIndex",value:function(e){return Object(b.k)(this._index)&&this._index.getParentIndex(e)}},{key:"_elevationInfoChanged",value:function(){Object(b.k)(this._index)&&this._index.updateElevationInfo(this.layer.elevationInfo),this._setCameraDirty()}},{key:"_updateScaleHandles",value:function(){var e=this,t="scale-bounds";this._handles.remove(t),this.areScaleBoundsActive&&this._handles.add(this.layerView.view.basemapTerrain.on("scale-change",(function(t){return e._scaleUpdateHandler(t)})),t)}},{key:"_scaleBoundsChanged",value:function(){this.areScaleBoundsActive||this._loadedNodeScales.clear(),this._updateScaleHandles(),this._setCameraDirty()}},{key:"_scaleUpdateHandler",value:function(e){this._updateScaleInBoundingRect(e.scale,e.extent,e.spatialReference),this._setCameraDirty()}},{key:"_updateScaleInBoundingRect",value:function(e,t,i){var r=this,n=this._index;if(!Object(b.j)(n)){var a=n.rootNode;!Object(b.j)(a)&&Object(_.o)(t,i,Me,this.crsIndex)&&this._loadedNodeScales.forEach((function(t,i){var a=n.getNode(i);Object(b.k)(a)&&Object(x.h)(Me,a.mbs)&&r._loadedNodeScales.set(i,e)}))}}},{key:"restartNodeLoading",value:function(){this._restartNodeLoading=!0,this.cancelNodeLoading(),this._evaluateUpdating()}},{key:"schedule",value:function(e,t){return this._idleQueue.push(e,t)}},{key:"reschedule",value:function(e,t){return this._idleQueue.unshift(e,t)}},{key:"isIntegratedMesh",get:function(){return"integrated-mesh"===this.layer.type}},{key:"areScaleBoundsActive",get:function(){var e=Object(Se.a)(this.layer),t=e.minScale,i=e.maxScale;return this.scaleVisibilityEnabled&&(t>0||i>0)}},{key:"unloadedMemoryEstimate",get:function(){return Object(b.j)(this._index)||this.layerView.suspended?0:this._index.getUnloadedMemoryEstimate()*this.lodDropFactor}},{key:"indexDepth",get:function(){return Object(b.k)(this._index)?this._index.maxLevel:0}},{key:"disableMemCache",set:function(e){this.layerView.loadCachedGPUData&&this.layerView.addCachedGPUData||(this._disableMemCache=!0),this._disableMemCache=e}},{key:"_frame",value:function(e,t){return this.layerView.suspended?(this._updateViewData(),this._evaluateUpdating(),-1/0):!this.layerView.visible||Object(b.j)(this._index)?-1/0:(this._processLogError(e,t),this._index.getPriority())}},{key:"_processLogError",value:function(e,t){try{this._process(e,t)}catch(i){this._errorCount<50?Ee.error("Error during processing: "+i):50===this._errorCount&&Ee.error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}}},{key:"_process",value:function(e,t){var i=this;if(this._restartNodeLoading&&this._startNodeLoading(),null!=this._nodeLoader&&!Object(b.j)(this._index)){for(this._updateViewData(),this._invisibleDirty&&this._removeInvisibleNodes(e)&&(this._invisibleDirty=!1),this.isIntegratedMesh&&(e.enabled=!1),e.run((function(){return i._processIndex(e)})),this._updateFeatureLOD(),e.run((function(){return i._processCache(e)})),this.isIntegratedMesh&&(e.enabled=!0),e.run((function(){return i._processNodes(e,t)}));!e.done&&this._idleQueue.process();)e.madeProgress();e.run((function(){return i._prefetchIndex()})),t.numIndexLoading+=this._index.getIndexLoading(),t.numNodesLoading+=this._downloadingCount,e.run((function(){return i._lodHandling.lodGlobalHandling(e)})),this._evaluateUpdating()}}},{key:"_processIndex",value:function(e){var t=this;if(Object(b.j)(this._index))return!1;if(this._index.dirty){this._newLoadingNodes.clear(),this._index.update(Object(r.a)(this._loadingNodes.keys()),e,(function(e){return t.updateNodeModificationStatus(e)})),this._disableMemCache||(this._newLoadingNodes.pushArray(this._index.updates.add.data,this._index.updates.add.length),this._newLoadingNodes.pushArray(this._index.updates.missing.data,this._index.updates.missing.length));var i=this._index.featureEstimate.leavesReached;this._index.isLoading()||i===this._get("leavesReached")||this._set("leavesReached",i)}return this._index.load()}},{key:"_prefetchIndex",value:function(){return!(Object(b.j)(this._index)||this._loadingNodes.size>0||this._index.updates.add.length>0)&&this._index.prefetch()}},{key:"_updateFeatureLOD",value:function(){if(this.isGraphics3D&&!Object(b.j)(this._index)&&!Object(b.j)(this._viewportQueries)){var e=!this._index.isLoading(),t=this.featureTarget*this.baseLOD,i=this._index.featureEstimate;if(i.estimate=i.estimate||t/2,this._index.getIndexMissing()>500){if(this._featureLOD<=Ne)return;this._featureLOD/=1.5,this._stableFeatureLOD=!1}else if(e&&i.estimate<t){if(i.leavesReached||this._featureLOD>=1e4||this._stableFeatureLOD)return;var r=Math.min(10,Math.max(t/i.estimate,1.001));this._featureLOD*=r;var n=this.lod,a=this._index.checkFeatureTarget(t,n);a!==n&&(this._featureLOD=a/this.baseLOD,this._stableFeatureLOD=!0)}else{if(!(i.estimate>1.2*t||e&&i.estimate>t))return;if(this._featureLOD<=Ne)return;this._featureLOD/=1+.25*(i.estimate/t-1),this._stableFeatureLOD=!1}this._featureLOD=Math.min(1e4,Math.max(Ne,this._featureLOD)),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.requestUpdate()}}},{key:"_processCache",value:function(e){var t=this._index;if(Object(b.j)(t))return!1;for(;this._newLoadingNodes.length>0&&!e.done;)for(var i=this._newLoadingNodes.pop(),r=t.getParent(i);Object(b.k)(r)&&!this.layerView.isNodeLoaded(r.index)&&this._isNodeInScaleBounds(r);r=t.getParent(r.index))if(this._enableFromGPUCache(r,0)){e.madeProgress();break}return e.hasProgressed}},{key:"_processNodes",value:function(e,t){if(Object(b.j)(this._index))return!1;var i=(this._isIdle?100:2)-this._loadingNodes.size,r=this._index.updates;for(r.cancel.forEach(this._cancelNode,this),r.cancel=[];r.remove.length>0&&!e.done;)this.layerView.removeNode(r.remove.pop()),e.madeProgress();for(;r.update.length>0&&!e.done;){var n=this._index.getNode(r.update.pop());Object(b.k)(n)&&(this._updateLoadedNode(n),e.madeProgress())}for(;r.add.length>0&&!e.done&&i>0;){--i;var a=this._index.getNode(r.add.back());if(Object(b.j)(a)||2!==a.cacheState&&!this._hasNodeLoadToken(t))break;r.add.pop(),this._loadNode(a),e.madeProgress()}return e.hasProgressed}},{key:"_cancelAllNodes",value:function(){this._loadingNodes.forEach((function(e){return e.abort()})),this._loadingNodes.clear(),this._updatingNodes.forEach((function(e){return e.abort()})),this._updatingNodes.clear()}},{key:"_cancelNode",value:function(e){var t=this._loadingNodes.get(e);t&&(t.abort(),this._loadingNodes.delete(e))}},{key:"_hasNodeLoadToken",value:function(e){return!(!this._isIdle&&e.numNodesLoading+this._loadingNodes.size>=2)&&this._downloadingCount<Ie.b&&!this.dataStreamController.busy}},{key:"_evaluateUpdating",value:function(){var e=!1,t=0;if(this.layerView.suspended)t=(e=this._cameraDirty)?0:1;else{var i=(Object(b.k)(this._index)?this._index.getIndexMissing():0)+3*(Object(b.k)(this._index)?this._index.updates.add.length:0)+2*this._loadingNodes.size;e=!!(i>0||this._updatingNodes.size>0||this._restartNodeLoading||this._cameraDirty||this._idleQueue.length>0||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling),0===i&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(i,this._progressMaxNumNodes),t=1-i/this._progressMaxNumNodes}this.updating=e,this.updatingProgress=t}},{key:"_updateViewData",value:function(){if(this._cameraDirty&&!Object(b.j)(this._index)&&!Object(b.j)(this._viewportQueries)){var e=this.layerView.view,t=e.state,i=t.contentCamera,r=t.fixedContentCamera;this.screenSizeFactor=1/(i.perScreenPixelRatio/2),this._viewportQueries.updateCamera(i,!r||this.isGraphics3D),this._viewportQueries.setPointOfInterest(e.pointsOfInterest.focus.renderLocation),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.invalidateVisibilityCache(),this._index.progressiveLoadPenalty=Le.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate(),this._stableFeatureLOD=!1,this._invisibleDirty=!0,this._cameraDirty=!1,this.notifyChange("rootNodeVisible")}}},{key:"_getProgressiveLoadFactor",value:function(){return this.layerView.view.resourceController.memoryController.memoryFactor<1?1:this.layerView.progressiveLoadFactor}},{key:"lod",get:function(){return this._featureLOD*this.baseLOD}},{key:"baseLOD",get:function(){var e=this.layerView.lodFactor,t=this.layerView.view.resourceController.memoryController.memoryFactor;return this.fixedFeatureTarget?1:(e>0?e:1)*t}},{key:"lodDropFactor",get:function(){if(this.fixedFeatureTarget)return 1;var e=this.layerView.view.resourceController.memoryController;return(Math.min(e.memoryFactor,.5)-e.minQuality)/(.5-e.minQuality)}},{key:"isGeometryVisible",value:function(e){return Object(b.k)(this._index)&&this._index.isGeometryVisible(e.index)}},{key:"updateVisibility",value:function(e){Object(b.k)(this._index)&&this._index.invalidateNodeVisibilityCache(e)}},{key:"updateBoundingVolume",value:function(e){Object(b.k)(this._index)&&this._index.invalidateBoundingVolumeCache(e)}},{key:"invalidateGeometryVisibility",value:function(e){Object(b.k)(this._index)&&this._index.invalidateGeometryVisibility(e)}},{key:"invalidateVisibilityObbs",value:function(){Object(b.k)(this._index)&&this._index.invalidateVisibilityObbs()}},{key:"modificationsChanged",value:function(){if(Object(b.k)(this._index)){var e=Object(b.k)(this.layer.modifications)&&this.layer.modifications&&this.layer.modifications.length>0;this._index.imModificationsChanged(e)}this._invisibleDirty=!0}},{key:"_shouldLoadNode",value:function(e){return!(!this._lodHandling.shouldLoadNode(e)||this._shouldDropNode(e)||!this._isNodeInScaleBounds(e))&&!!Object(b.k)(this._index)&&this._index.isGeometryVisible(e.index)}},{key:"_shouldDropNode",value:function(e){if(Object(b.j)(this._viewportQueries))return!1;var t=this.lodDropFactor;return!(t>=1||!this._lodHandling.hasNoVisibleChildren(e))&&Math.abs(this._viewportQueries.calcCameraDistanceToCenter(e))-this._viewportQueries.minDistance>(this._viewportQueries.maxDistance-this._viewportQueries.minDistance)*t}},{key:"_startNodeLoading",value:function(){var e=this;this._restartNodeLoading=!1;var t=this._index;if(!(this._updatesDisabled||Object(b.j)(t)||Object(b.j)(this._viewportQueries))){this._updateViewData(),this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1);var i={textureEncodings:this.layerView.supportedTextureEncodings,uncompressedTextureDownsamplingEnabled:this.layerView.uncompressedTextureDownsamplingEnabled,textureUsageMask:this.layerView.rendererTextureUsage,loadFeatureData:!this.isMeshPyramid};this._nodeLoader=new le(this.layer,this.dataStreamController,Ee,this._defaultGeometrySchema,this._requiredAttributes,i),t.requestUpdate(),this._lodHandling.startNodeLoading((function(t){return e._isNodeInScaleBounds(t)}),(function(t,i){return e._removeNodes(t,i,1)}),t,{maxLodLevel:this._viewportQueries.maxLodLevel}),this._evaluateUpdating()}}},{key:"isNodeLoading",value:function(){return null!=this._nodeLoader&&null!=this._index}},{key:"cancelNodeLoading",value:function(){this.isNodeLoading()&&(this.indexStreamController.cancelAll(),this.dataStreamController.cancelAll(),this._idleQueue.cancelAll(),this._cancelAllNodes(),this._nodeLoader=null,this._evaluateUpdating())}},{key:"_removeInvisibleNodes",value:function(e){var t=this,i=this._index;if(Object(b.j)(i)||Object(b.j)(this._viewportQueries))return!1;Ve.clear(),this.layerView.getLoadedNodeIndices(Ve);var r=0===this._viewportQueries.maxDistance,n=r?function(){return!1}:function(e){return t._shouldDropNode(e)};return Ve.filterInPlace((function(e){var r=i.getNode(e);return Object(b.j)(r)||!i.isGeometryVisible(e)||n(r)||!t._isNodeInScaleBounds(r)})),Ve.length>0&&this._lodHandling.setLodGlobalDirty(),this._removeNodes(Ve,e,0),!(r&&this.lodDropFactor<1)&&(0===Ve.length||(Ve.clear(),!1))}},{key:"markNodeToRemove",value:function(e){Ve.push(e)}},{key:"removeMarkedNodes",value:function(){this._removeNodes(Ve,S.d,0)}},{key:"_removeNodes",value:function(e,t,i){var r=e.length;if(0!==r&&!t.done){for(Object(b.k)(this._index)&&this._index.requestUpdate();e.length>0&&!t.done;){var n=e.pop(),a=this._index;1===i&&this.layerView.nodeFadeoutEnabled&&Object(b.k)(a)&&a.isGeometryVisible(n)?this.layerView.fadeNode(n,1,!0):this.layerView.removeNode(n),t.madeProgress()}if(this._loadedNodeScales.size>0)for(var s=e.length;s<r;s++){var o=e.data[s];this._loadedNodeScales.delete(o)}}}},{key:"_needsUpdate",value:function(e){if(!e.resources.hasFeatureData||this._updatingNodes.has(e.index))return!1;var t=this.layerView.getLoadedAttributes(e.index);return null!=t&&t!==this._requiredAttributes}},{key:"_updateLoadedNode",value:function(e){var t=this,i=Object(y.e)();this._updatingNodes.set(e.index,i),(Pe(this.layerView.getLoadedAttributes(e.index),this._requiredAttributes)?Promise.resolve(this.layerView.getAttributeData(e.index)):this._nodeLoader.loadAttributes(e,this._requiredAttributes,i.signal)).then((function(r){return t.schedule((function(){return t.layerView.updateAttributes(e.index,{loadedAttributes:t._requiredAttributes,attributeData:r},i.signal)}),i.signal)})).catch((function(r){if(!Object(y.n)(r))return t.layerView.updateAttributes(e.index,{loadedAttributes:t._requiredAttributes,attributeData:{}},i.signal)})).catch((function(){})).then((function(){t._updatingNodes.delete(e.index),t._evaluateUpdating()})),this._evaluateUpdating()}},{key:"_loadNode",value:function(e){var t=this;if(this._loadingNodes.has(e.index))Ee.error("already loading node "+e.index);else{var i=Object(y.e)();this._loadingNodes.set(e.index,i);var r=function(){t._loadingNodes.get(e.index)===i&&t._loadingNodes.delete(e.index),t._evaluateUpdating()};this._evaluateUpdating(),this._loadAndAddNode(e,i.signal).then(r).catch((function(e){if(r(),!Object(y.n)(e))throw e}))}}},{key:"_loadAndAddNode",value:function(e,t){var i=this;return 1===e.cacheState?this._loadUncached(e,t):this._loadCached(e,t).then((function(t){t||(e.cacheState=1,Object(b.k)(i._index)&&i._index.updates.add.push(e.index))})).catch((function(t){if(!Object(y.n)(t))throw e.cacheState=1,t}))}},{key:"_enableFromGPUCache",value:function(e,t){if(this._disableMemCache||Object(b.j)(this._index))return!1;if(0===t&&!this._index.useNodeAsHole(e.index))return!0;var i=this._loadCachedGPUData(e);return!!i&&(this.layerView.addCachedGPUData(e,i,t),this._nodeAdded(),!0)}},{key:"_loadCachedGPUData",value:function(e){var t=this.layerView.loadCachedGPUData(e);return Object(b.k)(t)&&Object(b.k)(t.attributeInfo)&&Pe(t.attributeInfo.loadedAttributes,this._requiredAttributes)?t:(this.layerView.deleteCachedGPUData(t),null)}},{key:"_nodeAdded",value:function(){Object(b.k)(this._index)&&this._index.requestUpdate(),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}},{key:"_loadCached",value:function(e,t){var i=this;if(this._enableFromGPUCache(e,1))return Promise.resolve(!0);var r=this.layerView;return!this.disableIDBCache&&r.loadCachedNodeData&&r.addCachedNodeData?this.schedule((function(){return r.loadCachedNodeData(e,t,(function(t,r){return i._nodeLoader.loadTextures(e,t,r)}))}),t).then((function(n){if(Object(b.j)(n))return!1;var a=i._requiredAttributes;return i.reschedule((function(){return i._nodeLoader.loadAttributes(e,a,t)}),t).then((function(s){return i.reschedule((function(){return r.addCachedNodeData(e,n,{loadedAttributes:a,attributeData:s},t)}),t)})).then((function(){return i._nodeAdded(),!0}))})):Promise.resolve(!1)}},{key:"_loadUncached",value:function(e,t){var i=this;return this._downloadingCount++,this._nodeLoader.loadNodeData(e,t).catch((function(e){throw i._downloadingCount--,e})).then((function(r){return i._downloadingCount--,i.schedule((function(){return i.layerView.addNode(e,r,t)}),t)})).then((function(){i._nodeAdded(),e.cacheState=2})).catch((function(t){if(!Object(y.n)(t))throw Ee.error("#loadNodeData()",i.layer,"Failed to load node '".concat(e.id,"'"),t),e.failed=!0,Object(b.k)(i._index)&&i._index.requestUpdate(),t}))}},{key:"_updateIdleState",value:function(e){e!==this._isIdle&&(this._isIdle=e,this._evaluateUpdating(),e&&this._index&&Object(b.k)(this._index)&&this._index.resetFailedNodes())}},{key:"_getScale",value:function(e){if(this._loadedNodeScales.has(e.index))return this._loadedNodeScales.get(e.index);this._tmpPoint.x=e.mbs[0],this._tmpPoint.y=e.mbs[1],this._tmpPoint.z=e.mbs[2];var t=this.layerView.view.basemapTerrain.getScale(this._tmpPoint);return this.layerView.isNodeLoaded(e.index)&&this._loadedNodeScales.set(e.index,t),t}},{key:"_isNodeInScaleBounds",value:function(e){if(!this.areScaleBoundsActive)return!0;var t=this._getScale(e),i=Object(Se.a)(this.layer),r=i.minScale,n=i.maxScale;return Object(Se.d)(t,r,n)}},{key:"updateStats",value:function(e){e.index=Object(b.k)(this._index)?this._index.size:0,this.isGraphics3D&&(e.detail=this._featureLOD,e.target=this.featureTarget*this.baseLOD),Object(b.k)(this._index)&&this._index.updateStats(e)}},{key:"test",get:function(){var e=this;return{index:this._index,set disableUpdates(t){e._updatesDisabled=t,t?e.cancelNodeLoading():e.requestUpdate()},set disableIDBCache(t){e.disableIDBCache=t},set ignoreServiceObb(t){Object(b.k)(e._index)&&(e._index.ignoreServiceObb=t)},shouldLoadNode:function(t){return e._shouldLoadNode(t)}}}},{key:"notifyLODUpdate",value:function(){this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating(),Object(b.k)(this._index)&&this._index.requestUpdate()}},{key:"geometryFilterChanged",value:function(e){var t=this._index;Object(b.k)(t)&&t.layerFilterChanged(e),this.requestUpdate()}}]),i}(Object(v.b)(l.a));Object(c.a)([Object(m.b)({readOnly:!0})],De.prototype,"isMeshPyramid",null),Object(c.a)([Object(m.b)({readOnly:!0})],De.prototype,"isGraphics3D",null),Object(c.a)([Object(m.b)({readOnly:!0})],De.prototype,"indexStreamController",null),Object(c.a)([Object(m.b)({readOnly:!0})],De.prototype,"dataStreamController",null),Object(c.a)([Object(m.b)({readOnly:!0})],De.prototype,"crsVertex",null),Object(c.a)([Object(m.b)({readOnly:!0})],De.prototype,"crsIndex",null),Object(c.a)([Object(m.b)()],De.prototype,"screenSizeFactor",void 0),Object(c.a)([Object(m.b)()],De.prototype,"featureTarget",void 0),Object(c.a)([Object(m.b)()],De.prototype,"fixedFeatureTarget",void 0),Object(c.a)([Object(m.b)()],De.prototype,"layerView",void 0),Object(c.a)([Object(m.b)()],De.prototype,"layer",void 0),Object(c.a)([Object(m.b)({})],De.prototype,"updating",void 0),Object(c.a)([Object(m.b)({})],De.prototype,"updatingProgress",void 0),Object(c.a)([Object(m.b)({readOnly:!0})],De.prototype,"leavesReached",void 0),Object(c.a)([Object(m.b)({constructOnly:!0})],De.prototype,"scaleVisibilityEnabled",void 0),Object(c.a)([Object(m.b)({readOnly:!0,dependsOn:[]})],De.prototype,"rootNodeVisible",null),De=Object(c.a)([Object(O.a)("esri.layers.graphics.controllers.I3SOnDemandController")],De);var Fe,Ve=new p.a({deallocator:null});function Pe(e,t){return Object(b.k)(e)&&e.length===t.length&&e.every((function(e){return Ae(t,e.name)>=0}))}function Ae(e,t){for(var i=t.toLowerCase(),r=0;r<e.length;r++)if(e[r].name.toLowerCase()===i)return r;return-1}var Le={factorIM:.2,factor3dObject:.05,distancePenalty:10},Me=Object(x.l)(),Re=De},1026:function(e,t,i){"use strict";i.d(t,"a",(function(){return w}));var r=i(35),n=i(8),a=i.n(n),s=i(15),o=i(31),u=i(12),c=i(3),l=i(4),d=i(69),h=i(102),f=i(134),b=i(553),p=i(16),v=i(2),y=i(23),g=i(158),m=i(163);function O(e,t,i){return _.apply(this,arguments)}function _(){return(_=Object(s.a)(a.a.mark((function e(t,i,r){var n,s,o,u;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=i.clone(),t.capabilities.query.supportsMaxRecordCountFactor&&(i.maxRecordCountFactor=x(t)),n=j(t),s=t.capabilities.query.supportsPagination,i.start=0,i.num=n,o=null;case 4:return e.next=6,t.source.queryFeaturesJSON(i,r);case 6:if(u=e.sent,Object(v.j)(o)?o=u:o.features=o.features.concat(u.features),o.exceededTransferLimit=u.exceededTransferLimit,s&&u.exceededTransferLimit){e.next=9;break}return e.abrupt("break",12);case 9:i.start+=n;case 10:e.next=4;break;case 12:return e.abrupt("return",o);case 13:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function j(e){return x(e)*function(e){return e.capabilities.query.maxRecordCount||2e3}(e)}function x(e){return e.capabilities.query.supportsMaxRecordCountFactor?m.a.MAX_MAX_RECORD_COUNT_FACTOR:1}var k=p.a.getLogger("esri.views.3d.layers.i3s.I3SAttributeOverrides"),w=function(){function e(t,i){var r=this;Object(c.a)(this,e),this.layer=t,this.warnMaximumChangedObjectsExceeded=!1,this.changedObjectIds=new Set,this.pendingFetchAbortController=Object(y.e)(),this.interactiveEditingSessions=null,this._maximumNumberOfEditOVerrides=S,this.memCache=i.getMemCache("".concat(t.uid,"-attribute-overrides")),this.pendingFetchChangedObjectIds=this.fetchChangedObjectIds(this.pendingFetchAbortController.signal),this.pendingFetchChangedObjectIds.then((function(){return r.pendingFetchAbortController=null}))}return Object(l.a)(e,[{key:"destroy",value:function(){this.layer=null,this.memCache.destroy(),this.memCache=null,this.pendingFetchAbortController&&(this.pendingFetchAbortController.abort(),this.pendingFetchAbortController=null),this.pendingFetchChangedObjectIds=null}},{key:"createInteractiveEditSession",value:function(e){var t=this;this.changedObjectIds.add(e),Object(v.j)(this.interactiveEditingSessions)&&(this.interactiveEditingSessions=[]);var i=this.interactiveEditingSessions,r=new C(e,{rollback:function(){Object(h.l)(i,r),0===i.length&&(t.interactiveEditingSessions=null)},commit:function(i){var r,n=Object(u.a)(i);try{for(n.s();!(r=n.n()).done;){var a=Object(o.a)(r.value,2),s=a[0],c=a[1];t.updateValue(e,s,c)}}catch(l){n.e(l)}finally{n.f()}}});return i.unshift(r),r}},{key:"apply",value:function(){var e=Object(s.a)(a.a.mark((function e(t,i,r){var n,s,o,u,c,l,d;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Object(v.j)(i)){e.next=2;break}return e.abrupt("return");case 2:if(n=i.loadedAttributes,s=i.attributeData,!Object(v.j)(n)&&0!==n.length&&!Object(v.j)(s)){e.next=5;break}return e.abrupt("return");case 5:return e.next=7,Object(y.B)(this.pendingFetchChangedObjectIds,r);case 7:if(0!==this.changedObjectIds.size){e.next=9;break}return e.abrupt("return");case 9:return o={loadedAttributes:n,attributeData:s},u=this.getOverridesFromCache(t,o,this.changedObjectIds),c=u.objectIds,l=u.fieldNames,e.next=15,this.queryOverridesFromAssociatedLayer(c,l,r);case 15:d=e.sent,Object(v.j)(d)||this.processOverridesFromAssociatedLayer(t,d,l,o);case 17:case"end":return e.stop()}}),e,this)})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"updateValue",value:function(e,t,i){this.changedObjectIds.add(e),this.cacheValue(e,t,i)}},{key:"cacheValue",value:function(e,t,i){this.memCache.put(this.getCacheKey(e,t),i,this.memCacheValueSize(i))}},{key:"getOverridesFromCache",value:function(e,t,i){var r,n=t.loadedAttributes,a=t.attributeData,s=new Set,o=new Array,c=Object(u.a)(n);try{for(c.s();!(r=c.n()).done;){var l=r.value;o[l.index]=a[l.name]}}catch(g){c.e(g)}finally{c.f()}for(var d=new Set,h=0;h<e.length;h++){var f=e[h];if(i.has(f)){var b,p=Object(u.a)(n);try{for(p.s();!(b=p.n()).done;){var v=b.value,y=this.fromCache(f,v.index);void 0===y?(s.add(f),d.add(v.name)):o[v.index][h]=y}}catch(g){p.e(g)}finally{p.f()}}}return{objectIds:Array.from(s),fieldNames:Array.from(d)}}},{key:"fromCache",value:function(e,t){var i=this.fromInteractiveEditingSession(e,t);if(void 0!==i)return i;var r=this.getCacheKey(e,t);return this.memCache.get(r)}},{key:"fromInteractiveEditingSession",value:function(e,t){if(!Object(v.j)(this.interactiveEditingSessions)){var i,r=Object(u.a)(this.interactiveEditingSessions);try{for(r.s();!(i=r.n()).done;){var n=i.value;if(n.objectId===e){var a=n.get(t);if(void 0!==a)return a}}}catch(s){r.e(s)}finally{r.f()}}}},{key:"getCacheKey",value:function(e,t){return"".concat(e,"-").concat(t)}},{key:"queryOverridesFromAssociatedLayer",value:function(){var e=Object(s.a)(a.a.mark((function e(t,i,n){var s,o,u,c;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==t.length&&0!==i.length){e.next=2;break}return e.abrupt("return",null);case 2:return t=t.sort((function(e,t){return e-t})),this.warnMaximumChangedObjectsExceeded&&(this.warnMaximumChangedObjectsExceeded=!1,this.logMaximumObjectsExceededWarning()),s=Object(v.t)(this.layer.associatedLayer),(o=s.createQuery()).where="1=1",o.returnGeometry=!1,o.outFields=[s.objectIdField].concat(Object(r.a)(i)),o.cacheHint=!0,o.objectIds=t,u=j(s),c=t.length>u?Object(h.p)(t,u).map((function(e){var t=o.clone();return t.objectIds=e,Object(f.e)(O(s,t,{signal:n}))})):[Object(f.e)(O(s,o,{signal:n}))],e.next=8,Promise.all(c);case 8:return e.abrupt("return",e.sent.reduce((function(e,t){return e.concat(t.ok?t.value.features:[])}),[]));case 9:case"end":return e.stop()}}),e,this)})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"logMaximumObjectsExceededWarning",value:function(){var e="The number of edited objects that are not yet cached in the scene service exceeds the maximum limit. Attribute changes will only be available for the first ".concat(Object(g.b)(this._maximumNumberOfEditOVerrides)," objects. Please consider re-caching the scene service"),t=this.layer.portalItem;t&&t.loaded?e+=" (".concat(t.portal.url,"/home/item.html?id=").concat(t.id,"#settings)"):e+=" (".concat(this.layer.parsedUrl.path,")"),k.warn("#queryOverrides()",this.layer.title,"".concat(e,"."))}},{key:"processOverridesFromAssociatedLayer",value:function(e,t,i,r){var n,a=r.loadedAttributes,s=r.attributeData,o=Object(v.t)(this.layer.associatedLayer).objectIdField,c=i.map((function(e){return s[e]})),l=new Map(a.map((function(e){return[e.name,e.index]}))),d=i.map((function(e){return l.get(e)})),h=new Map(Array.from(e,(function(e,t){return[e,t]}))),f=Object(u.a)(t);try{for(f.s();!(n=f.n()).done;)for(var b=n.value,p=b.attributes[o],y=0;y<i.length;y++){var g=d[y],m=h.get(p),O=b.attributes[i[y]];c[y][m]=O,this.cacheValue(p,g,O)}}catch(_){f.e(_)}finally{f.f()}}},{key:"memCacheValueSize",value:function(e){return"string"==typeof e?Object(b.d)(e):Object(b.c)()}},{key:"fetchChangedObjectIds",value:function(){var e=Object(s.a)(a.a.mark((function e(t){var i,r,n,s,o,u,c,l,h,b,p;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=this.layer,e.next=3,s.load({signal:t});case 3:if(this.changedObjectIds.clear(),!Object(v.j)(s.associatedLayer)&&null!=(i=s.associatedLayer.capabilities)&&null!=(r=i.operations)&&r.supportsChangeTracking){e.next=6;break}return e.abrupt("return");case 6:if(o=this.getFetchChangedObjectIdsServerGen(),!Object(v.j)(o)){e.next=9;break}return e.abrupt("return",null);case 9:return u=s.associatedLayer.layerId,e.next=12,Object(f.d)(Object(d.default)("".concat(s.associatedLayer.url,"/extractChanges"),{method:"post",query:{f:"json",returnIdsOnly:!0,layers:"".concat(u),returnUpdates:!0,returnDeletes:!1,returnInserts:!1,layerServerGens:JSON.stringify([{id:u,serverGen:o}])},timeout:I,signal:t}));case 12:if(c=e.sent,l=c.ok&&null!=(n=c.value.data)&&n.edits?Object(v.i)(c.value.data.edits[0],"objectIds","updates"):null,Object(v.k)(l))for((h=Math.min(this._maximumNumberOfEditOVerrides,l.length))<l.length&&(this.warnMaximumChangedObjectsExceeded=!0),b=l.sort((function(e,t){return e-t})),p=0;p<h;p++)this.changedObjectIds.add(b[p]);case 15:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getFetchChangedObjectIdsServerGen",value:function(){var e=this.layer;if(Object(v.k)(e.serviceUpdateTimeStamp)&&Object(v.k)(e.serviceUpdateTimeStamp.lastUpdate))return e.serviceUpdateTimeStamp.lastUpdate;var t=e.associatedLayer;return Object(v.k)(t)&&Object(v.k)(t.serverGens)&&Object(v.k)(t.serverGens.minServerGen)?t.serverGens.minServerGen:null}},{key:"test",get:function(){var e=Array.from(this.changedObjectIds),t=this.pendingFetchChangedObjectIds,i=this;return{changedObjectIds:e,pendingFetchChangedObjectIds:t,get maximumNumberOfEditOVerrides(){return i._maximumNumberOfEditOVerrides},set maximumNumberOfEditOVerrides(e){i._maximumNumberOfEditOVerrides=e}}}}]),e}(),C=function(){function e(t,i){Object(c.a)(this,e),this.objectId=t,this.options=i,this.updates=new Map,this.state=0}return Object(l.a)(e,[{key:"get",value:function(e){return this.updates.get(e)}},{key:"set",value:function(e,t){this.isActive&&this.updates.set(e,t)}},{key:"rollback",value:function(){this.isActive&&(this.state=2,this.options.rollback())}},{key:"commit",value:function(){this.isActive&&(this.state=1,this.options.commit(this.updates),this.updates.clear())}},{key:"isActive",get:function(){return 0===this.state}}]),e}(),I=1e4,S=5e4},1061:function(e,t,i){"use strict";i.d(t,"a",(function(){return b}));var r=i(3),n=i(4),a=i(6),s=i(7),o=i(0),u=i(16),c=i(1),l=(i(17),i(18),i(9)),d=i(851),h=i(910),f=u.a.getLogger("esri.views.3d.layers.support.DefinitionExpressionSceneLayerView"),b=function(e){var t=function(e){Object(a.a)(i,e);var t=Object(s.a)(i);function i(){var e;return Object(r.a)(this,i),(e=t.apply(this,arguments))._definitionExpressionErrors=0,e._maxDefinitionExpressionErrors=20,e.logError=function(t){e._definitionExpressionErrors<e._maxDefinitionExpressionErrors&&f.error("Error while evaluating definitionExpression: "+t),e._definitionExpressionErrors++,e._definitionExpressionErrors===e._maxDefinitionExpressionErrors&&f.error("Further errors are ignored")},e}return Object(n.a)(i,[{key:"parsedDefinitionExpression",get:function(){if(!this.i3slayer||!this.i3slayer.definitionExpression)return null;try{var e=d.WhereClause.create(this.i3slayer.definitionExpression,this.i3slayer.fieldsIndex);if(!e.isStandardized)return f.error("definitionExpression is using non standard function"),null;var t=[],i=e.fieldNames;return Object(h.k)(i,this.i3slayer.fields,{missingFields:t}),t.length>0?(f.error("definitionExpression references unknown fields: ".concat(t.join(", "))),null):(this._definitionExpressionErrors=0,e)}catch(r){return f.error("Failed to parse definitionExpression: "+r),null}}},{key:"definitionExpressionFields",get:function(){return this.parsedDefinitionExpression?this.parsedDefinitionExpression.fieldNames:null}},{key:"_evaluateClause",value:function(e,t){try{return e.testFeature(t)}catch(i){return this.logError(i),!1}}},{key:"_addDefinitionExpressionToQuery",value:function(e){if(!this.parsedDefinitionExpression)return e;var t=this.i3slayer.definitionExpression,i=e.clone();return i.where?i.where="(".concat(t,") AND (").concat(i.where,")"):i.where=t,i}}]),i}(e);return Object(o.a)([Object(c.b)()],t.prototype,"i3slayer",void 0),Object(o.a)([Object(c.b)({readOnly:!0})],t.prototype,"parsedDefinitionExpression",null),Object(o.a)([Object(c.b)({readOnly:!0})],t.prototype,"definitionExpressionFields",null),t=Object(o.a)([Object(l.a)("esri.views.3d.layers.support.DefinitionExpressionSceneLayerView")],t),t}},1062:function(e,t,i){"use strict";i.d(t,"a",(function(){return g}));var r=i(35),n=i(12),a=i(8),s=i.n(a),o=i(15),u=i(3),c=i(4),l=i(6),d=i(7),h=i(0),f=i(20),b=i(2),p=(i(1),i(17),i(18),i(16),i(9)),v=i(81),y=i(942),g=function(e){var t=function(e){Object(l.a)(i,e);var t=Object(d.a)(i);function i(){return Object(u.a)(this,i),t.apply(this,arguments)}return Object(c.a)(i,[{key:"_validateFetchPopupFeatures",value:function(e){var t=this.layer;return t.popupEnabled?Object(y.a)(t,e)?void 0:new f.a("scenelayerview3d:fetchPopupFeatures","Layer does not define a popup template",{layer:t}):new f.a("scenelayerview3d:fetchPopupFeatures","Popups are disabled",{layer:t})}},{key:"prepareFetchPopupFeatures",value:function(){var e=Object(o.a)(s.a.mark((function e(t){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},{key:"fetchPopupFeatures",value:function(){var e=Object(o.a)(s.a.mark((function e(t,i){var a,o,u,c,l,d,h,f,p,g;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(a=this._validateFetchPopupFeatures(i))){e.next=3;break}return e.abrupt("return",Promise.reject(a));case 3:if((o=Object(b.k)(i)?i.clientGraphics:null)&&0!==o.length){e.next=6;break}return e.abrupt("return",Promise.resolve([]));case 6:return u=[],c=[],l="scene"===this.layer.type&&Object(b.k)(this.layer.associatedLayer)?this.layer.associatedLayer:this.layer,e.t0=v.v,e.t1=this.layer.fieldsIndex,e.next=13,Object(y.b)(l,Object(y.a)(this.layer,i));case 13:return e.t2=e.sent,d=(0,e.t0)(e.t1,e.t2),e.next=17,this.prepareFetchPopupFeatures(d);case 17:h=new Set,f=Object(n.a)(o);try{for(f.s();!(p=f.n()).done;)g=p.value,Object(v.t)(d,g,h)?c.push(g):u.push(g)}catch(t){f.e(t)}finally{f.f()}return e.abrupt("return",0===c.length?Promise.resolve(u):this.whenGraphicAttributes(c,Object(r.a)(h)).catch((function(){return c})).then((function(e){return u.concat(e)})));case 21:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()}]),i}(e);return t=Object(h.a)([Object(p.a)("esri.views.3d.layers.support.PopupSceneLayerView")],t)}},1133:function(e,t,i){"use strict";i.d(t,"a",(function(){return u})),i.d(t,"b",(function(){return c}));var r=i(12),n=i(26),a=i(2),s=i(934),o={setAttribute:function(){},rollback:function(){},commit:function(){}};function u(e,t){var i=t.attributes[e.objectIdField],s=e.sessions.get(i);if(s)return s;var u=Object(n.a)(t.attributes),c=new Set;if(null==i)return o;var l=e.attributeOverrides.createInteractiveEditSession(i),d=new Map,h=function(e,t){var r=d.get(e);if(null==r){var n=t.indexOf(i);return d.set(e,n),n}return r},f=0,b={setAttribute:function(i,r){if(0===f){var n=e.fieldsIndex.get(i);if(!Object(a.j)(n)){var s=e.attributeStorageInfo.findIndex((function(e){return e.name===n.name}));if(!(s<0)){l.set(s,r);var o=e.attributeStorageInfo[s],u=!1;c.add(i),e.forEachNode((function(i,n){var a=h(i,n);if(-1!==a){var s=e.getAttributeData(i.index);if(s){var c=s[o.name];c&&(c[a]=r,e.setAttributeData(i.index,s,t),u=!0)}}})),u&&e.clearMemCache()}}}},rollback:function(){if(0===f){var t,n=Object(r.a)(c);try{for(n.s();!(t=n.n()).done;){var a=t.value;this.setAttribute(a,u[a])}}catch(s){n.e(s)}finally{n.f()}l.rollback(),f=1,e.sessions.delete(i)}},commit:function(){0===f&&(l.commit(),f=2,e.sessions.delete(i))}};return e.sessions.set(i,b),b}function c(e,t){var i=function(e,t){var i=t.edits.updateFeatures;if(!i||0===i.length)return new h;for(var n=function(e){var t=new Set;if(!e.updatedFeatures)return t;var i,n=Object(r.a)(e.updatedFeatures);try{for(n.s();!(i=n.n()).done;){var a=i.value;null!=a.objectId&&null==a.error&&t.add(a.objectId)}}catch(s){n.e(s)}finally{n.f()}return t}(t),a=new h,o=new Map,u=0;u<e.attributeStorageInfo.length;u++)o.set(e.attributeStorageInfo[u].name,u);var c=e.fieldsIndex,d=e.objectIdField,f=i.filter((function(e){var t=Object(s.a)(c,e.attributes,d);return n.has(t)}));return e.forEachNode((function(t,i){var n,o=new Set(i),u=Object(r.a)(f);try{for(u.s();!(n=u.n()).done;){var h=n.value,b=Object(s.a)(c,h.attributes,d);if(o.has(b)){var p=i.indexOf(b);for(var v in h.attributes){var y=e.fieldsIndex.normalizeFieldName(v),g=l(a,t.index,y),m=h.attributes[v];g.push({featureIndex:p,featureId:b,value:m})}}}}catch(O){u.e(O)}finally{u.f()}})),a}(e,t);if(0!==i.size){for(var n=new Map,o=0;o<e.attributeStorageInfo.length;o++)n.set(e.attributeStorageInfo[o].name,o);var u=!1;i.forEach((function(t,i){var s=e.getAttributeData(i),o=!1;t.forEach((function(t,i){var c,l=Object(a.k)(s)?s[i]:null,d=n.get(i),h=Object(r.a)(t);try{for(h.s();!(c=h.n()).done;){var f=c.value,b=f.featureIndex,p=f.value,v=f.featureId;l&&(l[b]=p,o=!0,u=!0),e.attributeOverrides.updateValue(v,d,p)}}catch(y){h.e(y)}finally{h.f()}})),o&&e.setAttributeData(i,s,null)})),u&&e.clearMemCache()}}function l(e,t,i){var r=function(e,t){var i=e.get(t);if(i)return i;var r=new d;return e.set(t,r),r}(e,t),n=r.get(i);if(n)return n;var a=new Array;return r.set(i,a),a}var d=Map,h=Map},1134:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i(35),n=i(81);function a(){return{requiredFields:{type:[String],readOnly:!0},availableFields:{type:[String],readOnly:!0,get:function(){var e=this.layer,t=this.layer.fieldsIndex,i=this.requiredFields;return e.outFields?Object(n.j)(t,[].concat(Object(r.a)(Object(n.v)(t,e.outFields)),Object(r.a)(i))):Object(n.j)(t,i)}}}}},1135:function(e,t,i){"use strict";i.d(t,"a",(function(){return c}));var r=i(3),n=i(4),a=i(6),s=i(7),o=i(0),u=i(1),c=(i(17),i(18),i(16),i(307),i(91),function(e){Object(a.a)(i,e);var t=Object(s.a)(i);function i(){var e;return Object(r.a)(this,i),(e=t.apply(this,arguments)).layer=null,e.filter=null,e}return Object(n.a)(i,[{key:"availableFields",get:function(){return[]}},{key:"maximumNumberOfFeatures",get:function(){return 0},set:function(e){throw new Error("Not implemented")}},{key:"maximumNumberOfFeaturesExceeded",get:function(){return!1}},{key:"highlight",value:function(e){throw new Error("Not implemented")}},{key:"queryFeatures",value:function(e,t){throw new Error("Not implemented")}},{key:"queryObjectIds",value:function(e,t){throw new Error("Not implemented")}},{key:"queryFeatureCount",value:function(e,t){throw new Error("Not implemented")}},{key:"createQuery",value:function(){throw new Error("Not implemented")}},{key:"queryExtent",value:function(e,t){throw new Error("Not implemented")}}]),i}(i(686).a));Object(o.a)([Object(u.b)()],c.prototype,"layer",void 0),Object(o.a)([Object(u.b)()],c.prototype,"availableFields",null),Object(o.a)([Object(u.b)()],c.prototype,"maximumNumberOfFeatures",null),Object(o.a)([Object(u.b)({readOnly:!0})],c.prototype,"maximumNumberOfFeaturesExceeded",null),Object(o.a)([Object(u.b)()],c.prototype,"filter",void 0)},1157:function(e,t,i){"use strict";i.d(t,"a",(function(){return k}));var r=i(8),n=i.n(r),a=i(15),s=i(35),o=i(3),u=i(4),c=i(6),l=i(7),d=i(0),h=i(32),f=i(16),b=i(91),p=i(9),v=i(464),y=function(e){var t=function(e){Object(c.a)(i,e);var t=Object(l.a)(i);function i(){var e;return Object(o.a)(this,i),(e=t.apply(this,arguments)).asyncUpdateState=new Map,e}return Object(u.a)(i,[{key:"autoUpdateAsync",value:function(e,t){var i=this;return function(e,t){var i=function(){a&&!s&&e(r)},r=function(){if(!a||s)return t();a.clear(),s=!0;var e=Object(b.b)(a,t);return s=!1,e},n=function(){a&&(a.destroy(),a=null)},a=new v.a(i),s=!1;return e(r),{remove:n}}((function(t){return i.updateAsync(e,t)}),t)}},{key:"updateAsync",value:function(){var e=Object(a.a)(n.a.mark((function e(t,i){var r;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.startAsyncUpdate(t)){e.next=12;break}return e.prev=1,e.next=4,i();case 4:r=e.sent,this._set(t,r),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(1),f.a.getLogger(this.declaredClass).warn('Async update of "'.concat(t,'" failed. Async update functions should not throw exceptions.'));case 11:this.endAsyncUpdate(t)&&this.updateAsync(t,i);case 12:case"end":return e.stop()}}),e,this,[[1,8]])})));return function(t,i){return e.apply(this,arguments)}}()},{key:"startAsyncUpdate",value:function(e){var t,i=null!=(t=this.asyncUpdateState.get(e))?t:0;return 1&i?(this.asyncUpdateState.set(e,2|i),!0):(this.asyncUpdateState.set(e,1|i),!1)}},{key:"endAsyncUpdate",value:function(e){var t,i=-2&(null!=(t=this.asyncUpdateState.get(e))?t:0);return 2&i?(this.asyncUpdateState.set(e,-3&i),!0):(this.asyncUpdateState.set(e,i),!1)}}]),i}(e);return t=Object(d.a)([Object(p.a)("esri.core.AsyncUpdate")],t)};var g=function(e){Object(c.a)(i,e);var t=Object(l.a)(i);function i(){return Object(o.a)(this,i),t.apply(this,arguments)}return i}(y(h.a));g=Object(d.a)([Object(p.a)("esri.core.AsyncUpdate")],g);var m=i(185),O=i(2),_=i(1),j=(i(17),i(18),i(81)),x=f.a.getLogger("esri.views.3d.layers.support.SceneLayerViewRequiredFields"),k=function(e){Object(c.a)(i,e);var t=Object(l.a)(i);function i(e){return Object(o.a)(this,i),t.call(this,e)}return Object(u.a)(i,[{key:"requiredFields",get:function(){var e=this.layerView,t=e.layer.fieldsIndex,i=e.definitionExpressionFields,r=this.rendererFields,n=this.labelingFields,a=this.viewFilterFields;return Object(j.j)(t,[].concat(Object(s.a)(Object(O.u)(i,[])),Object(s.a)(Object(O.u)(r,[])),Object(s.a)(Object(O.u)(n,[])),Object(s.a)(Object(O.u)(a,[]))))}},{key:"initialize",value:function(){var e=this,t=this.layerView.layer;this.layer=t,this.handles.add([this.autoUpdateAsync("rendererFields",(function(){var t=e.layer,i=t.fieldsIndex,r=t.renderer;return r?w((function(e){return r.collectRequiredFields(e,i)})):null})),this.autoUpdateAsync("labelingFields",(function(){var t=e.layer;return t.labelsVisible?w((function(e){return Object(j.g)(e,t)})):null})),this.autoUpdateAsync("viewFilterFields",(function(){var t=e.layerView,i=t.layer,r=t.filter;return w((function(e){return Object(j.f)(e,i,r)}))}))])}}]),i}(y(m.a));function w(e){return C.apply(this,arguments)}function C(){return(C=Object(a.a)(n.a.mark((function e(t){var i;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=new Set,e.prev=1,e.next=4,t(i);case 4:return e.abrupt("return",Array.from(i).sort());case 7:return e.prev=7,e.t0=e.catch(1),e.abrupt("return",(x.error(e.t0),null));case 10:case"end":return e.stop()}}),e,null,[[1,7]])})))).apply(this,arguments)}Object(d.a)([Object(_.b)()],k.prototype,"layerView",void 0),Object(d.a)([Object(_.b)()],k.prototype,"layer",void 0),Object(d.a)([Object(_.b)()],k.prototype,"requiredFields",null),Object(d.a)([Object(_.b)()],k.prototype,"rendererFields",void 0),Object(d.a)([Object(_.b)()],k.prototype,"labelingFields",void 0),Object(d.a)([Object(_.b)()],k.prototype,"viewFilterFields",void 0),k=Object(d.a)([Object(p.a)("esri.views.3d.layers.support.SceneLayerViewRequiredFields")],k)},1382:function(e,t,i){"use strict";i.r(t),i.d(t,"default",(function(){return ee}));var r=i(12),n=i(14),a=i(8),s=i.n(a),o=i(35),u=i(15),c=i(3),l=i(4),d=i(47),h=i(44),f=i(6),b=i(7),p=i(0),v=i(119),y=i(16),g=i(2),m=i(27),O=i(1),_=(i(17),i(18),i(9)),j=i(5),x=i(11),k=i(53),w=i(45),C=i(169),I=i(208),S=i(412),E=i(1025),N=i(550),D=i(453),F=i(163),V=function(e){Object(f.a)(i,e);var t=Object(b.a)(i);function i(e){return Object(c.a)(this,i),t.call(this,"SceneLayerWorker","dracoDecompressPointCloudData",e,{hasInitialize:!0})}return Object(l.a)(i,[{key:"getTransferList",value:function(e){return[e.geometryBuffer]}}]),i}(i(544).a),P=i(693),A=i(976),L=i(937),M=i(1133),R=i(1026),T=i(910),G=i(1061),U=i(1134),q=i(1062),Q=i(1157),B=i(93),H=i(1024),z=i(445),J=i(498),K=i(1135),W=i(925),Y=i(104),Z=y.a.getLogger("esri.views.3d.layers.SceneLayerGraphicsView3D"),X=Object(U.a)(),$=function(e){Object(f.a)(a,e);var t=Object(b.a)(a);function a(){var e;return Object(c.a)(this,a),(e=t.apply(this,arguments)).type="scene-layer-graphics-3d",e._nodesAddedToStage=new Map,e.drapeSourceType=1,e._queryEngine=null,e._memCache=null,e._interactiveEditingSessions=new Map,e.loadedGraphics=new H.a,e.holeFilling="always",e.progressiveLoadFactor=1,e.supportsHeightUnitConversion=!0,e._coordinatesOutsideExtentErrors=0,e._maxCoordinatesOutsideExtentErrors=20,e}return Object(l.a)(a,[{key:"initialize",value:function(){var e,t=this,r=this.layer;this.addResolvingPromise(r.indexInfo),this._attributeOverrides=new R.a(this.layer,null==(e=this.view.resourceController)?void 0:e.memoryController),Object(T.g)(r,this.view.spatialReference,this.view.viewingMode),this.fieldsHelper=new Q.a({layerView:this}),this.updatingHandles.add(r,"rangeInfos",(function(e){return t._rangeInfosChanged(e)}),2),this.updatingHandles.add(r,"renderer",(function(e,i){return t._rendererChange(e,i)})),this.updatingHandles.add(this,"parsedDefinitionExpression",(function(){return t._filterChange()})),this.updatingHandles.add(this,"view.floors",(function(){return t.graphics3d.filterVisibility.filterChanged()})),this.handles.add(Object(m.a)(B.a,"I3S_TREE_SHOW_TILES",(function(e){if(e&&!t._treeDebugger){var r=t._controller.crsIndex;i.e(45).then(i.bind(null,1356)).then((function(e){var i=e.I3STreeDebugger;!t._treeDebugger&&B.a.I3S_TREE_SHOW_TILES&&(t._treeDebugger=new i({lv:t,view:t.view,nodeSR:r}))}))}else e||!t._treeDebugger||B.a.I3S_TREE_SHOW_TILES||(t._treeDebugger.destroy(),t._treeDebugger=null)}))),this._set("graphics3d",new A.a({owner:this,layer:r,preferredUpdatePolicy:0,scaleVisibilityEnabled:!0,filterVisibilityEnabled:!0,timeExtentVisibilityEnabled:!1,frustumVisibilityEnabled:!1,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!1,suspendResumeExtentMode:"data",dataExtent:r.fullExtent,updateClippingExtent:function(e){return t._updateClippingExtent(e)}})),this.graphics3d.elevationAlignment&&this.graphics3d.elevationAlignment.events.on("invalidate-elevation",(function(e){return t._invalidateElevation(e)})),this.supportsHeightUnitConversion&&(this._verticalScale=Object(D.a)("point",r.spatialReference,this.view.spatialReference)),this.addResolvingPromise(this.graphics3d.setup()),this._memCache=this.view.resourceController.memoryController.getMemCache(r.uid),this._controller=new E.a({layerView:this,scaleVisibilityEnabled:!1}),Object(T.i)(this.layer.geometryDefinitions)&&(this._worker=new V((function(e){return t.view.resourceController.schedule(e)}))),this.handles.add(this.layer.on("apply-edits",(function(e){return t.updatingHandles.addPromise(e.result)}))),this.handles.add(this.layer.on("edits",(function(e){return t._handleEdits(e)}))),this.when((function(){t._queryEngine=new L.a({layerView:t,priority:Y.b.FEATURE_QUERY_ENGINE}),t.updatingHandles.add(t,"maximumNumberOfFeatures",(function(e){return t._controller.featureTarget=e}),2),t.updatingHandles.add(t,"suspended",(function(e){e&&t._removeAllNodeData()}))}))}},{key:"destroy",value:function(){this._treeDebugger=Object(g.e)(this._treeDebugger),this._attributeOverrides=Object(g.e)(this._attributeOverrides),this._set("graphics3d",Object(g.e)(this.graphics3d)),this._controller=Object(g.e)(this._controller),this._queryEngine=Object(g.e)(this._queryEngine),this._worker=Object(g.e)(this._worker),this._memCache=Object(g.e)(this._memCache),this._nodesAddedToStage.clear(),this.fieldsHelper=Object(g.e)(this.fieldsHelper)}},{key:"requiredFields",get:function(){var e,t;return null!=(e=null==(t=this.fieldsHelper)?void 0:t.requiredFields)?e:[]}},{key:"maximumNumberOfFeatures",get:function(){var e=this.graphics3d&&this.graphics3d.graphicsCore&&this.graphics3d.graphicsCore.displayFeatureLimit;return e?e.maximumNumberOfFeatures:0},set:function(e){null!=e?(this._override("maximumNumberOfFeatures",e),this._controller.fixedFeatureTarget=!0):(this._clearOverride("maximumNumberOfFeatures"),this._controller.fixedFeatureTarget=!1)}},{key:"maximumNumberOfFeaturesExceeded",get:function(){return!this.suspended&&!!this._controller&&!this._controller.leavesReached}},{key:"hasM",get:function(){return!1}},{key:"hasZ",get:function(){return!0}},{key:"notifyGraphicGeometryChanged",value:function(e){this.graphics3d.graphicsCore.notifyGraphicGeometryChanged(e)}},{key:"notifyGraphicVisibilityChanged",value:function(e){this.graphics3d.graphicsCore.notifyGraphicVisibilityChanged(e)}},{key:"whenGraphicAttributes",value:function(){var e=Object(u.a)(s.a.mark((function e(t,i){var r=this;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Object(T.x)(this.layer,t,this._getObjectIdField(),i,(function(){return Object(o.a)(r._nodesAddedToStage.values())})));case 1:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"getGraphicFromGraphicUid",value:function(e){if(!this.loadedGraphics)return null;var t=Object(S.c)(this.loadedGraphics.find((function(t){return t.uid===e})),this.layer),i=this._getObjectIdField();return t&&t.attributes&&t.attributes[i]?(t.layer=this.layer,t.sourceLayer=this.layer,t):null}},{key:"whenGraphicBounds",value:function(e,t){return this.graphics3d.graphicsCore.whenGraphicBounds(e,t)}},{key:"computeAttachmentOrigin",value:function(e,t){return this.graphics3d.graphicsCore.computeAttachmentOrigin(e,t)}},{key:"canResume",value:function(){return Object(d.a)(Object(h.a)(a.prototype),"canResume",this).call(this)&&(!this._controller||this._controller.rootNodeVisible)}},{key:"isUpdating",value:function(){return!!(this._controller&&this._controller.updating||this.graphics3d&&this.graphics3d.updating)}},{key:"getRenderingInfo",value:function(e,t,i){var r=Object(N.c)(e,{renderer:t,arcade:i});if(Object(g.k)(r)&&r.color){var n=r.color;n[0]=n[0]/255,n[1]=n[1]/255,n[2]=n[2]/255}return r}},{key:"getRenderingInfoAsync",value:function(){var e=Object(u.a)(s.a.mark((function e(t,i,r,a){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Object(N.d)(t,Object(n.a)({renderer:i,arcade:r},a)));case 1:case"end":return e.stop()}}),e)})));return function(t,i,r,n){return e.apply(this,arguments)}}()},{key:"symbolUpdateType",get:function(){return this.graphics3d.graphicsCore.symbolUpdateType}},{key:"highlight",value:function(e){return this.graphics3d.highlight(e,this.layer.objectIdField)}},{key:"updatePolicy",get:function(){return this.graphics3d.graphicsCore.effectiveUpdatePolicy}},{key:"createInteractiveEditSession",value:function(e){return Object(M.a)(this.attributeEditingContext,e)}},{key:"extractBinaryPointData",value:function(){var e=Object(u.a)(s.a.mark((function e(t,i){var r,n=this;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r={geometryBuffer:t.geometryBuffer},e.abrupt("return",(Object(g.j)(this._worker)&&(this._worker=new V((function(e){return n.view.resourceController.schedule(e)}))),this._worker.invoke(r,i).then((function(e){if(Object(g.k)(e))return{positionData:e.positions,featureIds:e.featureIds};throw new Error("Failed to decompress Draco point data")}))));case 2:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"checkExtent",value:function(e,t){e&&!Object(C.b)(e,t)&&(this._coordinatesOutsideExtentErrors<this._maxCoordinatesOutsideExtentErrors&&Z.error("Service Error: Coordinates outside of layer extent"),this._coordinatesOutsideExtentErrors+1===this._maxCoordinatesOutsideExtentErrors&&Z.error("Maximum number of errors reached. Further errors are ignored."),this._coordinatesOutsideExtentErrors++)}},{key:"addNode",value:function(){var e=Object(u.a)(s.a.mark((function e(t,i,n){var a,o,u,c,l,d,h,f;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(ie(i)||te(i)){e.next=2;break}return e.abrupt("return",Promise.reject());case 2:if(!this._nodesAddedToStage.has(t.index)){e.next=4;break}return e.abrupt("return",void Z.error("I3S node "+t.id+" already added"));case 4:if(a=this.layer.fullExtent,o=a&&ne(a.clone(),.5),u=this._controller.crsVertex,c=[],l={graphics:null,featureIds:null,attributeInfo:i.attributeDataInfo,node:t},!ie(i)){e.next=10;break}return e.next=8,this._addNodeBinaryPointData(t,l,i,o,c,n);case 8:e.next=11;break;case 10:te(i)&&this._addNodeLegacyPointData(t,l,i,o,c);case 11:return e.next=13,this._attributeOverrides.apply(l.featureIds,i.attributeDataInfo,n);case 13:if(t.numFeatures=l.graphics.length,this._updateNodeMemory(t),re(l),c.length>0&&(this.computeObb(t,c,u),this._controller.updateVisibility(t.index)),this._controller.isGeometryVisible(t)){e.next=19;break}return e.abrupt("return",(this._cacheNodeData(l),Promise.resolve()));case 19:if(this._verticalScale){d=Object(r.a)(l.graphics);try{for(d.s();!(h=d.n()).done;)f=h.value,this._verticalScale(f.geometry)}catch(s){d.e(s)}finally{d.f()}}return e.abrupt("return",(this._nodesAddedToStage.set(t.index,l),this.loadedGraphics.addMany(l.graphics),this._filterNode(l),this._treeDebugger&&this._treeDebugger.update(),Promise.resolve()));case 21:case"end":return e.stop()}}),e,this)})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"computeObb",value:function(e,t,i){var r=this._controller.crsIndex,n=r.isGeographic?this.view.renderSpatialReference:r;Object(k.q)(t,i,0,t,n,0,t.length/3);var a={data:t,size:3};e.serviceObb=Object(z.c)(a),r.isGeographic&&Object(k.z)(e.serviceObb.center,n,e.serviceObb.center,r)}},{key:"isNodeLoaded",value:function(e){return this._nodesAddedToStage.has(e)}},{key:"isNodeReloading",value:function(){return!1}},{key:"updateNodeState",value:function(){}},{key:"_addNodeBinaryPointData",value:function(){var e=Object(u.a)(s.a.mark((function e(t,i,r,n,a,o){var u,c,l,d,h,f,b,p,y,m,O,_,w,C,S,E,N,D,F;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.extractBinaryPointData(r,o);case 2:if(null!=(u=e.sent)){e.next=5;break}return e.abrupt("return",Promise.reject());case 5:for(c=this._getObjectIdField(),l=this._controller.crsVertex,d=this.view.spatialReference,h=this.graphics3d.graphicsCore,f=u.positionData,b=u.featureIds,3,p=f.length/3,y=new Array,m=0;m<p;m++)O=Object(g.k)(t.serviceObb)?t.serviceObb.center:[0,0,0],_=3*m,w=Object(x.g)(f[_+0],f[_+1],f[_+2]),Object(j.h)(w,w,O),t.serviceObb||a.push(w[0],w[1],w[2]),n&&this.checkExtent(n,w),C=b[m],S={},null!=C&&(S[c]=C),E=null==C?v.a.generateUID():C,Object(k.q)(w,l,0,se,d,0,1),N=Object(I.j)(se[0],se[1],se[2],d),D=this.loadedGraphics.get(E),Object(g.k)(D)?(D.level<t.level&&(oe.property="geometry",oe.graphic=D,oe.oldValue=Object(g.t)(D.geometry),oe.newValue=N,D.geometry=N,h.graphicUpdateHandler(oe)),y.push(D)):(F=v.a.generateUID(),y.push({objectId:E,uid:F,geometry:N,attributes:S,visible:!0,level:t.level}));i.graphics=y,i.featureIds=b;case 8:case"end":return e.stop()}}),e,this)})));return function(t,i,r,n,a,s){return e.apply(this,arguments)}}()},{key:"_addNodeLegacyPointData",value:function(e,t,i,n,a){var s,o=this._getObjectIdField(),u=this._controller.crsVertex,c=this.view.spatialReference,l=[0,0,0],d=new Array,h=new Array,f=Object(r.a)(i.pointData);try{for(f.s();!(s=f.n()).done;){var b=s.value,p=b.featureDataPosition,y=p.length,m=b.geometries&&b.geometries[0]||ae[y],O=b.featureIds[0];if("points"===m.params.type){n&&this.checkExtent(n,p);var _={};null!=O&&(_[o]=O);var j=null==O?v.a.generateUID():O,x=void 0;"Embedded"===m.type&&(x=m.params.vertexAttributes.position);for(var w=0;w<x.length;w+=y){for(var C=0;C<y;C++)l[C]=p[C]+x[w+C];var S=3===y;e.serviceObb||a.push(l[0],l[1],S?l[2]:0),Object(k.q)(l,u,0,se,c,0,1);var E=Object(I.j)(se[0],se[1],S?se[2]:void 0,c),N=this.loadedGraphics.get(j);Object(g.k)(N)?h.push(N):h.push({objectId:j,uid:v.a.generateUID(),geometry:E,attributes:_,visible:!0})}d.push(O)}}}catch(D){f.e(D)}finally{f.f()}t.graphics=h,t.featureIds=d}},{key:"_updateNodeMemory",value:function(e){e.memory=4096+(Object(g.k)(e.numFeatures)?e.numFeatures*this.graphics3d.graphicsCore.usedMemoryPerGraphic:0)}},{key:"_cacheNodeData",value:function(e){var t=e.graphics.reduce((function(e,t){return Object(I.e)(t)+e}),512+8*e.featureIds.length+1024);this._memCache.put(this._getMemCacheKey(e.node),e,t)}},{key:"_getMemCacheKey",value:function(e){return"".concat(e.index)}},{key:"_removeAllNodeData",value:function(){var e=this;this._nodesAddedToStage.forEach((function(t){if(t){var i=t.node;e._updateNodeMemory(i),e._cacheNodeData(t)}})),this._nodesAddedToStage.clear(),this._treeDebugger&&this._treeDebugger.update(),this.loadedGraphics.clear()}},{key:"removeNode",value:function(e){var t=this._removeNodeStageData(e);t&&(this._updateNodeMemory(t.node),this._cacheNodeData(t))}},{key:"_removeNodeStageData",value:function(e){var t=this._nodesAddedToStage.get(e);return t?(this.loadedGraphics.removeMany(t.graphics),this._nodesAddedToStage.delete(e),this._treeDebugger&&this._treeDebugger.update(),t):null}},{key:"loadCachedNodeData",value:function(){var e=Object(u.a)(s.a.mark((function e(t){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._memCache.pop(this._getMemCacheKey(t)));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"addCachedNodeData",value:function(){var e=Object(u.a)(s.a.mark((function e(t,i,r,n){return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._nodesAddedToStage.has(t.index)){e.next=9;break}return this.loadedGraphics.addMany(i.graphics),this._nodesAddedToStage.set(t.index,i),this._updateNodeMemory(t),e.next=6,this.updateAttributes(t.index,r,n);case 6:return this._filterNode(i),this._treeDebugger&&this._treeDebugger.update(),e.abrupt("return",Promise.resolve());case 9:Z.error("I3S node "+t.id+" already added");case 10:case"end":return e.stop()}}),e,this)})));return function(t,i,r,n){return e.apply(this,arguments)}}()},{key:"getLoadedNodeIds",value:function(){var e=[];return this._nodesAddedToStage.forEach((function(t){return e.push(t.node.id)})),e.sort()}},{key:"getVisibleNodes",value:function(){var e=new Array;return this._nodesAddedToStage.forEach((function(t){return e.push(t.node)})),e}},{key:"getLoadedNodeIndices",value:function(e){this._nodesAddedToStage.forEach((function(t,i){return e.push(i)}))}},{key:"getLoadedAttributes",value:function(e){var t=this._nodesAddedToStage.get(e);if(t&&Object(g.k)(t.attributeInfo))return t.attributeInfo.loadedAttributes}},{key:"getAttributeData",value:function(e){var t=this._nodesAddedToStage.get(e);if(t&&Object(g.k)(t.attributeInfo))return t.attributeInfo.attributeData}},{key:"setAttributeData",value:function(e,t){var i=this._nodesAddedToStage.get(e);i&&!Object(g.j)(i.attributeInfo)&&(i.attributeInfo.attributeData=t,this._attributeValuesChanged(i))}},{key:"updateAttributes",value:function(){var e=Object(u.a)(s.a.mark((function e(t,i,r){var n;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this._nodesAddedToStage.get(t),e.t0=n,!e.t0){e.next=7;break}return e.next=5,this._attributeOverrides.apply(n.featureIds,i,r);case 5:n.attributeInfo=i,this._attributeValuesChanged(n);case 7:case"end":return e.stop()}}),e,this)})));return function(t,i,r){return e.apply(this,arguments)}}()},{key:"_attributeValuesChanged",value:function(e){if(re(e),this._filterNode(e),this.graphics3d.graphicsCore.labelsEnabled){var t=e.graphics.map((function(e){return e.uid}));this.graphics3d.graphicsCore.updateLabelingInfo(t)}}},{key:"_updateClippingExtent",value:function(e){return this._controller&&this._controller.updateClippingArea(e),!1}},{key:"_getObjectIdField",value:function(){return this.layer.objectIdField||"OBJECTID"}},{key:"_rendererChange",value:function(){var e=Object(u.a)(s.a.mark((function e(t,i){var r,n,a,o;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this.layer.fieldsIndex,n=new Set,!t){e.next=7;break}return e.next=4,t.collectRequiredFields(n,r);case 4:a=Array.from(n).sort(),e.next=8;break;case 7:a=[];case 8:if(n.clear(),!i){e.next=15;break}return e.next=12,i.collectRequiredFields(n,r);case 12:o=Array.from(n).sort(),e.next=16;break;case 15:o=[];case 16:a.length===o.length&&a.every((function(e,t){return a[t]===o[t]}))||this._reloadAllNodes();case 17:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"_rangeInfosChanged",value:function(e){null!=e&&e.length>0&&Z.warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")}},{key:"_filterChange",value:function(){var e=this;this._nodesAddedToStage.forEach((function(t){return e._filterNode(t)}))}},{key:"_reloadAllNodes",value:function(){this._removeAllNodeData(),this._controller&&this._controller.restartNodeLoading()}},{key:"_filterNode",value:function(e){var t,i=this.parsedDefinitionExpression,n=Object(r.a)(e.graphics);try{for(n.s();!(t=n.n()).done;){var a=t.value,s=a.visible;a.visible=!i||this._evaluateClause(i,a),s!==a.visible&&(oe.graphic=a,oe.property="visible",oe.oldValue=s,oe.newValue=a.visible,this.graphics3d.graphicsCore.graphicUpdateHandler(oe))}}catch(o){n.e(o)}finally{n.f()}}},{key:"_invalidateElevation",value:function(e){var t=this._controller.crsIndex;Object(k.o)(e.extent,e.spatialReference,ue,t),this._controller.updateElevationChanged(ue,t)}},{key:"createQuery",value:function(){var e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return Object(g.k)(this.filter)?this.filter.createQuery(e):new F.a(e)}},{key:"queryFeatures",value:function(e,t){return this._queryEngine.executeQuery(this._ensureQuery(e),null==t?void 0:t.signal)}},{key:"queryObjectIds",value:function(e,t){return this._queryEngine.executeQueryForIds(this._ensureQuery(e),null==t?void 0:t.signal)}},{key:"queryFeatureCount",value:function(e,t){return this._queryEngine.executeQueryForCount(this._ensureQuery(e),null==t?void 0:t.signal)}},{key:"queryExtent",value:function(e,t){return this._queryEngine.executeQueryForExtent(this._ensureQuery(e),null==t?void 0:t.signal)}},{key:"_ensureQuery",value:function(e){return this._addDefinitionExpressionToQuery(Object(g.j)(e)?this.createQuery():F.a.from(e))}},{key:"getUsedMemory",value:function(){var e=this.graphics3d&&this.graphics3d.graphicsCore;return e?e.usedMemory:0}},{key:"getUnloadedMemory",value:function(){var e=this.graphics3d&&this.graphics3d.graphicsCore;return.8*((this._controller?this._controller.unloadedMemoryEstimate:0)+(e?e.unprocessedMemoryEstimate:0))}},{key:"ignoresMemoryFactor",value:function(){return this._controller&&this._controller.fixedFeatureTarget}},{key:"_handleEdits",value:function(e){Object(M.b)(this.attributeEditingContext,e)}},{key:"attributeEditingContext",get:function(){var e=this,t=this._getObjectIdField();return{sessions:this._interactiveEditingSessions,fieldsIndex:this.layer.fieldsIndex,objectIdField:t,forEachNode:function(t){return e._nodesAddedToStage.forEach((function(e){return t(e.node,e.featureIds)}))},attributeStorageInfo:this.i3slayer.attributeStorageInfo,attributeOverrides:this._attributeOverrides,getAttributeData:function(t){return e.getAttributeData(t)},setAttributeData:function(i,r,n){e.setAttributeData(i,r);var a=e._nodesAddedToStage.get(i);if(Object(g.k)(n)){var s=e.loadedGraphics.get(n.attributes[t]);Object(g.k)(s)&&e.graphics3d.graphicsCore.recreateGraphics([s])}else Object(g.k)(a)&&e.graphics3d.graphicsCore.recreateGraphics(a.graphics)},clearMemCache:function(){}}}},{key:"performanceInfo",get:function(){var e={displayedNumberOfFeatures:this.loadedGraphics.length,maximumNumberOfFeatures:this.maximumNumberOfFeatures,totalNumberOfFeatures:-1,nodes:this._nodesAddedToStage.size,core:this.graphics3d.graphicsCore.performanceInfo};return this._controller&&this._controller.updateStats(e),e}},{key:"test",get:function(){return{controller:this._controller,numNodes:this._nodesAddedToStage.size,numFeatures:this.loadedGraphics.length}}}]),a}(Object(G.a)(Object(q.a)(Object(P.a)(K.a))));Object(p.a)([Object(O.b)()],$.prototype,"graphics3d",void 0),Object(p.a)([Object(O.b)({type:W.a})],$.prototype,"filter",void 0),Object(p.a)([Object(O.b)()],$.prototype,"loadedGraphics",void 0),Object(p.a)([Object(O.b)({aliasOf:"layer"})],$.prototype,"i3slayer",void 0),Object(p.a)([Object(O.b)()],$.prototype,"_controller",void 0),Object(p.a)([Object(O.b)()],$.prototype,"updating",void 0),Object(p.a)([Object(O.b)()],$.prototype,"suspended",void 0),Object(p.a)([Object(O.b)()],$.prototype,"holeFilling",void 0),Object(p.a)([Object(O.b)(J.a)],$.prototype,"updatingProgress",void 0),Object(p.a)([Object(O.b)({aliasOf:"_controller.updatingProgress"})],$.prototype,"updatingProgressValue",void 0),Object(p.a)([Object(O.b)(X.requiredFields)],$.prototype,"requiredFields",null),Object(p.a)([Object(O.b)(X.availableFields)],$.prototype,"availableFields",void 0),Object(p.a)([Object(O.b)()],$.prototype,"fieldsHelper",void 0),Object(p.a)([Object(O.b)({type:Number})],$.prototype,"maximumNumberOfFeatures",null),Object(p.a)([Object(O.b)({readOnly:!0})],$.prototype,"maximumNumberOfFeaturesExceeded",null),Object(p.a)([Object(O.b)({readOnly:!0,aliasOf:"view.qualitySettings.sceneService.point.lodFactor"})],$.prototype,"lodFactor",void 0),Object(p.a)([Object(O.b)({readOnly:!0})],$.prototype,"hasM",null),Object(p.a)([Object(O.b)({readOnly:!0})],$.prototype,"hasZ",null);var ee=$=Object(p.a)([Object(_.a)("esri.views.3d.layers.SceneLayerGraphicsView3D")],$);function te(e){return"pointData"in e}function ie(e){return"geometryBuffer"in e&&null!==e.geometryBuffer}function re(e){for(var t=e.attributeInfo,i=0;i<e.graphics.length;i++){var n=e.graphics[i];if(n.attributes||(n.attributes={}),Object(g.k)(t)&&Object(g.k)(t.loadedAttributes)){var a,s=Object(r.a)(t.loadedAttributes);try{for(s.s();!(a=s.n()).done;){var o=a.value.name;t.attributeData[o]&&(n.attributes[o]=Object(T.n)(t.attributeData[o],i))}}catch(u){s.e(u)}finally{s.f()}}}}function ne(e,t){return e.xmin-=t,e.ymin-=t,e.xmax+=t,e.ymax+=t,e.hasZ&&(e.zmin-=t,e.zmax+=t),e.hasM&&(e.mmin-=t,e.mmax+=t),e}var ae={2:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0]}}},3:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0,0]}}}},se=Object(x.e)(),oe={graphic:null,property:null,oldValue:null,newValue:null},ue=Object(w.l)()},925:function(e,t,i){"use strict";i.d(t,"a",(function(){return x}));var r,n=i(14),a=i(3),s=i(4),o=i(6),u=i(7),c=i(0),l=i(112),d=i(164),h=i(57),f=i(25),b=i(26),p=i(1),v=(i(18),i(17),i(16),i(9)),y=i(43),g=i(77),m=i(163),O=new h.a({esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"envelope-intersects",esriSpatialRelIndexIntersects:"index-intersects",esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:"relation"}),_=new h.a({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"}),j=r=function(e){Object(o.a)(i,e);var t=Object(u.a)(i);function i(e){var r;return Object(a.a)(this,i),(r=t.call(this,e)).where=null,r.geometry=null,r.spatialRelationship="intersects",r.hiddenIds=new Set,r.distance=void 0,r.objectIds=null,r.units=null,r.timeExtent=null,r.enabled=!1,r}return Object(s.a)(i,[{key:"writeWhere",value:function(e,t){t.where=e||"1=1"}},{key:"enable",value:function(){this._set("enabled",!0)}},{key:"createQuery",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this.where,i=this.geometry,r=this.spatialRelationship,a=this.timeExtent,s=this.objectIds,o=this.units,u=this.distance;return new m.a(Object(n.a)({geometry:Object(b.a)(i),objectIds:Object(b.a)(s),spatialRelationship:r,timeExtent:Object(b.a)(a),where:t,units:o,distance:u},e))}},{key:"clone",value:function(){var e=this.where,t=this.geometry,i=this.spatialRelationship,n=this.hiddenIds,a=this.timeExtent,s=this.objectIds,o=this.units,u=this.distance,c=new Set;return n.forEach((function(e){return c.add(e)})),new r({geometry:Object(b.a)(t),hiddenIds:c,objectIds:Object(b.a)(s),spatialRelationship:i,timeExtent:Object(b.a)(a),where:e,units:o,distance:u})}}]),i}(f.a);Object(c.a)([Object(p.b)({type:String})],j.prototype,"where",void 0),Object(c.a)([Object(y.a)("where")],j.prototype,"writeWhere",null),Object(c.a)([Object(p.b)({types:l.a,json:{read:g.a,write:!0}})],j.prototype,"geometry",void 0),Object(c.a)([Object(p.b)({type:String,json:{read:{source:"spatialRel",reader:O.read},write:{target:"spatialRel",writer:O.write}}})],j.prototype,"spatialRelationship",void 0),Object(c.a)([Object(p.b)({json:{write:function(e,t,i){return t[i]=Array.from(e)},read:function(e){return new Set(e)}}})],j.prototype,"hiddenIds",void 0),Object(c.a)([Object(p.b)({type:Number,json:{write:{overridePolicy:function(e){return{enabled:e>0}}}}})],j.prototype,"distance",void 0),Object(c.a)([Object(p.b)({type:[Number],json:{write:!0}})],j.prototype,"objectIds",void 0),Object(c.a)([Object(p.b)({type:String,json:{read:_.read,write:{writer:_.write,overridePolicy:function(e){return{enabled:e&&this.distance>0}}}}})],j.prototype,"units",void 0),Object(c.a)([Object(p.b)({type:d.a,json:{write:!0}})],j.prototype,"timeExtent",void 0),Object(c.a)([Object(p.b)({readOnly:!0})],j.prototype,"enabled",void 0);var x=j=r=Object(c.a)([Object(v.a)("esri.views.layers.support.FeatureFilter")],j)},934:function(e,t,i){"use strict";function r(e,t,i){if(!i||null==t)return null;if(!e)return function(e,t){var i=t.toLowerCase();for(var r in e)if(r.toLowerCase()===i)return e[r];return null}(t,i);var r=e.get(i);return r?t[r.name]:null}i.d(t,"a",(function(){return r}))},937:function(e,t,i){"use strict";i.d(t,"a",(function(){return j}));var r=i(8),n=i.n(r),a=i(15),s=i(3),o=i(4),u=i(6),c=i(7),l=i(0),d=(i(112),i(32)),h=i(2),f=i(1),b=(i(17),i(18),i(16),i(9)),p=i(61),v=i(966),y=i(209),g=i(163),m=i(289),O=v.a,_=function(e){Object(u.a)(i,e);var t=Object(c.a)(i);function i(e){var r;return Object(s.a)(this,i),(r=t.call(this,e))._dataQueryEngineInstance=null,r}return Object(o.a)(i,[{key:"queryGeometryType",get:function(){switch(this.layer.geometryType){case"multipoint":case"point":case"polygon":case"polyline":return this.layer.geometryType;case"mesh":return"polygon";default:return}}},{key:"defaultQueryJSON",get:function(){return new g.a({outSpatialReference:this.spatialReference}).toJSON()}},{key:"dataQueryEngine",get:function(){return this.ensureDataQueryEngine()}},{key:"destroy",value:function(){this.clear()}},{key:"clear",value:function(){return!!this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null,!0)}},{key:"executeQueryForIdSet",value:function(){var e=Object(a.a)(n.a.mark((function e(t,i){return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.dataQueryEngine.executeQueryForIdSet(this._ensureQueryJSON(t),i));case 1:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"executeQueryForCount",value:function(){var e=Object(a.a)(n.a.mark((function e(t,i){return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(t),i));case 1:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"executeQueryForExtent",value:function(){var e=Object(a.a)(n.a.mark((function e(t,i){var r,a,s;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(t),i);case 2:return r=e.sent,a=r.count,s=r.extent,e.abrupt("return",{count:a,extent:p.a.fromJSON(s)});case 6:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"executeQueryForIds",value:function(){var e=Object(a.a)(n.a.mark((function e(t,i){return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(t),i));case 1:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"executeQueryForLatestObservations",value:function(){var e=Object(a.a)(n.a.mark((function e(t,i){var r,a,s=this;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.dataQueryEngine.executeQueryForLatestObservations(this._ensureQueryJSON(t),i);case 2:return r=e.sent,a=y.default.fromJSON(r),e.abrupt("return",(a.features.forEach((function(e){e.layer=s.layer,e.sourceLayer=s.layer})),a));case 5:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"executeQuery",value:function(){var e=Object(a.a)(n.a.mark((function e(t,i){var r,a,s=this;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.dataQueryEngine.executeQuery(this._ensureQueryJSON(t),i);case 2:return r=e.sent,a=y.default.fromJSON(r),e.abrupt("return",(a.features.forEach((function(e){e.layer=s.layer,e.sourceLayer=s.layer})),a));case 5:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"_ensureQueryJSON",value:function(e){return Object(h.j)(e)?this.defaultQueryJSON:("outSpatialReference"in e&&!e.outSpatialReference&&(e.outSpatialReference=this.spatialReference),e.toJSON())}},{key:"ensureDataQueryEngine",value:function(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;var e="timeInfo"in this.layer&&this.layer.timeInfo&&this.layer.timeInfo.toJSON()||null,t=this.layer.objectIdField,i=m.a.toJSON(this.queryGeometryType),r=this.layer.fields.map((function(e){return e.toJSON()})),n=this.layerView.view.resourceController.scheduler,a=this.priority,s=this.spatialReference.toJSON(),o=this.layerView.graphics3d.graphicsCore.featureStore,u=this.layerView,c=u.hasZ,l=u.hasM;return this._dataQueryEngineInstance=new O({hasZ:c,hasM:l,geometryType:i,fields:r,timeInfo:e,spatialReference:s,objectIdField:t,featureStore:o,scheduler:n,priority:a}),this._dataQueryEngineInstance}}]),i}(d.a);Object(l.a)([Object(f.b)({constructOnly:!0})],_.prototype,"layerView",void 0),Object(l.a)([Object(f.b)({constructOnly:!0})],_.prototype,"priority",void 0),Object(l.a)([Object(f.b)({readOnly:!0,aliasOf:"layerView.view.spatialReference"})],_.prototype,"spatialReference",void 0),Object(l.a)([Object(f.b)({readOnly:!0,aliasOf:"layerView.layer"})],_.prototype,"layer",void 0),Object(l.a)([Object(f.b)({readOnly:!0})],_.prototype,"queryGeometryType",null),Object(l.a)([Object(f.b)({readOnly:!0})],_.prototype,"defaultQueryJSON",null);var j=_=Object(l.a)([Object(b.a)("esri.views.3d.layers.graphics.QueryEngine")],_)},942:function(e,t,i){"use strict";i.d(t,"a",(function(){return d})),i.d(t,"b",(function(){return c}));var r=i(8),n=i.n(r),a=i(35),s=i(15),o=i(2),u=i(81);function c(e){return l.apply(this,arguments)}function l(){return l=Object(s.a)(n.a.mark((function e(t){var i,r,s,c,l,d,h,f,b,p=arguments;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=p.length>1&&void 0!==p[1]?p[1]:t.popupTemplate,Object(o.k)(i)){e.next=3;break}return e.abrupt("return",[]);case 3:return e.next=5,i.getRequiredFields(t.fieldsIndex);case 5:if(r=e.sent,s=i.lastEditInfoEnabled,c=t.objectIdField,l=t.typeIdField,d=t.globalIdField,h=t.relationships,!r.includes("*")){e.next=13;break}return e.abrupt("return",["*"]);case 13:if(!s){e.next=19;break}return e.next=16,Object(u.n)(t);case 16:e.t0=e.sent,e.next=20;break;case 19:e.t0=[];case 20:return f=e.t0,b=Object(u.j)(t.fieldsIndex,[].concat(Object(a.a)(r),Object(a.a)(f))),e.abrupt("return",(l&&b.push(l),b&&c&&t.fieldsIndex.has(c)&&-1===b.indexOf(c)&&b.push(c),b&&d&&t.fieldsIndex.has(d)&&-1===b.indexOf(d)&&b.push(d),h&&h.forEach((function(e){var i=e.keyField;b&&i&&t.fieldsIndex.has(i)&&-1===b.indexOf(i)&&b.push(i)})),b));case 23:case"end":return e.stop()}}),e)}))),l.apply(this,arguments)}function d(e,t){return e.popupTemplate?e.popupTemplate:Object(o.k)(t)&&t.defaultPopupTemplateEnabled&&Object(o.k)(e.defaultPopupTemplate)?e.defaultPopupTemplate:null}},965:function(e,t,i){"use strict";i.d(t,"a",(function(){return y}));var r=i(3),n=i(4),a=i(6),s=i(7),o=i(0),u=i(32),c=i(55),l=i(27),d=i(1),h=(i(17),i(18),i(16),i(9)),f=i(72),b=i(708),p=i(104),v=function(e){Object(a.a)(i,e);var t=Object(s.a)(i);function i(){var e;return Object(r.a)(this,i),(e=t.apply(this,arguments)).suspended=!1,e.extent=null,e.extentIntersectionDirty=!0,e._isVisibleBelowSurface=!1,e.handles=new c.a,e.layerView=null,e.updating=!0,e}return Object(n.a)(i,[{key:"setup",value:function(e){var t=this;this.layerView=e,this.extentIntersection=new b.a({renderCoordsHelper:e.view.renderCoordsHelper});var i=e.view,r=i.basemapTerrain,n=i.resourceController.scheduler;this.handles.add([i.on("resize",(function(){return t.viewChange()})),i.state.watch("camera",(function(){return t.viewChange()}),!0),n.registerTask(p.b.FRUSTUM_VISIBILITY,this),r.on("elevation-bounds-change",(function(){return t.elevationBoundsChange()}))]),"local"===i.viewingMode?this.isVisibleBelowSurface=!0:this.handles.add([Object(l.a)(r,["opacity","wireframe"],(function(){return t.updateIsVisibleBelowSurface()})),Object(l.a)(i,"map.ground.navigationConstraint.type",(function(){return t.updateIsVisibleBelowSurface()}))])}},{key:"destroy",value:function(){this.layerView=null,this.extent=null,this.extentIntersection=null,this.handles&&(this.handles.destroy(),this.handles=null)}},{key:"_setDirty",value:function(){this.updating||this._set("updating",!0)}},{key:"setExtent",value:function(e){this.extent=e,this.extentIntersectionDirty=!0,this._setDirty()}},{key:"viewChange",value:function(){this._setDirty()}},{key:"elevationBoundsChange",value:function(){this._setDirty(),this.extentIntersectionDirty=!0}},{key:"isVisibleBelowSurface",set:function(e){this._isVisibleBelowSurface=e,this._setDirty(),this.extentIntersectionDirty=!0}},{key:"updateIsVisibleBelowSurface",value:function(){var e=this.layerView.view,t=e.basemapTerrain,i="local"===e.viewingMode,r=e.map.ground&&e.map.ground.navigationConstraint&&"none"===e.map.ground.navigationConstraint.type;this.isVisibleBelowSurface=i||!t.opaque||r}},{key:"updateExtentIntersection",value:function(){if(this.extentIntersectionDirty){this.extentIntersectionDirty=!1;var e,t=this.layerView.view;if(this._isVisibleBelowSurface)e=-.3*Object(f.e)(t.spatialReference).radius;else{var i=t.basemapTerrain.elevationBounds,r=i.min,n=i.max;e=r-Math.max(1,(n-r)*(1.2-1))}this.extentIntersection.update(this.extent,t.spatialReference,e)}}},{key:"running",get:function(){return this.updating}},{key:"runTask",value:function(){if(this._set("updating",!1),this.extent){this.updateExtentIntersection();var e=this.layerView.view.frustum,t=Object(f.e)(this.layerView.view.spatialReference).radius;this._set("suspended",!this.extentIntersection.isVisibleInFrustum(e,t))}else this._set("suspended",!1)}}]),i}(u.a);Object(o.a)([Object(d.b)({readOnly:!0})],v.prototype,"suspended",void 0),Object(o.a)([Object(d.b)({readOnly:!0})],v.prototype,"updating",void 0);var y=v=Object(o.a)([Object(h.a)("esri.views.3d.layers.graphics.Graphics3DFrustumVisibility")],v)},967:function(e,t,i){"use strict";i.d(t,"a",(function(){return u}));var r=i(3),n=i(4),a=i(203),s=function(){function e(){Object(r.a)(this,e),this.items=[]}return Object(n.a)(e,[{key:"addObject",value:function(e,t){this.items.push({type:0,objectStateId:t,object:e})}},{key:"addRenderGeometry",value:function(e,t,i){this.items.push({type:1,objectStateId:t,renderGeometry:e,owner:i})}},{key:"addExternal",value:function(e,t){this.items.push({type:2,objectStateId:t,remove:e})}},{key:"remove",value:function(e){for(var t=this.items.length-1;t>=0;--t){var i=this.items[t];i.objectStateId===e&&(this._removeObjectStateItem(i),this.items.splice(t,1))}}},{key:"removeObject",value:function(e){for(var t=this.items.length-1;t>=0;--t){var i=this.items[t];0===i.type&&i.object===e&&(this._removeObjectStateItem(i),this.items.splice(t,1))}}},{key:"removeRenderGeometry",value:function(e){for(var t=this.items.length-1;t>=0;--t){var i=this.items[t];1===i.type&&i.renderGeometry===e&&(this._removeObjectStateItem(i),this.items.splice(t,1))}}},{key:"removeAll",value:function(){var e=this;this.items.forEach((function(t){e._removeObjectStateItem(t)})),this.items=[]}},{key:"_removeObjectStateItem",value:function(e){switch(e.type){case 0:0===e.objectStateId.channel?e.object.removeHighlight(e.objectStateId):1===e.objectStateId.channel&&e.object.removeOcclude(e.objectStateId);break;case 1:e.owner.removeRenderGeometryObjectState(e.renderGeometry,e.objectStateId);break;case 2:e.remove(e.objectStateId)}}}]),e}(),o=function(){function e(t,i){Object(r.a)(this,e),this.stateType=t,this.objectIdField=i,this.objectStateSet=new s,this.ids=new Set,this.paused=!1}return Object(n.a)(e,[{key:"hasGraphic",value:function(e){if(this.objectIdField){var t=e.graphic.attributes[this.objectIdField];return this.ids.has(t)}return this.ids.has(e.graphic.uid)}}]),e}(),u=function(){function e(t){Object(r.a)(this,e),this._graphicsCore=t,this._stateSets=new Array}return Object(n.a)(e,[{key:"destroy",value:function(){this._stateSets&&this._stateSets.forEach((function(e){return e.objectStateSet.removeAll()})),this._stateSets=null}},{key:"acquireSet",value:function(e,t){var i=this,r=new o(e,t);this._stateSets.push(r);var n=Object(a.b)((function(){return i.releaseSet(r)}));return{set:r,handle:n}}},{key:"releaseSet",value:function(e){e.objectStateSet.removeAll();var t=this._stateSets?this._stateSets.indexOf(e):-1;-1!==t&&this._stateSets.splice(t,1)}},{key:"_addObjectStateSet",value:function(e,t){e.addObjectStateSet(t.stateType,t.objectStateSet)}},{key:"_removeObjectStateSet",value:function(e,t){e.removeObjectState(t.objectStateSet)}},{key:"setUid",value:function(e,t){e.ids.add(t);var i=this._graphicsCore.graphics3DGraphics.get(t);i&&this._addObjectStateSet(i,e)}},{key:"setUids",value:function(e,t){var i=this;t.forEach((function(t){return i.setUid(e,t)}))}},{key:"setObjectIds",value:function(e,t){t.forEach((function(t){return e.ids.add(t)})),this.initializeSet(e)}},{key:"addGraphic",value:function(e){var t=this;this._stateSets.forEach((function(i){!i.paused&&i.hasGraphic(e)&&t._addObjectStateSet(e,i)}))}},{key:"removeGraphic",value:function(e){var t=this;this._stateSets.forEach((function(i){i.hasGraphic(e)&&t._removeObjectStateSet(e,i)}))}},{key:"allGraphicsDeleted",value:function(){this._stateSets&&this._stateSets.forEach((function(e){return e.objectStateSet.removeAll()}))}},{key:"initializeSet",value:function(e){var t=this,i=this._graphicsCore.graphics3DGraphics;e.objectIdField?i.forEach((function(i){i&&e.hasGraphic(i)&&t._addObjectStateSet(i,e)})):e.ids.forEach((function(r){var n=i.get(r);n&&t._addObjectStateSet(n,e)}))}},{key:"test",get:function(){return{states:this._stateSets}}}]),e}()},968:function(e,t,i){"use strict";i.d(t,"a",(function(){return O}));var r=i(12),n=i(3),a=i(4),s=i(6),o=i(7),u=i(0),c=i(32),l=i(80),d=i(55),h=i(2),f=i(1),b=(i(17),i(18),i(16),i(9)),p=i(75),v=i(45),y=i(104),g=function(){function e(){Object(n.a)(this,e),this._extents=new p.a({allocator:function(e){return e||Object(v.l)()}}),this._tmpExtent=Object(v.l)(),this._dirty=!1}return Object(a.a)(e,[{key:"empty",get:function(){return 0===this._extents.length}},{key:"size",get:function(){return this._extents.length}},{key:"clear",value:function(){this._extents.clear()}},{key:"add",value:function(e){this.contains(e)||(this.removeContained(e),Object(v.k)(this._extents.pushNew(),e),this._dirty=!0)}},{key:"pop",value:function(){return this._dirty&&this.mergeTight(),this._extents.pop()}},{key:"merge",value:function(e){return this.mergeTight(e),e.hasProgressed}},{key:"mergeTight",value:function(){for(var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:y.d,i=this._extents,r=new Set,n=0;n!==i.length;){i.sort((function(e,t){return e[0]-t[0]})),n=i.length,r.clear();for(var a=function(n){if(t.done)return{v:void 0};for(var a=i.getItemAt(n),s=n+1;s<i.length;++s){var o=i.getItemAt(s);if(o[0]>=a[2])break;r.add(o)}r.forEach((function(n){if(a!==n)if(n[2]<=a[0])r.delete(n);else{var s=Object(v.d)(a),o=Object(v.d)(n),u=e._tmpExtent;Object(v.p)(a,n,u);var c=s+o;(Object(v.d)(u)-c)/c<.05&&(Object(v.k)(a,u),r.delete(n),i.remove(n),t.madeProgress())}})),r.add(a)},s=0;s<i.length;++s){var o=a(s);if("object"===typeof o)return o.v}}this._dirty=!1}},{key:"contains",value:function(e){return this._extents.some((function(t){return Object(v.g)(t,e)}))}},{key:"removeContained",value:function(e){this._extents.filterInPlace((function(t){return!Object(v.g)(e,t)}))}},{key:"test",get:function(){var e=this;return{containsPoint:function(t){return e._extents.some((function(e){return Object(v.h)(e,t)}))}}}}]),e}(),m=function(e){Object(s.a)(i,e);var t=Object(o.a)(i);function i(){var e;return Object(n.a)(this,i),(e=t.apply(this,arguments)).dirtyExtents=new g,e.globalDirty=!1,e.averageExtentUpdateSize=0,e.dirtyGraphicsSet=new Set,e.handles=new d.a,e.updateElevation=!1,e.layerView=null,e.graphicsCore=null,e.events=new l.a,e}return Object(a.a)(i,[{key:"setup",value:function(e,t,i,r){var n=this;this.layerView=e,this.queryGraphicUIDsInExtent=t,this.graphicsCore=i,this.elevationProvider=r;var a=this.layerView.view.resourceController.scheduler;this.handles.add([r.on("elevation-change",(function(e){return n._elevationChanged(e)})),this.layerView.watch("suspended",(function(){return n.suspendedChange()})),a.registerTask(y.b.ELEVATION_ALIGNMENT,this)])}},{key:"destroy",value:function(){this.dirtyGraphicsSet.clear(),this.handles.destroy(),this.handles=null,this.layerView=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null}},{key:"clear",value:function(){this.dirtyGraphicsSet.clear(),this.notifyChange("updating")}},{key:"suspendedChange",value:function(){!0===this.layerView.suspended?this.updateElevation=!1:!1===this.layerView.suspended&&this.updateElevation&&(this.globalDirty=!0,this.notifyChange("updating"))}},{key:"elevationInfoChange",value:function(){this.globalDirty=!0,this.notifyChange("updating")}},{key:"updating",get:function(){return this.running}},{key:"running",get:function(){return this.dirtyGraphicsSet.size>0||this.dirtyExtents&&!this.dirtyExtents.empty||this.globalDirty}},{key:"updatingRemaining",get:function(){return this.dirtyGraphicsSet.size+this.dirtyExtents.size*this.averageExtentUpdateSize}},{key:"runTask",value:function(e){var t=this;for(this.globalDirty&&(this.markAllGraphicsElevationDirty(),this.globalDirty=!1,e.madeProgress()),e.run((function(){return t.dirtyExtents.merge(e)}));this.running&&!e.done;)this._updateDirtyGraphics(e),this._updateDirtyExtents(e);this.layerView.view.deconflictor.setDirty(),this.notifyChange("updating")}},{key:"_updateDirtyGraphics",value:function(e){var t,i=this.layerView.view.renderCoordsHelper,n=0===this.graphicsCore.effectiveUpdatePolicy,a=Object(r.a)(this.dirtyGraphicsSet.keys());try{for(a.s();!(t=a.n()).done;){var s=t.value,o=this.graphicsCore.getGraphics3DGraphicById(s);if(this.dirtyGraphicsSet.delete(s),Object(h.k)(o)&&(o.alignWithElevation(this.elevationProvider,i,n),e.madeProgress()),e.done)return}}catch(u){a.e(u)}finally{a.f()}}},{key:"_updateDirtyExtents",value:function(e){for(var t=this;!this.dirtyExtents.empty&&!e.done;){var i=this.dirtyExtents.pop(),r=this.elevationProvider.spatialReference;this.events.emit("invalidate-elevation",{extent:i,spatialReference:r});var n=this.dirtyGraphicsSet.size;this.queryGraphicUIDsInExtent(i,r,(function(e){var i=t.graphicsCore.getGraphics3DGraphicById(e);Object(h.k)(i)&&i.needsElevationUpdates()&&t.dirtyGraphicsSet.add(e)})),this.averageExtentUpdateSize=.1*(this.dirtyGraphicsSet.size-n)+.9*this.averageExtentUpdateSize,e.madeProgress()}}},{key:"markAllGraphicsElevationDirty",value:function(){var e=this;this.dirtyExtents.clear(),this.dirtyGraphicsSet.clear(),this.graphicsCore.graphics3DGraphics.forEach((function(t,i){return e.dirtyGraphicsSet.add(i)}))}},{key:"_elevationChanged",value:function(e){if("scene"!==e.context||this.graphicsCore.layer.elevationInfo&&"relative-to-scene"===this.graphicsCore.layer.elevationInfo.mode){var t=e.extent,i=e.spatialReference;if(this.layerView.suspended){if(!this.updateElevation){var r=this.graphicsCore.computedExtent;r&&t[2]>r.xmin&&t[0]<r.xmax&&t[3]>r.ymin&&t[1]<r.ymax&&(this.updateElevation=!0)}this.events.emit("invalidate-elevation",{extent:t,spatialReference:i})}else t[0]===-1/0?this.globalDirty=!0:this.dirtyExtents.add(t),this.notifyChange("updating")}}}]),i}(c.a);Object(u.a)([Object(f.b)({readOnly:!0})],m.prototype,"updating",null),Object(u.a)([Object(f.b)({readOnly:!0})],m.prototype,"updatingRemaining",null);var O=m=Object(u.a)([Object(b.a)("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],m)},976:function(e,t,i){"use strict";i.d(t,"a",(function(){return G}));var r=i(8),n=i.n(r),a=i(15),s=i(3),o=i(4),u=i(6),c=i(7),l=i(0),d=i(119),h=i(32),f=i(162),b=i(55),p=i(23),v=i(27),y=i(1),g=(i(17),i(18),i(16)),m=i(9),O=i(687),_=i(68),j=i(163),x=i(548),k=i(988),w=i(968),C=i(2),I=i(937),S=i(925),E=i(545),N=i(104),D=g.a.getLogger("esri.views.3d.layers.graphics.Graphics3DFilterVisibility"),F=function(e){Object(u.a)(i,e);var t=Object(c.a)(i);function i(){var e;Object(s.a)(this,i);for(var r=arguments.length,n=new Array(r),a=0;a<r;a++)n[a]=arguments[a];return(e=t.call.apply(t,[this].concat(n))).filter=null,e._dirty=!1,e._querying=!1,e._handles=new b.a,e}return Object(o.a)(i,[{key:"updating",get:function(){return this._dirty||this._querying||null!=this._queryResult}},{key:"setup",value:function(e,t){var i=this;this._layerView=e,this._core=t,this._objectIdField=e.layer.objectIdField,this._queryEngine=new I.a({layerView:this._layerView,priority:N.b.FILTER_VISIBILITY});var r=this._layerView.view.resourceController.scheduler;this._handles.add(r.registerTask(N.b.FILTER_VISIBILITY,this)),this._handles.add(Object(v.b)(t.owner,"loadedGraphics","after-changes",(function(e){return i._graphicsChanged(e)}),(function(){return i.dirty=!0}))),this.filterChanged()}},{key:"destroy",value:function(){this._handles.destroy(),this._handles=null,this.clear(),this._layerView=null,this._core=null}},{key:"clear",value:function(){this._queryEngine.clear()&&(this._core.modifyGraphics3DGraphicVisibilities((function(e){return e.clearVisibilityFlag(2)})),this._queryResult=null,this._querying=!1),this.dirty=!1,this.notifyChange("updating")}},{key:"_graphicsChanged",value:function(e){this._queryEngine&&0==(1&e.type)||(this.dirty=!0)}},{key:"updateVisibility",value:function(e){this.active&&(e.hasVisibilityFlag(2,0)||e.setVisibilityFlag(2,!1,0),this.dirty=!0)}},{key:"filterChanged",value:function(){var e=this.recomputeFilter();e!==this.filter&&(this.filter=e,this.dirty=!0)}},{key:"active",get:function(){return this.filter&&this._core.graphics3DGraphics.size>0}},{key:"recomputeFilter",value:function(){var e="filter"in this._layerView?this._layerView.filter:null,t="timeExtent"in this._layerView?this._layerView.timeExtent:null,i=Object(E.b)(this._layerView);if(Object(C.j)(t)&&Object(C.j)(i))return e;var r=Object(C.k)(e)?e.clone():new S.a;if(Object(C.k)(t)&&(r.timeExtent=Object(C.k)(r.timeExtent)?r.timeExtent.intersection(t):t),Object(C.k)(i)){var n=null==r.where||""===r.where;r.where=n?i:"(".concat(r.where,") AND (").concat(i,")")}return r}},{key:"running",get:function(){return this._dirty&&!this._querying||null!=this._queryResult}},{key:"runTask",value:function(e){var t=this;this.active?(!this._dirty||this._querying||e.done||(this._querying=!0,this.dirty=!1,this._queryEngine.executeQueryForIdSet(this.filter).then((function(e){t._queryResult=e,t._querying=!1})).catch((function(e){Object(p.n)(e)||(D.warn("FeatureFilter query failed: "+e,{error:e}),t._queryResult=new Set,t._core.graphics3DGraphics.forEach((function(e){return t._queryResult.add(t._getFeatureId(e.graphic))})),t._querying=!1)})),e.madeProgress()),this._queryResult&&!e.done&&(this._core.modifyGraphics3DGraphicVisibilities((function(i){if(e.done)return!1;var r=t._queryResult.has(t._getFeatureId(i.graphic));return!!i.setVisibilityFlag(2,r,0)&&(e.madeProgress(),!0)})),e.done||(this._queryResult=null)),this.notifyChange("updating")):this.clear()}},{key:"_getFeatureId",value:function(e){return null==e.objectId?e.attributes[this._objectIdField]:e.objectId}},{key:"dirty",set:function(e){this._dirty!==e&&(this._dirty=e,this.notifyChange("updating"))}}]),i}(h.a);Object(l.a)([Object(y.b)({readOnly:!0})],F.prototype,"updating",null),F=Object(l.a)([Object(m.a)("esri.views.3d.layers.graphics.Graphics3DFilterVisibility")],F);var V=i(965),P=i(967),A=i(984),L=i(117),M=i(934),R=i(287),T=function(e){Object(u.a)(i,e);var t=Object(c.a)(i);function i(e){var r;return Object(s.a)(this,i),(r=t.call(this,e))._handles=new b.a,r.watchUpdatingTracking=new R.a,r.suspendResumeExtentMode="computed",r.dataExtent=null,r.suspendResumeExtent=null,r}return Object(o.a)(i,[{key:"suspended",get:function(){var e;return null==(e=this.scaleVisibility)?void 0:e.suspended}},{key:"suspendInfo",get:function(){var e,t,i={};return null!=(e=this.scaleVisibility)&&e.suspended&&(i.outsideScaleRange=!0),null!=(t=this.frustumVisibility)&&t.suspended&&(i.outsideOfView=!0),i}},{key:"updating",get:function(){var e,t,i;return!!(null!=(e=this.graphicsCore)&&e.updating||null!=(t=this.frustumVisibility)&&t.updating||null!=(i=this.watchUpdatingTracking)&&i.updating)}},{key:"normalizeCtorArgs",value:function(e){var t=e.frustumVisibilityEnabled?new V.a:null,i=e.scaleVisibilityEnabled?new A.a:null,r=(e.filterVisibilityEnabled||e.timeExtentVisibilityEnabled)&&"multipatch"!==e.layer.geometryType?new F:null,n=e.elevationAlignmentEnabled?new w.a:null;return{graphicsCore:new k.a({owner:e.owner,layer:e.layer,preferredUpdatePolicy:e.preferredUpdatePolicy,elevationFeatureExpressionEnabled:e.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1,hasZ:e.owner.hasZ,hasM:e.owner.hasM}),frustumVisibility:t,scaleVisibility:i,filterVisibility:r,elevationAlignment:n,updateClippingExtent:e.updateClippingExtent,suspendResumeExtentMode:e.suspendResumeExtentMode,dataExtent:e.dataExtent}}},{key:"initialize",value:function(){var e=this;this.scaleVisibility&&this.watchUpdatingTracking.add(this.layer,"scaleRangeId",(function(){return e.scaleVisibility.layerMinMaxScaleChangeHandler()})),this.filterVisibility&&(this.watchUpdatingTracking.add(this.owner,"filter",(function(){return e.filterVisibility.filterChanged()})),this.watchUpdatingTracking.add(this.owner,"timeExtent",(function(){return e.filterVisibility.filterChanged()}))),this.elevationAlignment&&this.watchUpdatingTracking.add(this.layer,"elevationInfo",(function(t,i){Object(O.a)(t,i)&&e.watchUpdatingTracking.addPromise(e.graphicsCore.elevationInfoChange())})),this.watchUpdatingTracking.add(this.layer,"labelsVisible",(function(){return e.graphicsCore.updateVisibilityInfo()})),this.watchUpdatingTracking.add(this.layer,"labelingInfo",(function(t,i){Object(O.a)(t,i)&&e.graphicsCore.updateLabelingInfo()}))}},{key:"setup",value:function(){var e=Object(a.a)(n.a.mark((function e(){var t,i,r,a,s=this;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.frustumVisibility&&this.frustumVisibility.setup(this.owner),t=this.owner,i=this.owner.view.basemapTerrain,r=function(e,t,i){return s.graphicsCore.spatialIndex.queryGraphicUIDsInExtent(e,t,i)},this.scaleVisibility&&this.scaleVisibility.setup(t,this.layer,r,this.graphicsCore,i),this.filterVisibility&&("filter"in t||"timeExtent"in t)&&this.filterVisibility.setup(t,this.graphicsCore),this.elevationAlignment&&(a=t.view.elevationProvider,this.elevationAlignment.setup(t,r,this.graphicsCore,a)),this._set("objectStates",new P.a(this.graphicsCore)),this._set("labeling",this.owner.view.labeler.addGraphicsOwner(this.graphicsCore,this.scaleVisibility)),this._set("deconfliction",t.view.deconflictor.addGraphicsOwner(this.graphicsCore)),e.next=8,Object(p.r)(this.graphicsCore.setup({elevationAlignment:this.elevationAlignment,scaleVisibility:this.scaleVisibility,filterVisibility:this.filterVisibility,deconflictor:this.deconfliction,labeler:this.labeling,objectStates:this.objectStates}));case 8:if(this.watchUpdatingTracking.add(this.layer,"renderer",(function(e){return s.watchUpdatingTracking.addPromise(s.graphicsCore.rendererChange(e))})),this.watchUpdatingTracking.add(t,"fullOpacity",(function(){return s.graphicsCore.opacityChange()})),this.setupSuspendResumeExtent(),this.updateClippingExtent&&(this.watchUpdatingTracking.add(t.view,"clippingArea",(function(){return s._updateClippingExtent()})),this._updateClippingExtent()),this.graphicsCore.startCreateGraphics(),e.t0=this.graphicsCore.labelsEnabled,!e.t0){e.next=17;break}return e.next=17,Object(p.r)(this.graphicsCore.updateLabelingInfo());case 17:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"destroy",value:function(){this._handles&&(this._handles.destroy(),this._handles=null);for(var e=0,t=["watchUpdatingTracking","frustumVisibility","scaleVisibility","filterVisibility","elevationAlignment","objectStates","graphicsCore"];e<t.length;e++){var i=t[e],r=this[i];r&&(r.destroy(),this._set(i,null))}this._set("layer",null),this._set("owner",null)}},{key:"maskOccludee",value:function(e){var t=this.objectStates.acquireSet(1,null),i=t.set,r=t.handle;return this.objectStates.setUid(i,e.uid),r}},{key:"highlight",value:function(e,t){var i=this;if(e instanceof j.a){var r=this.objectStates.acquireSet(0,t),n=r.set,a=r.handle;return this.owner.queryObjectIds(e).then((function(e){return i.objectStates.setObjectIds(n,e)})),a}if("number"==typeof e||"string"==typeof e)return this.highlight([e],t);if(e instanceof d.a)return this.highlight([e],t);if("toArray"in e&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof d.a){var s=e;if(null==Object(M.a)(this.layer.fieldsIndex,s[0].attributes,t)){var o=s.map((function(e){return e.uid})),u=this.objectStates.acquireSet(0,null),c=u.set,l=u.handle;return this.objectStates.setUids(c,o),l}e=s.map((function(e){return Object(M.a)(i.layer.fieldsIndex,e.attributes,t)}))}if("number"==typeof e[0]||"string"==typeof e[0]){var h=e,f=this.objectStates.acquireSet(0,t),b=f.set,p=f.handle;return this.objectStates.setObjectIds(b,h),p}}return q}},{key:"_updateClippingExtent",value:function(){var e=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(e,this.owner.view.spatialReference)&&(this.updateClippingExtent(e)||this.graphicsCore.recreateAllGraphics())}},{key:"setupSuspendResumeExtent",value:function(){var e=this;(this.frustumVisibility||this.scaleVisibility)&&this._handles.add(Object(v.a)(this,"suspendResumeExtentMode",(function(){switch(e._handles.remove(U),e.suspendResumeExtentMode){case"computed":e._handles.add([Object(v.a)(e.graphicsCore,"computedExtent",(function(t){return e.updateSuspendResumeExtent(t)})),e.graphicsCore.watch("extentPadding",(function(){return e.updateSuspendResumeExtent(e.graphicsCore.computedExtent)}))],U);break;case"data":e._handles.add([Object(v.a)(e,"dataExtent",(function(t){return e.updateSuspendResumeExtent(t)})),e.graphicsCore.watch("extentPadding",(function(){return e.updateSuspendResumeExtent(e.dataExtent)}))],U);break;default:Object(f.a)(e.suspendResumeExtentMode)}})))}},{key:"updateSuspendResumeExtent",value:function(e){e?this.suspendResumeExtentChanged(this.extentToSuspendResumeRect(e,this.suspendResumeExtent)):this.suspendResumeExtentChanged(null)}},{key:"extentToSuspendResumeRect",value:function(e,t){var i=this.owner.view.spatialReference;if(!e.spatialReference.equals(i)){if(!Object(_.a)(e,i))return;e=Object(_.d)(e,i)}return Object(L.e)(e,t,x.a,this.graphicsCore.extentPadding)}},{key:"suspendResumeExtentChanged",value:function(e){this.frustumVisibility&&this.frustumVisibility.setExtent(e),this.scaleVisibility&&this.scaleVisibility.setExtent(e)}}]),i}(h.a);Object(l.a)([Object(y.b)({aliasOf:"graphicsCore.layer"})],T.prototype,"layer",void 0),Object(l.a)([Object(y.b)({aliasOf:"graphicsCore.owner"})],T.prototype,"owner",void 0),Object(l.a)([Object(y.b)({constructOnly:!0})],T.prototype,"updateClippingExtent",void 0),Object(l.a)([Object(y.b)({constructOnly:!0})],T.prototype,"graphicsCore",void 0),Object(l.a)([Object(y.b)({constructOnly:!0})],T.prototype,"scaleVisibility",void 0),Object(l.a)([Object(y.b)({constructOnly:!0})],T.prototype,"filterVisibility",void 0),Object(l.a)([Object(y.b)({constructOnly:!0})],T.prototype,"elevationAlignment",void 0),Object(l.a)([Object(y.b)({constructOnly:!0})],T.prototype,"frustumVisibility",void 0),Object(l.a)([Object(y.b)({readOnly:!0})],T.prototype,"deconfliction",void 0),Object(l.a)([Object(y.b)({readOnly:!0})],T.prototype,"labeling",void 0),Object(l.a)([Object(y.b)({readOnly:!0})],T.prototype,"objectStates",void 0),Object(l.a)([Object(y.b)({readOnly:!0})],T.prototype,"watchUpdatingTracking",void 0),Object(l.a)([Object(y.b)()],T.prototype,"suspendResumeExtentMode",void 0),Object(l.a)([Object(y.b)()],T.prototype,"dataExtent",void 0),Object(l.a)([Object(y.b)({readOnly:!0})],T.prototype,"suspended",null),Object(l.a)([Object(y.b)({readOnly:!0})],T.prototype,"suspendInfo",null),Object(l.a)([Object(y.b)({readOnly:!0,dependsOn:["graphicsCore.updating","frustumVisibility.updating","watchUpdatingTracking.updating"]})],T.prototype,"updating",null);var G=T=Object(l.a)([Object(m.a)("esri.views.3d.layers.graphics.Graphics3DFeatureLikeLayerView")],T),U="suspendResumeExtentMode",q={remove:function(){},pause:function(){},resume:function(){}}},998:function(e,t,i){"use strict";i.d(t,"a",(function(){return k})),i.d(t,"b",(function(){return _})),i.d(t,"c",(function(){return p})),i.d(t,"d",(function(){return m})),i.d(t,"e",(function(){return w})),i.d(t,"f",(function(){return C}));var r=i(21),n=i(17),a=i(24),s=i(2),o=i(3),u=i(4),c=function(){function e(t,i){var r=this;Object(o.a)(this,e),this._textureRep=t,this._textureId=i,this._textureRef=Object(s.c)(this._textureId,(function(e){return r._textureRep.acquire(e)}))}return Object(u.a)(e,[{key:"dispose",value:function(){var e=this;this._textureRef=Object(s.c)(this._textureId,(function(t){e._textureRep.release(t)}))}},{key:"bind",value:function(e,t,i){if(Object(s.k)(this._textureRef)){var r=this._textureRef.glTexture;e.bindTexture(r,t),e.setUniform2f(i,r.descriptor.width,r.descriptor.height)}}}]),e}(),l=i(331),d=i(125),h=i(59);var f,b=i(237);function p(e,t){var i=new Map,r=function(e,t){if(Object(s.j)(e))return-1;if(i.has(e.id)){var r=i.get(e.id);return r.usage|=t,r.id}var n=i.size;return i.set(e.id,{id:n,usage:t}),n},n=t.pbrMetallicRoughness,a=n&&n.baseColorFactor,o=t.emissiveFactor,u=null==t.normalTexture&&null==t.emissiveTexture&&null==t.occlusionTexture&&(!n||null==n.metallicRoughnessTexture&&1===n.roughnessFactor&&(1===n.metallicFactor||0===n.metallicFactor)),c=u?l.a[0]:n?n.metallicFactor:1,d=u?l.a[1]:n?n.roughnessFactor:1,h="mask"===t.alphaMode?33:1,f={baseColorFactor:a?[a[0],a[1],a[2],a[3]]:[1,1,1,1],baseColorTextureId:r(n&&n.baseColorTexture,h),metallicRoughnessTextureId:r(n&&n.metallicRoughnessTexture,2),metallicFactor:c,roughnessFactor:d},b={alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,cullFace:"none"===t.cullFace?0:"back"===t.cullFace?2:"front"===t.cullFace?1:void 0,normalTextureId:r(t.normalTexture,4),emissiveTextureId:r(t.emissiveTexture,16),occlusionTextureId:r(t.occlusionTexture,8),emissiveFactor:o?[o[0],o[1],o[2]]:[0,0,0],metallicRoughness:f,wrapTextures:!1,hasParametersFromSource:u},p=[];return i.forEach((function(t,i){var r=t.usage,n=Object(s.k)(e)&&e[i]&&e[i].formats,a=n?v(n.map((function(e){var t=e.name,i=e.format;return{name:t,encoding:y[i]}}))):[];p.push({id:i,usage:r,encodings:a})})),{material:b,textures:p}}function v(e){return e.sort((function(e,t){return e.encoding-t.encoding}))}var y={ktx2:1,basis:2,dds:4,png:8,jpg:16,"ktx-etc2":32},g=(f={},Object(r.a)(f,b.a.KTX2_ENCODING,2),Object(r.a)(f,b.a.BASIS_ENCODING,2),Object(r.a)(f,b.a.DDS_ENCODING,4),Object(r.a)(f,"image/png",8),Object(r.a)(f,"image/jpg",16),Object(r.a)(f,"image/jpeg",16),Object(r.a)(f,"image/ktx",32),f);function m(e){var t=e&&e.materialDefinitions?Object.keys(e.materialDefinitions)[0]:null,i=e&&e.textureDefinitions?Object.keys(e.textureDefinitions)[0]:null,r=t&&e.materialDefinitions[t],n=i&&e.textureDefinitions[i],s=O();if(null!=r){var o=r.params;o.diffuse&&(s.metallicRoughness.baseColorFactor=[o.diffuse[0],o.diffuse[1],o.diffuse[2],1]),null!=o.doubleSided&&(s.doubleSided=o.doubleSided,s.cullFace=o.doubleSided?0:2),"none"!==o.cullFace&&"front"!==o.cullFace&&"back"!==o.cullFace||(s.cullFace="none"===o.cullFace?0:"back"===o.cullFace?2:1),o.transparency&&(s.metallicRoughness.baseColorFactor[3]=Object(a.f)(1-o.transparency,0,1)),(o.useVertexColorAlpha||s.metallicRoughness.baseColorFactor[3]<1)&&(s.alphaMode="blend")}var u=[];if(null!=n){!n.wrap||"repeat"!==n.wrap[0]&&"repeat"!==n.wrap[1]||(s.wrapTextures=!0);var c=1;"rgba"===n.channels&&(s.alphaMode="blend",c|=32);var l=n.images.length-1,d=n.images[l],h=function(e){return e&&e.split("/").pop()},f=Array.isArray(n.encoding)?v(n.encoding.map((function(e,t){return{name:h(d.href[t]),encoding:g[e]||0}}))):[{name:h(d.href),encoding:g[n.encoding]||0}];u.push({id:0,usage:c,encodings:f}),s.metallicRoughness.baseColorTextureId=0}return{material:s,textures:u}}var O=function(){return{alphaMode:"opaque",alphaCutoff:d.b,doubleSided:!0,cullFace:0,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[.8,.8,.8,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6},wrapTextures:!1,hasParametersFromSource:!0}};function _(e,t,i,r){if(Object(s.j)(e)||null==e.data)return null;var n=e.data,o=!(n instanceof HTMLImageElement)||Object(a.l)(n.width)&&Object(a.l)(n.height),u=r.renderingContext.parameters.maxMaxAnisotropy,c=i&&!r.capabilities.shaderTextureLOD?1:u,l=o&&!e.downsampled&&c>1,d=i||!t.wrapTextures?j:x,h=function(e){switch(e){case 1:return b.a.KTX2_ENCODING;case 2:return b.a.BASIS_ENCODING;case 4:return b.a.DDS_ENCODING;case 8:return"image/png";case 16:return"image/jpeg";case 32:return"image/ktx";default:return""}}(e.encoding),f=1&e.usage?"opaque"===t.alphaMode?3:4:3;return new b.a(n,{mipmap:l,maxAnisotropy:c,encoding:h,wrap:d,components:f,noUnpackFlip:!0})}var j={s:33071,t:33071},x={s:10497,t:10497};function k(e,t,i,r,n,o){var u=o.rendererTextureUsage,l=function(e){return function(e,t,i){if(Object(s.j)(e)||0===i)return null;for(var r=0;r<e.length;r++){var n=e[r];if(Object(s.k)(n)&&0!=(n.usage&i))return t[r].id}return null}(r,i,e&u)},f=t.metallicRoughness.baseColorFactor,b=Object(a.f)(t.metallicRoughness.baseColorFactor[3],0,1);e.baseColor=[f[0],f[1],f[2],b],e.hasParametersFromSource=!!t.hasParametersFromSource,e.usePBR=o.usePBR,e.mrrFactors=[t.metallicRoughness.metallicFactor,t.metallicRoughness.roughnessFactor,t.hasParametersFromSource?.2:.5],e.emissiveFactor=t.emissiveFactor,e.isIntegratedMesh=o.isIntegratedMesh,e.alphaCutoff="mask"===t.alphaMode?t.alphaCutoff:d.b,e.alphaDiscardMode="opaque"===t.alphaMode?1:"mask"===t.alphaMode?2:3;var p=l(33);p&&(e.baseColorTexture=new c(n,p));var v=l(2);v&&(e.metallicRoughnessTexture=new c(n,v));var y=l(16);y&&(e.emissionTexture=new c(n,y));var g=l(8);g&&(e.occlusionTexture=new c(n,g));var m=l(4);m&&(e.normalTexture=new c(n,m)),e.commonMaterialParameters.slicePlaneEnabled=o.slicePlaneEnabled,e.commonMaterialParameters.doubleSided=t.doubleSided,e.commonMaterialParameters.cullFace=t.cullFace,e.ellipsoidMode=function(e){return e&&Object(h.i)(e)?2:e&&Object(h.j)(e)?3:1}(o.viewSpatialReference)}function w(e){var t=!!e.compressedTextureS3TC,i=!!e.compressedTextureETC,r=Object(n.a)("disable-feature:i3s-basis")?0:3;return 24|(t?4|r:0)|(i?r:0)}function C(e,t){return e.find((function(e){return 0!=(e.encoding&t)}))}}}]);
//# sourceMappingURL=65.60d22b00.chunk.js.map